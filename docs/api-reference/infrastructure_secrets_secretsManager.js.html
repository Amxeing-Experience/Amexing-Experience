<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: infrastructure/secrets/secretsManager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: infrastructure/secrets/secretsManager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Secrets Manager - Secure handling of environment variables and secrets.
 * Provides encryption, decryption, and secure access to sensitive configuration.
 */

const crypto = require('crypto');
const fs = require('fs');

/**
 * SecureSecretsManager class for handling encrypted environment variables.
 */
class SecureSecretsManager {
  constructor() {
    this.encryptedSecrets = new Map();
    this.loadedSecrets = new Set();
    this.algorithm = 'aes-256-gcm';
    this.keyLength = 32;
  }

  /**
   * Initialize the secrets manager with encryption key.
   * @param {string} encryptionKey - Base64 encoded encryption key.
   * @example
   * // const instance = new ModelName(data);
   * // const result = await instance.save();
   * const manager = new SecureSecretsManager();
   * manager.initialize(process.env.ENCRYPTION_KEY);
   */
  initialize(encryptionKey) {
    if (!encryptionKey) {
      throw new Error('Encryption key is required for secrets manager');
    }

    try {
      this.encryptionKey = Buffer.from(encryptionKey, 'base64');
      if (this.encryptionKey.length !== this.keyLength) {
        throw new Error(
          `Encryption key must be ${this.keyLength} bytes when decoded`
        );
      }
    } catch (error) {
      throw new Error(`Invalid encryption key format: ${error.message}`);
    }
  }

  /**
   * Encrypt a secret value.
   * @param {string} value - Plain text value to encrypt.
   * @returns {string} Encrypted value with IV and auth tag.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   * const encrypted = manager.encryptSecret('my-secret-value');
   */
  encryptSecret(value) {
    if (!this.encryptionKey) {
      throw new Error('Secrets manager not initialized');
    }

    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(
      this.algorithm,
      this.encryptionKey,
      iv
    );
    cipher.setAAD(Buffer.from('secrets-manager'));

    let encrypted = cipher.update(value, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    const authTag = cipher.getAuthTag();

    return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
  }

  /**
   * Decrypt a secret value.
   * @param {string} encryptedValue - Encrypted value with IV and auth tag.
   * @returns {string} Decrypted plain text value.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   * const decrypted = manager.decryptSecret(encryptedValue);
   */
  decryptSecret(encryptedValue) {
    if (!this.encryptionKey) {
      throw new Error('Secrets manager not initialized');
    }

    try {
      const [ivHex, authTagHex, encrypted] = encryptedValue.split(':');

      if (!ivHex || !authTagHex || !encrypted) {
        throw new Error('Invalid encrypted value format');
      }

      const iv = Buffer.from(ivHex, 'hex');
      const authTag = Buffer.from(authTagHex, 'hex');

      const decipher = crypto.createDecipheriv(
        this.algorithm,
        this.encryptionKey,
        iv
      );
      decipher.setAAD(Buffer.from('secrets-manager'));
      decipher.setAuthTag(authTag);

      let decrypted = decipher.update(encrypted, 'hex', 'utf8');
      decrypted += decipher.final('utf8');

      return decrypted;
    } catch (error) {
      throw new Error(`Failed to decrypt secret: ${error.message}`);
    }
  }

  /**
   * Load and decrypt secrets from encrypted environment file.
   * @param {string} filePath - Path to encrypted secrets file.
   * @returns {object} Decrypted environment variables.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   * const secrets = manager.loadEncryptedEnv('.env.vault');
   */
  loadEncryptedEnv(filePath) {
    try {
      // eslint-disable-next-line security/detect-non-literal-fs-filename
      const encryptedContent = fs.readFileSync(filePath, 'utf8');
      const secrets = {};

      encryptedContent.split('\n').forEach((line) => {
        const trimmedLine = line.trim();
        if (trimmedLine &amp;&amp; !trimmedLine.startsWith('#')) {
          const [key, encryptedValue] = trimmedLine.split('=', 2);
          if (key &amp;&amp; encryptedValue) {
            secrets[key.trim()] = this.decryptSecret(encryptedValue.trim());
            this.loadedSecrets.add(key.trim());
          }
        }
      });

      return secrets;
    } catch (error) {
      throw new Error(`Failed to load encrypted environment: ${error.message}`);
    }
  }

  /**
   * Save encrypted secrets to file.
   * @param {object} secrets - Plain text secrets to encrypt and save.
   * @param {string} filePath - Path to save encrypted secrets.
   * @example
   * // Example usage:
   * // const result = await methodName(params);
   * // Returns appropriate result based on operation
   * manager.saveEncryptedEnv(secrets, '.env.vault');
   */
  saveEncryptedEnv(secrets, filePath) {
    try {
      const lines = [];
      lines.push('# Encrypted Environment Variables');
      lines.push('# Generated by SecureSecretsManager');
      lines.push(`# Created: ${new Date().toISOString()}`);
      lines.push('');

      Object.entries(secrets).forEach(([key, value]) => {
        if (typeof key === 'string' &amp;&amp; typeof value === 'string') {
          const encryptedValue = this.encryptSecret(value);
          lines.push(`${key}=${encryptedValue}`);
        }
      });

      // eslint-disable-next-line security/detect-non-literal-fs-filename
      fs.writeFileSync(filePath, lines.join('\n'), 'utf8');
    } catch (error) {
      throw new Error(`Failed to save encrypted environment: ${error.message}`);
    }
  }

  /**
   * Securely get a secret value, clearing it from memory after access.
   * @param {string} key - Secret key name.
   * @param {object} secrets - Secrets object.
   * @returns {string} Secret value.
   * @example
   * // const isValid = validator.validate(data);
   * // Returns: boolean or validation result object
   * const secret = manager.getSecureValue('DATABASE_PASSWORD', secrets);
   */
  getSecureValue(key, secrets) {
    // Validate key to prevent object injection
    if (
      typeof key !== 'string'
      || key.includes('__proto__')
      || key.includes('constructor')
      || key.includes('prototype')
    ) {
      return undefined;
    }

    // eslint-disable-next-line security/detect-object-injection
    const value = secrets[key];
    if (value) {
      // Mark as accessed for audit purposes
      this.encryptedSecrets.set(key, {
        accessed: new Date(),
        accessCount: (this.encryptedSecrets.get(key)?.accessCount || 0) + 1,
      });
    }
    return value;
  }

  /**
   * Clear secrets from memory for security.
   * @param {object} secretsObj - Secrets object to clear.
   * @returns {object} Cleared secrets object.
   * @example
   * // Example usage:
   * // const result = await methodName(params);
   * // Returns appropriate result based on operation
   * const cleared = manager.clearSecrets(secrets);
   */
  clearSecrets(secretsObj) {
    const secretsCopy = { ...secretsObj };
    Object.keys(secretsCopy).forEach((key) => {
      // Validate key to prevent object injection
      if (
        typeof key === 'string'
        &amp;&amp; !key.includes('__proto__')
        &amp;&amp; !key.includes('constructor')
        &amp;&amp; !key.includes('prototype')
      ) {
        // eslint-disable-next-line security/detect-object-injection
        secretsCopy[key] = null;
        // eslint-disable-next-line security/detect-object-injection
        delete secretsCopy[key];
      }
    });
    return secretsCopy;
  }

  /**
   * Generate a secure random secret.
   * @param {number} length - Length of secret to generate.
   * @param {object} options - Generation options.
   * @returns {string} Generated secret.
   * @example
   * // Example usage:
   * // const result = await methodName(params);
   * // Returns appropriate result based on operation
   * const secret = manager.generateSecret(32, { encoding: 'base64' });
   */
  generateSecret(length = 32, options = {}) {
    const { encoding = 'base64', charset = 'alphanumeric' } = options;

    if (charset === 'alphanumeric') {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i &lt; length; i += 1) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    const bytes = crypto.randomBytes(length);
    return encoding === 'hex'
      ? bytes.toString('hex')
      : bytes.toString('base64');
  }

  /**
   * Generate an encryption key for the secrets manager.
   * @returns {string} Base64 encoded encryption key.
   * @example
   * // Example usage:
   * // const result = await methodName(params);
   * // Returns appropriate result based on operation
   * const key = SecureSecretsManager.generateEncryptionKey();
   */
  static generateEncryptionKey() {
    return crypto.randomBytes(32).toString('base64');
  }

  /**
   * Validate environment variables against required schema.
   * @param {object} secrets - Secrets to validate.
   * @param {object} schema - Required environment schema.
   * @returns {object} Validation result.
   * @example
   * // const isValid = validator.validate(data);
   * // Returns: boolean or validation result object
   * const result = manager.validateSecrets(secrets, requiredSchema);
   */
  validateSecrets(secrets, schema) {
    const missing = [];
    const invalid = [];

    // eslint-disable-next-line complexity
    Object.entries(schema).forEach(([key, requirements]) => {
      // Validate key to prevent object injection
      if (
        typeof key !== 'string'
        || key.includes('__proto__')
        || key.includes('constructor')
        || key.includes('prototype')
      ) {
        return;
      }
      // eslint-disable-next-line security/detect-object-injection
      const value = secrets[key];

      if (!value) {
        missing.push(key);
        return;
      }

      if (requirements.minLength &amp;&amp; value.length &lt; requirements.minLength) {
        invalid.push(`${key}: minimum length ${requirements.minLength}`);
      }

      if (requirements.pattern &amp;&amp; !requirements.pattern.test(value)) {
        invalid.push(`${key}: does not match required pattern`);
      }
    });

    return {
      valid: missing.length === 0 &amp;&amp; invalid.length === 0,
      missing,
      invalid,
    };
  }

  /**
   * Get audit information about secret access.
   * @returns {object} Audit information.
   * @example
   * // Example usage:
   * // const result = await methodName(params);
   * // Returns appropriate result based on operation
   * const audit = manager.getAuditInfo();
   */
  getAuditInfo() {
    const audit = {
      loadedSecrets: Array.from(this.loadedSecrets),
      accessedSecrets: {},
      timestamp: new Date().toISOString(),
    };

    this.encryptedSecrets.forEach((info, key) => {
      // Validate key to prevent object injection
      if (
        typeof key === 'string'
        &amp;&amp; !key.includes('__proto__')
        &amp;&amp; !key.includes('constructor')
        &amp;&amp; !key.includes('prototype')
      ) {
        // eslint-disable-next-line security/detect-object-injection
        audit.accessedSecrets[key] = info;
      }
    });

    return audit;
  }
}

// Singleton instance
let instance = null;

/**
 * Get the singleton secrets manager instance.
 * @returns {SecureSecretsManager} Secrets manager instance.
 * @example
   * // Example usage:
   * // const result = await methodName(params);
   * // Returns appropriate result based on operation
 * const manager = getSecretsManager();
 */
function getSecretsManager() {
  if (!instance) {
    instance = new SecureSecretsManager();
  }
  return instance;
}

module.exports = {
  SecureSecretsManager,
  getSecretsManager,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdminController.html">AdminController</a></li><li><a href="AmexingAuthMiddleware.html">AmexingAuthMiddleware</a></li><li><a href="AmexingAuthService.html">AmexingAuthService</a></li><li><a href="AmexingUser.html">AmexingUser</a></li><li><a href="ApiController.html">ApiController</a></li><li><a href="AppleIdTokenValidator.html">AppleIdTokenValidator</a></li><li><a href="AppleOAuthService.html">AppleOAuthService</a></li><li><a href="AppleOAuthServiceCore.html">AppleOAuthServiceCore</a></li><li><a href="AppleSignInButton.html">AppleSignInButton</a></li><li><a href="AppleTokenExchanger.html">AppleTokenExchanger</a></li><li><a href="AuthController.html">AuthController</a></li><li><a href="AuthMiddleware.html">AuthMiddleware</a></li><li><a href="AuthenticationService.html">AuthenticationService</a></li><li><a href="AuthenticationServiceCore.html">AuthenticationServiceCore</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="Client.html">Client</a></li><li><a href="ClientController.html">ClientController</a></li><li><a href="CorporateOAuthInterface.html">CorporateOAuthInterface</a></li><li><a href="CorporateOAuthService.html">CorporateOAuthService</a></li><li><a href="CorporateSyncService.html">CorporateSyncService</a></li><li><a href="DashboardAuthMiddleware.html">DashboardAuthMiddleware</a></li><li><a href="DashboardController.html">DashboardController</a></li><li><a href="Department.html">Department</a></li><li><a href="DepartmentManagerController.html">DepartmentManagerController</a></li><li><a href="DepartmentOAuthFlowService.html">DepartmentOAuthFlowService</a></li><li><a href="DriverController.html">DriverController</a></li><li><a href="EmployeeController.html">EmployeeController</a></li><li><a href="GuestController.html">GuestController</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="IntelligentProviderSelector.html">IntelligentProviderSelector</a></li><li><a href="MobileOAuthOptimizer.html">MobileOAuthOptimizer</a></li><li><a href="NotificationsController.html">NotificationsController</a></li><li><a href="OAuthPermissionService.html">OAuthPermissionService</a></li><li><a href="OAuthProvider.html">OAuthProvider</a></li><li><a href="OAuthSecurityValidator.html">OAuthSecurityValidator</a></li><li><a href="OAuthService.html">OAuthService</a></li><li><a href="PermissionAuditService.html">PermissionAuditService</a></li><li><a href="PermissionContextService.html">PermissionContextService</a></li><li><a href="PermissionDelegationService.html">PermissionDelegationService</a></li><li><a href="PermissionInheritanceService.html">PermissionInheritanceService</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RoleBasedController.html">RoleBasedController</a></li><li><a href="SecureSecretsManager.html">SecureSecretsManager</a></li><li><a href="SecurityMiddleware.html">SecurityMiddleware</a></li><li><a href="SuperAdminController.html">SuperAdminController</a></li><li><a href="UserManagementController.html">UserManagementController</a></li><li><a href="global.html#UserManagementService">UserManagementService</a></li><li><a href="ValidationMiddleware.html">ValidationMiddleware</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BaseModel">BaseModel</a></li><li><a href="global.html#Parse">Parse</a></li><li><a href="global.html#about">about</a></li><li><a href="global.html#addCorporateDomain">addCorporateDomain</a></li><li><a href="global.html#authRateLimit">authRateLimit</a></li><li><a href="global.html#authenticateOptional">authenticateOptional</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#autoRefreshToken">autoRefreshToken</a></li><li><a href="global.html#checkUserPermission">checkUserPermission</a></li><li><a href="global.html#createEmergencyElevation">createEmergencyElevation</a></li><li><a href="global.html#createPermissionDelegation">createPermissionDelegation</a></li><li><a href="global.html#createPermissionOverride">createPermissionOverride</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#expressRateLimit">expressRateLimit</a></li><li><a href="global.html#extractUser">extractUser</a></li><li><a href="global.html#findUserById">findUserById</a></li><li><a href="global.html#generateCorporateOAuthURL">generateCorporateOAuthURL</a></li><li><a href="global.html#generateTokens">generateTokens</a></li><li><a href="global.html#getActiveDelegations">getActiveDelegations</a></li><li><a href="global.html#getAllSyncStatuses">getAllSyncStatuses</a></li><li><a href="global.html#getAppleOAuthAnalytics">getAppleOAuthAnalytics</a></li><li><a href="global.html#getAppleOAuthConfig">getAppleOAuthConfig</a></li><li><a href="global.html#getAppleUserData">getAppleUserData</a></li><li><a href="global.html#getAvailableContexts">getAvailableContexts</a></li><li><a href="global.html#getAvailableCorporateDomains">getAvailableCorporateDomains</a></li><li><a href="global.html#getAvailableDepartments">getAvailableDepartments</a></li><li><a href="global.html#getAvailablePermissions">getAvailablePermissions</a></li><li><a href="global.html#getCorporateClientDepartments">getCorporateClientDepartments</a></li><li><a href="global.html#getCorporateLandingConfig">getCorporateLandingConfig</a></li><li><a href="global.html#getCorporateSyncHistory">getCorporateSyncHistory</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDatabaseMetrics">getDatabaseMetrics</a></li><li><a href="global.html#getDelegatedPermissions">getDelegatedPermissions</a></li><li><a href="global.html#getDepartmentOAuthAnalytics">getDepartmentOAuthAnalytics</a></li><li><a href="global.html#getDepartmentOAuthConfig">getDepartmentOAuthConfig</a></li><li><a href="global.html#getDepartmentOAuthProviders">getDepartmentOAuthProviders</a></li><li><a href="global.html#getDepartmentPermissions">getDepartmentPermissions</a></li><li><a href="global.html#getErrorDetails">getErrorDetails</a></li><li><a href="global.html#getOAuthAuditLogs">getOAuthAuditLogs</a></li><li><a href="global.html#getOAuthProviderStatus">getOAuthProviderStatus</a></li><li><a href="global.html#getPermissionAuditReport">getPermissionAuditReport</a></li><li><a href="global.html#getPermissionAuditStats">getPermissionAuditStats</a></li><li><a href="global.html#getProviderDisplayName">getProviderDisplayName</a></li><li><a href="global.html#getRequestProperty">getRequestProperty</a></li><li><a href="global.html#getRolePermissions">getRolePermissions</a></li><li><a href="global.html#getSecretsManager">getSecretsManager</a></li><li><a href="global.html#getStatus">getStatus</a></li><li><a href="global.html#getSystemMetrics">getSystemMetrics</a></li><li><a href="global.html#getUserEffectivePermissions">getUserEffectivePermissions</a></li><li><a href="global.html#getUserPermissionInheritance">getUserPermissionInheritance</a></li><li><a href="global.html#getUserProfile">getUserProfile</a></li><li><a href="global.html#getVersion">getVersion</a></li><li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li><li><a href="global.html#handleAppleOAuthCallback">handleAppleOAuthCallback</a></li><li><a href="global.html#handleAppleWebhook">handleAppleWebhook</a></li><li><a href="global.html#handleDepartmentOAuthCallback">handleDepartmentOAuthCallback</a></li><li><a href="global.html#handleMongoError">handleMongoError</a></li><li><a href="global.html#handleParseError">handleParseError</a></li><li><a href="global.html#handleValidationError">handleValidationError</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#https">https</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initiateAppleOAuth">initiateAppleOAuth</a></li><li><a href="global.html#initiateDepartmentOAuth">initiateDepartmentOAuth</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#loadPrivateKey">loadPrivateKey</a></li><li><a href="global.html#logAccessAttempt">logAccessAttempt</a></li><li><a href="global.html#logDataAccess">logDataAccess</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logSecurityEvent">logSecurityEvent</a></li><li><a href="global.html#logSystemChange">logSystemChange</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#recordSuccessfulLogin">recordSuccessfulLogin</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerCloudFunctions">registerCloudFunctions</a></li><li><a href="global.html#requireRole">requireRole</a></li><li><a href="global.html#revokeAppleOAuth">revokeAppleOAuth</a></li><li><a href="global.html#revokePermissionDelegation">revokePermissionDelegation</a></li><li><a href="global.html#setRequestProperty">setRequestProperty</a></li><li><a href="global.html#showForgotPassword">showForgotPassword</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#showRegister">showRegister</a></li><li><a href="global.html#showResetPassword">showResetPassword</a></li><li><a href="global.html#startPeriodicSync">startPeriodicSync</a></li><li><a href="global.html#stopPeriodicSync">stopPeriodicSync</a></li><li><a href="global.html#switchPermissionContext">switchPermissionContext</a></li><li><a href="global.html#switchToDepartmentContext">switchToDepartmentContext</a></li><li><a href="global.html#testCorporateDomain">testCorporateDomain</a></li><li><a href="global.html#triggerCorporateSync">triggerCorporateSync</a></li><li><a href="global.html#updateUserProfile">updateUserProfile</a></li><li><a href="global.html#validateAppleDomain">validateAppleDomain</a></li><li><a href="global.html#validateCorporateLandingAccess">validateCorporateLandingAccess</a></li><li><a href="global.html#validateDepartmentOAuthAccess">validateDepartmentOAuthAccess</a></li><li><a href="global.html#validateLogin">validateLogin</a></li><li><a href="global.html#validateNewPassword">validateNewPassword</a></li><li><a href="global.html#validatePassword">validatePassword</a></li><li><a href="global.html#validatePasswordReset">validatePasswordReset</a></li><li><a href="global.html#validateRegistration">validateRegistration</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUpdateProfile">validateUpdateProfile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Sep 24 2025 12:14:54 GMT-0600 (hora est√°ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>

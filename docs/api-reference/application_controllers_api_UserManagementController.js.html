<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: application/controllers/api/UserManagementController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: application/controllers/api/UserManagementController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * UserManagementController - RESTful API for User Management Operations
 * Provides Ajax-ready endpoints for user CRUD operations with role-based access control.
 * Implements comprehensive security, validation, and audit logging.
 *
 * Features:
 * - RESTful API design (GET, POST, PUT, DELETE)
 * - Role-based access control and filtering
 * - AI agent compliant data operations
 * - Performance optimized with pagination and caching
 * - Comprehensive error handling and validation
 * - Security middleware integration.
 * @author Amexing Development Team
 * @version 1.0.0
 * @since 1.0.0
 */

const UserManagementService = require('../../services/UserManagementService');
const logger = require('../../../infrastructure/logger');

/**
 * UserManagementController class implementing RESTful API for user management.
 * Follows REST conventions and provides comprehensive error handling.
 */
class UserManagementController {
  constructor() {
    this.userService = new UserManagementService();
    this.maxPageSize = 100;
    this.defaultPageSize = 25;
  }

  /**
   * GET /api/users - Get users with filtering, pagination, and role-based access.
   *
   * Query Parameters:
   * - page: Page number (default: 1)
   * - limit: Items per page (default: 25, max: 100)
   * - role: Filter by role
   * - active: Filter by active status (true/false)
   * - search: Search term for email, firstName, lastName
   * - clientId: Filter by client (for superadmin/admin)
   * - departmentId: Filter by department
   * - sortField: Field to sort by (default: lastName)
   * - sortDirection: Sort direction (asc/desc, default: asc).
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @returns {Promise&lt;void>} Promise that resolves when users are retrieved.
   * @example
   * // GET /api/endpoint
   * // Response: { "success": true, "data": [...] }
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   * // Get users with pagination
   * GET /api/users?page=1&amp;limit=10&amp;role=employee
   */
  async getUsers(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      // Parse and validate query parameters
      const options = this.parseUserQueryParams(req.query);

      // Validate permissions for the requested operation
      if (!this.canViewUsers(currentUser, options.targetRole)) {
        return this.sendError(res, 'Insufficient permissions to view users', 403);
      }

      // Get users from service
      const result = await this.userService.getUsers(currentUser, options);

      // Add metadata for frontend consumption
      const response = {
        ...result,
        requestMetadata: {
          endpoint: 'getUsers',
          requestedBy: currentUser.id,
          requestedRole: currentUser.role,
          timestamp: new Date(),
          queryParams: options,
        },
      };

      this.sendSuccess(res, response, 'Users retrieved successfully');
    } catch (error) {
      logger.error('Error in UserManagementController.getUsers', {
        error: error.message,
        stack: error.stack,
        userId: req.user?.id,
        queryParams: req.query,
      });

      this.sendError(res, error.message, 500);
    }
  }

  /**
   * GET /api/users/:id - Get specific user by ID.
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @returns {Promise&lt;void>} Promise that resolves when user is retrieved.
   * @example
   * // GET /api/endpoint
   * // Response: { "success": true, "data": [...] }
   * // GET /api/users?page=1&amp;limit=10
   * // Response: { "users": [...], "pagination": {...} }
   * // Get specific user by ID
   * GET /api/users/12345
   */
  async getUserById(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      const userId = req.params.id;
      if (!userId) {
        return this.sendError(res, 'User ID is required', 400);
      }

      // Get user from service
      const user = await this.userService.getUserById(currentUser, userId);

      if (!user) {
        return this.sendError(res, 'User not found or access denied', 404);
      }

      this.sendSuccess(res, { user }, 'User retrieved successfully');
    } catch (error) {
      logger.error('Error in UserManagementController.getUserById', {
        error: error.message,
        userId: req.user?.id,
        targetUserId: req.params.id,
      });

      if (error.message.includes('Insufficient permissions')) {
        this.sendError(res, error.message, 403);
      } else {
        this.sendError(res, 'Failed to retrieve user', 500);
      }
    }
  }

  /**
   * POST /api/users - Create new user.
   *
   * Request Body:
   * - email: User email (required)
   * - firstName: First name (required)
   * - lastName: Last name (required)
   * - role: User role (required)
   * - password: Initial password (optional - will be generated if not provided)
   * - clientId: Client assignment (optional)
   * - departmentId: Department assignment (optional)
   * - emailVerified: Email verification status (optional, default: false).
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @returns {Promise&lt;void>} Promise that resolves when user is created.
   * @example
   * // POST /api/endpoint
   * // Body: { "data": "value" }
   * // Response: { "success": true, "message": "Created" }
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   * // Create new user
   * POST /api/users with body: { email: 'user@example.com', firstName: 'John', lastName: 'Doe', role: 'employee' }
   */
  async createUser(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      // Validate request body
      const validationErrors = this.validateCreateUserRequest(req.body);
      if (validationErrors.length > 0) {
        return this.sendError(res, `Validation failed: ${validationErrors.join(', ')}`, 400);
      }

      const userData = this.sanitizeUserData(req.body);

      // Generate password if not provided
      if (!userData.password) {
        userData.password = this.generateSecurePassword();
        userData.mustChangePassword = true;
      }

      // Create user through service
      const newUser = await this.userService.createUser(userData, currentUser);

      // Log successful creation
      logger.info('User created via API', {
        newUserId: newUser.id,
        email: userData.email,
        role: userData.role,
        createdBy: currentUser.id,
      });

      // Return user data (excluding password)
      const responseData = {
        user: newUser,
        passwordGenerated: !req.body.password,
        message: !req.body.password
          ? 'User created successfully. Temporary password generated - user must change on first login.'
          : 'User created successfully.',
      };

      this.sendSuccess(res, responseData, 'User created successfully', 201);
    } catch (error) {
      logger.error('Error in UserManagementController.createUser', {
        error: error.message,
        userData: { ...req.body, password: '[REDACTED]' },
        createdBy: req.user?.id,
      });

      if (error.message.includes('Insufficient permissions')) {
        this.sendError(res, error.message, 403);
      } else if (error.message.includes('already exists')) {
        this.sendError(res, error.message, 409);
      } else if (error.message.includes('Validation failed')) {
        this.sendError(res, error.message, 400);
      } else {
        this.sendError(res, 'Failed to create user', 500);
      }
    }
  }

  /**
   * PUT /api/users/:id - Update existing user.
   *
   * Request Body: Partial user data to update
   * - firstName, lastName, role, active, emailVerified, etc.
   * - password: New password (optional)
   * - clientId, departmentId: Organizational assignments (optional).
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @returns {Promise&lt;void>} Promise that resolves when user is updated.
   * @example
   * // PUT /api/endpoint/123
   * // Body: { "field": "updated value" }
   * // Response: { "success": true, "data": {...} }
   * // PUT /api/users/123
   * // Body: { "firstName": "John", "lastName": "Doe" }
   * // Response: { "success": true, "user": {...} }
   * // Update user
   * PUT /api/users/12345 with body: { firstName: 'Jane', role: 'manager' }
   */
  async updateUser(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      const userId = req.params.id;
      if (!userId) {
        return this.sendError(res, 'User ID is required', 400);
      }

      // Validate request body
      const validationErrors = this.validateUpdateUserRequest(req.body);
      if (validationErrors.length > 0) {
        return this.sendError(res, `Validation failed: ${validationErrors.join(', ')}`, 400);
      }

      const updates = this.sanitizeUserData(req.body);

      // Update user through service
      const updatedUser = await this.userService.updateUser(userId, updates, currentUser);

      logger.info('User updated via API', {
        updatedUserId: userId,
        fieldsUpdated: Object.keys(updates),
        modifiedBy: currentUser.id,
      });

      this.sendSuccess(res, { user: updatedUser }, 'User updated successfully');
    } catch (error) {
      logger.error('Error in UserManagementController.updateUser', {
        error: error.message,
        userId: req.params.id,
        updates: { ...req.body, password: req.body.password ? '[REDACTED]' : undefined },
        modifiedBy: req.user?.id,
      });

      if (error.message.includes('Insufficient permissions')) {
        this.sendError(res, error.message, 403);
      } else if (error.message.includes('not found')) {
        this.sendError(res, error.message, 404);
      } else if (error.message.includes('Validation failed')) {
        this.sendError(res, error.message, 400);
      } else {
        this.sendError(res, 'Failed to update user', 500);
      }
    }
  }

  /**
   * DELETE /api/users/:id - Deactivate user (soft delete)
   * Note: This performs soft deletion following AI agent rules.
   *
   * Request Body:
   * - reason: Reason for deactivation (optional).
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @returns {Promise&lt;void>} Promise that resolves when user is deactivated.
   * @example
   * // DELETE /api/endpoint/123
   * // Response: { "success": true, "message": "Deleted" }
   * // DELETE /api/users/123
   * // Response: { "success": true, "message": "User deleted" }
   * // Deactivate user
   * DELETE /api/users/12345 with body: { reason: 'Employee resigned' }
   */
  async deactivateUser(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      const userId = req.params.id;
      if (!userId) {
        return this.sendError(res, 'User ID is required', 400);
      }

      const reason = req.body.reason || 'Deactivated via API';

      // Deactivate user through service
      const success = await this.userService.deactivateUser(userId, currentUser, reason);

      if (success) {
        logger.info('User deactivated via API', {
          deactivatedUserId: userId,
          reason,
          deactivatedBy: currentUser.id,
        });

        this.sendSuccess(res, {
          deactivated: true,
          reason,
        }, 'User deactivated successfully');
      } else {
        this.sendError(res, 'Failed to deactivate user', 500);
      }
    } catch (error) {
      logger.error('Error in UserManagementController.deactivateUser', {
        error: error.message,
        userId: req.params.id,
        reason: req.body.reason,
        deactivatedBy: req.user?.id,
      });

      if (error.message.includes('Insufficient permissions')) {
        this.sendError(res, error.message, 403);
      } else if (error.message.includes('not found')) {
        this.sendError(res, error.message, 404);
      } else if (error.message.includes('Cannot deactivate your own account')) {
        this.sendError(res, error.message, 400);
      } else {
        this.sendError(res, 'Failed to deactivate user', 500);
      }
    }
  }

  /**
   * PUT /api/users/:id/reactivate - Reactivate deactivated user.
   *
   * Request Body:
   * - reason: Reason for reactivation (optional).
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @example
   * // PUT /api/endpoint/123
   * // Body: { "field": "updated value" }
   * // Response: { "success": true, "data": {...} }
   * // PUT /api/users/123
   * // Body: { "firstName": "John", "lastName": "Doe" }
   * // Response: { "success": true, "user": {...} }
   * // PUT /api/users/123/reactivate
   * // Body: { "reason": "Account review completed" }
   * // Response: { "success": true, "user": {...}, "message": "User reactivated successfully" }
   */
  async reactivateUser(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      const userId = req.params.id;
      if (!userId) {
        return this.sendError(res, 'User ID is required', 400);
      }

      const reason = req.body.reason || 'Reactivated via API';

      // Reactivate user through service
      const success = await this.userService.reactivateUser(userId, currentUser, reason);

      if (success) {
        logger.info('User reactivated via API', {
          reactivatedUserId: userId,
          reason,
          reactivatedBy: currentUser.id,
        });

        this.sendSuccess(res, {
          reactivated: true,
          reason,
        }, 'User reactivated successfully');
      } else {
        this.sendError(res, 'Failed to reactivate user', 500);
      }
    } catch (error) {
      logger.error('Error in UserManagementController.reactivateUser', {
        error: error.message,
        userId: req.params.id,
        reason: req.body.reason,
        reactivatedBy: req.user?.id,
      });

      if (error.message.includes('Insufficient permissions')) {
        this.sendError(res, error.message, 403);
      } else if (error.message.includes('not found')) {
        this.sendError(res, error.message, 404);
      } else {
        this.sendError(res, 'Failed to reactivate user', 500);
      }
    }
  }

  /**
   * PATCH /api/users/:id/toggle-status - Toggle user active status
   * Changes user active status between true/false while maintaining exists: true.
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @example
   * // PATCH /api/endpoint/123
   * // Body: { "field": "new value" }
   * // Response: { "success": true, "data": {...} }
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  async toggleUserStatus(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      const userId = req.params.id;
      if (!userId) {
        return this.sendError(res, 'User ID is required', 400);
      }

      const { active, reason } = req.body;
      if (typeof active !== 'boolean') {
        return this.sendError(res, 'Active status (boolean) is required', 400);
      }

      const actionReason = reason || `User ${active ? 'activated' : 'deactivated'} via API`;

      // Toggle user status through service
      const result = await this.userService.toggleUserStatus(currentUser, userId, active, actionReason);

      if (result.success) {
        logger.info('User status toggled via API', {
          targetUserId: userId,
          newStatus: active,
          reason: actionReason,
          actionBy: currentUser.id,
        });

        this.sendSuccess(res, {
          user: result.user,
          previousStatus: result.previousStatus,
          newStatus: active,
          reason: actionReason,
        }, `User ${active ? 'activated' : 'deactivated'} successfully`);
      } else {
        this.sendError(res, result.message || 'Failed to toggle user status', 400);
      }
    } catch (error) {
      logger.error('Error in UserManagementController.toggleUserStatus', {
        error: error.message,
        userId: req.params.id,
        targetStatus: req.body.active,
        actionBy: req.user?.id,
      });

      this.sendError(res, 'Internal server error', 500);
    }
  }

  /**
   * PATCH /api/users/:id/archive - Archive user (soft delete)
   * Sets user to active: false, exists: false making them invisible to normal queries.
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @example
   * // PATCH /api/endpoint/123
   * // Body: { "field": "new value" }
   * // Response: { "success": true, "data": {...} }
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  async archiveUser(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      const userId = req.params.id;
      if (!userId) {
        return this.sendError(res, 'User ID is required', 400);
      }

      const reason = req.body.reason || 'User archived via API';

      // Archive user through service
      const result = await this.userService.archiveUser(currentUser, userId, reason);

      if (result.success) {
        logger.info('User archived via API', {
          archivedUserId: userId,
          reason,
          archivedBy: currentUser.id,
        });

        this.sendSuccess(res, {
          user: result.user,
          archived: true,
          reason,
        }, 'User archived successfully');
      } else {
        this.sendError(res, result.message || 'Failed to archive user', 400);
      }
    } catch (error) {
      logger.error('Error in UserManagementController.archiveUser', {
        error: error.message,
        userId: req.params.id,
        reason: req.body.reason,
        archivedBy: req.user?.id,
      });

      this.sendError(res, 'Internal server error', 500);
    }
  }

  /**
   * GET /api/users/statistics - Get user statistics for dashboard.
   *
   * Returns:
   * - totalUsers: Total number of users
   * - activeUsers: Number of active users
   * - newThisMonth: Users created this month
   * - pendingVerification: Users pending email verification
   * - roleDistribution: User count by role
   * - registrationTrends: Monthly registration trends.
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @example
   * // GET /api/endpoint
   * // Response: { "success": true, "data": [...] }
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  async getUserStatistics(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      // Only superadmin and admin can view statistics
      if (!['superadmin', 'admin'].includes(currentUser.role)) {
        return this.sendError(res, 'Insufficient permissions', 403);
      }

      const stats = await this.userService.getUserStatistics(currentUser);
      this.sendSuccess(res, stats, 'Statistics retrieved successfully');
    } catch (error) {
      logger.error('Error in UserManagementController.getUserStatistics', {
        error: error.message,
        userId: req.user?.id,
      });

      this.sendError(res, 'Failed to retrieve statistics', 500);
    }
  }

  /**
   * GET /api/users/search - Search users with advanced filtering.
   *
   * Query Parameters:
   * - q: Search query
   * - role: Filter by role
   * - active: Filter by active status
   * - page, limit: Pagination
   * - sortField, sortDirection: Sorting.
   * @param {object} req - Express request object.
   * @param {object} res - Express response object.
   * @example
   * // GET /api/endpoint
   * // Response: { "success": true, "data": [...] }
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  async searchUsers(req, res) {
    try {
      const currentUser = req.user;
      if (!currentUser) {
        return this.sendError(res, 'Authentication required', 401);
      }

      const searchParams = this.parseSearchParams(req.query);

      // Perform search through service
      const result = await this.userService.searchUsers(currentUser, searchParams);

      this.sendSuccess(res, result, 'Search completed successfully');
    } catch (error) {
      logger.error('Error in UserManagementController.searchUsers', {
        error: error.message,
        userId: req.user?.id,
        searchParams: req.query,
      });

      this.sendError(res, 'Search failed', 500);
    }
  }

  // ===== HELPER METHODS =====

  /**
   * Parse and validate query parameters for user listing.
   * @param query
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  parseUserQueryParams(query) {
    const page = Math.max(1, parseInt(query.page, 10) || 1);
    const limit = Math.min(this.maxPageSize, Math.max(1, parseInt(query.limit, 10) || this.defaultPageSize));

    return {
      targetRole: query.role || null,
      page,
      limit,
      filters: {
        active: query.active !== undefined ? query.active === 'true' : null,
        emailVerified: query.emailVerified !== undefined ? query.emailVerified === 'true' : null,
        clientId: query.clientId || null,
        departmentId: query.departmentId || null,
        createdAfter: query.createdAfter || null,
        createdBefore: query.createdBefore || null,
      },
      sort: {
        field: query.sortField || 'lastName',
        direction: query.sortDirection || 'asc',
      },
    };
  }

  /**
   * Parse search parameters.
   * @param query
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  parseSearchParams(query) {
    return {
      query: query.q || '',
      role: query.role || null,
      active: query.active !== undefined ? query.active === 'true' : null,
      page: Math.max(1, parseInt(query.page, 10) || 1),
      limit: Math.min(this.maxPageSize, Math.max(1, parseInt(query.limit, 10) || this.defaultPageSize)),
      sortField: query.sortField || 'lastName',
      sortDirection: query.sortDirection || 'asc',
    };
  }

  /**
   * Validate create user request data.
   * @param data
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  validateCreateUserRequest(data) {
    const errors = [];

    if (!data.email || typeof data.email !== 'string' || data.email.trim() === '') {
      errors.push('Email is required');
    }

    if (!data.firstName || typeof data.firstName !== 'string' || data.firstName.trim() === '') {
      errors.push('First name is required');
    }

    if (!data.lastName || typeof data.lastName !== 'string' || data.lastName.trim() === '') {
      errors.push('Last name is required');
    }

    if (!data.role || typeof data.role !== 'string' || data.role.trim() === '') {
      errors.push('Role is required');
    }

    // Email format validation
    if (data.email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(data.email.trim())) {
        errors.push('Invalid email format');
      }
    }

    // Role validation
    const allowedRoles = ['superadmin', 'admin', 'client', 'department_manager', 'employee', 'driver', 'guest'];
    if (data.role &amp;&amp; !allowedRoles.includes(data.role)) {
      errors.push(`Invalid role. Allowed roles: ${allowedRoles.join(', ')}`);
    }

    return errors;
  }

  /**
   * Validate update user request data.
   * @param data
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  validateUpdateUserRequest(data) {
    const errors = [];

    // Email format validation if provided
    if (data.email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(data.email.trim())) {
        errors.push('Invalid email format');
      }
    }

    // Role validation if provided
    if (data.role) {
      const allowedRoles = ['superadmin', 'admin', 'client', 'department_manager', 'employee', 'driver', 'guest'];
      if (!allowedRoles.includes(data.role)) {
        errors.push(`Invalid role. Allowed roles: ${allowedRoles.join(', ')}`);
      }
    }

    return errors;
  }

  /**
   * Sanitize user data to prevent injection attacks.
   * @param data
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  sanitizeUserData(data) {
    const sanitized = {};

    // String fields that should be trimmed
    const stringFields = ['email', 'firstName', 'lastName', 'role', 'clientId', 'departmentId'];
    stringFields.forEach((field) => {
      if (data[field] &amp;&amp; typeof data[field] === 'string') {
        sanitized[field] = data[field].trim();
      }
    });

    // Boolean fields
    const booleanFields = ['active', 'emailVerified', 'mustChangePassword'];
    booleanFields.forEach((field) => {
      if (data[field] !== undefined) {
        sanitized[field] = Boolean(data[field]);
      }
    });

    // Password field (handled specially)
    if (data.password &amp;&amp; typeof data.password === 'string') {
      sanitized.password = data.password; // Don't trim passwords
    }

    return sanitized;
  }

  /**
   * Check if current user can view users with specified role.
   * @param currentUser
   * @param targetRole
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  canViewUsers(currentUser, targetRole) {
    const roleHierarchy = {
      superadmin: 7,
      admin: 6,
      client: 5,
      department_manager: 4,
      employee: 3,
      driver: 2,
      guest: 1,
    };

    // Role levels available for future permissions logic if needed
    // eslint-disable-next-line no-unused-vars
    const currentLevel = roleHierarchy[currentUser.role] || 0;

    // Superadmin can view everything
    if (currentUser.role === 'superadmin') {
      return true;
    }

    // Admin can view all except superadmin
    if (currentUser.role === 'admin') {
      return !targetRole || targetRole !== 'superadmin';
    }

    // Client can view their own company employees
    if (currentUser.role === 'client') {
      return !targetRole || ['employee', 'department_manager'].includes(targetRole);
    }

    // Department manager can view employees
    if (currentUser.role === 'department_manager') {
      return !targetRole || targetRole === 'employee';
    }

    // Lower roles can only view their own profile
    return false;
  }

  /**
   * Generate secure random password.
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  generateSecurePassword() {
    const length = 12;
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&amp;*';
    let password = '';

    for (let i = 0; i &lt; length; i++) {
      password += charset.charAt(Math.floor(Math.random() * charset.length));
    }

    return password;
  }

  /**
   * Send successful response.
   * @param res
   * @param data
   * @param message
   * @param statusCode
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  sendSuccess(res, data, message = 'Success', statusCode = 200) {
    res.status(statusCode).json({
      success: true,
      message,
      data,
      timestamp: new Date().toISOString(),
    });
  }

  /**
   * Send error response.
   * @param res
   * @param message
   * @param statusCode
   * @param details
   * @example
   * // controller.methodName(req, res)
   * // Handles HTTP request and sends appropriate response
   * // Example usage:
   * // const result = await methodName(params);
   * // console.log(result);
   */
  sendError(res, message, statusCode = 500, details = null) {
    const response = {
      success: false,
      error: message,
      timestamp: new Date().toISOString(),
    };

    if (details) {
      response.details = details;
    }

    res.status(statusCode).json(response);
  }
}

module.exports = UserManagementController;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdminController.html">AdminController</a></li><li><a href="AmexingAuthMiddleware.html">AmexingAuthMiddleware</a></li><li><a href="AmexingAuthService.html">AmexingAuthService</a></li><li><a href="AmexingUser.html">AmexingUser</a></li><li><a href="ApiController.html">ApiController</a></li><li><a href="AppleIdTokenValidator.html">AppleIdTokenValidator</a></li><li><a href="AppleOAuthService.html">AppleOAuthService</a></li><li><a href="AppleOAuthServiceCore.html">AppleOAuthServiceCore</a></li><li><a href="AppleSignInButton.html">AppleSignInButton</a></li><li><a href="AppleTokenExchanger.html">AppleTokenExchanger</a></li><li><a href="AuthController.html">AuthController</a></li><li><a href="AuthMiddleware.html">AuthMiddleware</a></li><li><a href="AuthenticationService.html">AuthenticationService</a></li><li><a href="AuthenticationServiceCore.html">AuthenticationServiceCore</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="Client.html">Client</a></li><li><a href="ClientController.html">ClientController</a></li><li><a href="CorporateOAuthInterface.html">CorporateOAuthInterface</a></li><li><a href="CorporateOAuthService.html">CorporateOAuthService</a></li><li><a href="CorporateSyncService.html">CorporateSyncService</a></li><li><a href="DashboardAuthMiddleware.html">DashboardAuthMiddleware</a></li><li><a href="DashboardController.html">DashboardController</a></li><li><a href="Department.html">Department</a></li><li><a href="DepartmentManagerController.html">DepartmentManagerController</a></li><li><a href="DepartmentOAuthFlowService.html">DepartmentOAuthFlowService</a></li><li><a href="DriverController.html">DriverController</a></li><li><a href="EmployeeController.html">EmployeeController</a></li><li><a href="GuestController.html">GuestController</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="IntelligentProviderSelector.html">IntelligentProviderSelector</a></li><li><a href="MobileOAuthOptimizer.html">MobileOAuthOptimizer</a></li><li><a href="NotificationsController.html">NotificationsController</a></li><li><a href="OAuthPermissionService.html">OAuthPermissionService</a></li><li><a href="OAuthProvider.html">OAuthProvider</a></li><li><a href="OAuthSecurityValidator.html">OAuthSecurityValidator</a></li><li><a href="OAuthService.html">OAuthService</a></li><li><a href="PermissionAuditService.html">PermissionAuditService</a></li><li><a href="PermissionContextService.html">PermissionContextService</a></li><li><a href="PermissionDelegationService.html">PermissionDelegationService</a></li><li><a href="PermissionInheritanceService.html">PermissionInheritanceService</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RoleBasedController.html">RoleBasedController</a></li><li><a href="SecureSecretsManager.html">SecureSecretsManager</a></li><li><a href="SecurityMiddleware.html">SecurityMiddleware</a></li><li><a href="SuperAdminController.html">SuperAdminController</a></li><li><a href="UserManagementController.html">UserManagementController</a></li><li><a href="global.html#UserManagementService">UserManagementService</a></li><li><a href="ValidationMiddleware.html">ValidationMiddleware</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BaseModel">BaseModel</a></li><li><a href="global.html#Parse">Parse</a></li><li><a href="global.html#about">about</a></li><li><a href="global.html#addCorporateDomain">addCorporateDomain</a></li><li><a href="global.html#authRateLimit">authRateLimit</a></li><li><a href="global.html#authenticateOptional">authenticateOptional</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#autoRefreshToken">autoRefreshToken</a></li><li><a href="global.html#checkUserPermission">checkUserPermission</a></li><li><a href="global.html#createEmergencyElevation">createEmergencyElevation</a></li><li><a href="global.html#createPermissionDelegation">createPermissionDelegation</a></li><li><a href="global.html#createPermissionOverride">createPermissionOverride</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#expressRateLimit">expressRateLimit</a></li><li><a href="global.html#extractUser">extractUser</a></li><li><a href="global.html#findUserById">findUserById</a></li><li><a href="global.html#generateCorporateOAuthURL">generateCorporateOAuthURL</a></li><li><a href="global.html#generateTokens">generateTokens</a></li><li><a href="global.html#getActiveDelegations">getActiveDelegations</a></li><li><a href="global.html#getAllSyncStatuses">getAllSyncStatuses</a></li><li><a href="global.html#getAppleOAuthAnalytics">getAppleOAuthAnalytics</a></li><li><a href="global.html#getAppleOAuthConfig">getAppleOAuthConfig</a></li><li><a href="global.html#getAppleUserData">getAppleUserData</a></li><li><a href="global.html#getAvailableContexts">getAvailableContexts</a></li><li><a href="global.html#getAvailableCorporateDomains">getAvailableCorporateDomains</a></li><li><a href="global.html#getAvailableDepartments">getAvailableDepartments</a></li><li><a href="global.html#getAvailablePermissions">getAvailablePermissions</a></li><li><a href="global.html#getCorporateClientDepartments">getCorporateClientDepartments</a></li><li><a href="global.html#getCorporateLandingConfig">getCorporateLandingConfig</a></li><li><a href="global.html#getCorporateSyncHistory">getCorporateSyncHistory</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDatabaseMetrics">getDatabaseMetrics</a></li><li><a href="global.html#getDelegatedPermissions">getDelegatedPermissions</a></li><li><a href="global.html#getDepartmentOAuthAnalytics">getDepartmentOAuthAnalytics</a></li><li><a href="global.html#getDepartmentOAuthConfig">getDepartmentOAuthConfig</a></li><li><a href="global.html#getDepartmentOAuthProviders">getDepartmentOAuthProviders</a></li><li><a href="global.html#getDepartmentPermissions">getDepartmentPermissions</a></li><li><a href="global.html#getErrorDetails">getErrorDetails</a></li><li><a href="global.html#getOAuthAuditLogs">getOAuthAuditLogs</a></li><li><a href="global.html#getOAuthProviderStatus">getOAuthProviderStatus</a></li><li><a href="global.html#getPermissionAuditReport">getPermissionAuditReport</a></li><li><a href="global.html#getPermissionAuditStats">getPermissionAuditStats</a></li><li><a href="global.html#getProviderDisplayName">getProviderDisplayName</a></li><li><a href="global.html#getRequestProperty">getRequestProperty</a></li><li><a href="global.html#getRolePermissions">getRolePermissions</a></li><li><a href="global.html#getSecretsManager">getSecretsManager</a></li><li><a href="global.html#getStatus">getStatus</a></li><li><a href="global.html#getSystemMetrics">getSystemMetrics</a></li><li><a href="global.html#getUserEffectivePermissions">getUserEffectivePermissions</a></li><li><a href="global.html#getUserPermissionInheritance">getUserPermissionInheritance</a></li><li><a href="global.html#getUserProfile">getUserProfile</a></li><li><a href="global.html#getVersion">getVersion</a></li><li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li><li><a href="global.html#handleAppleOAuthCallback">handleAppleOAuthCallback</a></li><li><a href="global.html#handleAppleWebhook">handleAppleWebhook</a></li><li><a href="global.html#handleDepartmentOAuthCallback">handleDepartmentOAuthCallback</a></li><li><a href="global.html#handleMongoError">handleMongoError</a></li><li><a href="global.html#handleParseError">handleParseError</a></li><li><a href="global.html#handleValidationError">handleValidationError</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#https">https</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initiateAppleOAuth">initiateAppleOAuth</a></li><li><a href="global.html#initiateDepartmentOAuth">initiateDepartmentOAuth</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#loadPrivateKey">loadPrivateKey</a></li><li><a href="global.html#logAccessAttempt">logAccessAttempt</a></li><li><a href="global.html#logDataAccess">logDataAccess</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logSecurityEvent">logSecurityEvent</a></li><li><a href="global.html#logSystemChange">logSystemChange</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#recordSuccessfulLogin">recordSuccessfulLogin</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerCloudFunctions">registerCloudFunctions</a></li><li><a href="global.html#requireRole">requireRole</a></li><li><a href="global.html#revokeAppleOAuth">revokeAppleOAuth</a></li><li><a href="global.html#revokePermissionDelegation">revokePermissionDelegation</a></li><li><a href="global.html#setRequestProperty">setRequestProperty</a></li><li><a href="global.html#showForgotPassword">showForgotPassword</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#showRegister">showRegister</a></li><li><a href="global.html#showResetPassword">showResetPassword</a></li><li><a href="global.html#startPeriodicSync">startPeriodicSync</a></li><li><a href="global.html#stopPeriodicSync">stopPeriodicSync</a></li><li><a href="global.html#switchPermissionContext">switchPermissionContext</a></li><li><a href="global.html#switchToDepartmentContext">switchToDepartmentContext</a></li><li><a href="global.html#testCorporateDomain">testCorporateDomain</a></li><li><a href="global.html#triggerCorporateSync">triggerCorporateSync</a></li><li><a href="global.html#updateUserProfile">updateUserProfile</a></li><li><a href="global.html#validateAppleDomain">validateAppleDomain</a></li><li><a href="global.html#validateCorporateLandingAccess">validateCorporateLandingAccess</a></li><li><a href="global.html#validateDepartmentOAuthAccess">validateDepartmentOAuthAccess</a></li><li><a href="global.html#validateLogin">validateLogin</a></li><li><a href="global.html#validateNewPassword">validateNewPassword</a></li><li><a href="global.html#validatePassword">validatePassword</a></li><li><a href="global.html#validatePasswordReset">validatePasswordReset</a></li><li><a href="global.html#validateRegistration">validateRegistration</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUpdateProfile">validateUpdateProfile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Sep 24 2025 12:14:54 GMT-0600 (hora est√°ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>

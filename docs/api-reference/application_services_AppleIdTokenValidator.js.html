<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: application/services/AppleIdTokenValidator.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: application/services/AppleIdTokenValidator.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Apple ID Token Validator
 * Handles Apple ID token verification with public key validation.
 */

const Parse = require('parse/node');
const jwt = require('jsonwebtoken');
const https = require('https');
const logger = require('../../infrastructure/logger');

/**
 * Apple ID Token Validator - Validates and verifies Apple Sign In ID tokens.
 * Provides comprehensive JWT validation including signature verification using
 * Apple's public keys, nonce validation, and token expiration checks.
 *
 * This class implements Apple's recommended security practices for ID token
 * verification, ensuring the authenticity and integrity of tokens received
 * from Apple's OAuth service.
 *
 * Features:
 * - JWT signature verification using Apple's public keys
 * - Nonce validation for replay attack protection
 * - Token expiration and issuer validation
 * - Automatic public key fetching and caching
 * - Comprehensive error handling and logging
 * - PCI DSS compliant token processing.
 * @class AppleIdTokenValidator
 * @author Amexing Development Team
 * @version 2.0.0
 * @since 1.0.0
 * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
 * // Initialize validator with Apple OAuth config
 * const config = {
 *   clientId: process.env.APPLE_CLIENT_ID,
 *   teamId: process.env.APPLE_TEAM_ID
 * };
 * const validator = new AppleIdTokenValidator(config);
 *
 * // Verify ID token from Apple callback
 * const payload = await validator.verifyIdToken(idToken, expectedNonce);
 * console.log('User ID:', payload.sub);
 * console.log('Email:', payload.email);
 *
 * // Validate token structure separately
 * const structureValid = await validator.validateTokenStructure(idToken);
 */
class AppleIdTokenValidator {
  constructor(config) {
    this.config = config;
  }

  /**
   * Verifies Apple ID token.
   * @param {string} idToken - Apple ID token.
   * @param {string} expectedNonce - Expected nonce value.
   * @returns {Promise&lt;object>} Decoded token payload.
   * @example Verify Apple ID token
   * const validator = new AppleIdTokenValidator(config);
   * const payload = await validator.verifyIdToken(token, nonce);
   */
  async verifyIdToken(idToken, expectedNonce) {
    try {
      const payload = await this.validateTokenStructure(idToken);
      this.validateNonce(payload, expectedNonce);
      this.validateExpiration(payload);
      return payload;
    } catch (error) {
      logger.error('Apple ID token verification failed:', error);
      throw new Parse.Error(Parse.Error.OTHER_CAUSE, 'Failed to verify Apple ID token');
    }
  }

  /**
   * Validates token structure and signature.
   * @param {string} idToken - ID token to validate.
   * @returns {Promise&lt;object>} Decoded payload.
   * @example Validate token structure
   * const payload = await validator.validateTokenStructure(idToken);
   */
  async validateTokenStructure(idToken) {
    const appleKeys = await this.getApplePublicKeys();
    const decoded = jwt.decode(idToken, { complete: true });

    /**
     * Validates JWT token structure and extracts key identifier.
     * Ensures token has proper format and contains required header information
     * for public key lookup and signature verification.
     */
    if (!decoded || !decoded.header.kid) {
      throw new Error('Invalid ID token format');
    }

    /**
     * Locates matching Apple public key for token verification.
     * Uses key identifier from token header to find corresponding
     * public key from Apple's key set for signature validation.
     */
    const publicKey = appleKeys[decoded.header.kid];
    if (!publicKey) {
      throw new Error('Unable to find matching public key');
    }

    return jwt.verify(idToken, publicKey, {
      algorithms: ['RS256'],
      audience: this.config.clientId,
      issuer: 'https://appleid.apple.com',
    });
  }

  /**
   * Validates nonce if provided.
   * @param {object} payload - Token payload.
   * @param {string} expectedNonce - Expected nonce.
   * @example Validate nonce
   * validator.validateNonce(payload, 'expected-nonce');
   */
  validateNonce(payload, expectedNonce) {
    if (expectedNonce &amp;&amp; payload.nonce !== expectedNonce) {
      throw new Error('Nonce verification failed');
    }
  }

  /**
   * Validates token expiration.
   * @param {object} payload - Token payload.
   * @example Validate expiration
   * validator.validateExpiration(payload);
   */
  validateExpiration(payload) {
    const now = Math.floor(Date.now() / 1000);
    if (payload.exp &amp;&amp; payload.exp &lt; now) {
      throw new Error('ID token has expired');
    }
  }

  /**
   * Gets Apple's public keys for token verification.
   * @returns {Promise&lt;object>} Public keys indexed by kid.
   * @example Get Apple public keys
   * const keys = await validator.getApplePublicKeys();
   */
  async getApplePublicKeys() {
    return new Promise((resolve, reject) => {
      const url = 'https://appleid.apple.com/auth/keys';

      https.get(url, (response) => {
        let data = '';

        response.on('data', (chunk) => {
          data += chunk;
        });

        response.on('end', () => {
          try {
            const keys = JSON.parse(data);
            const publicKeys = {};

            keys.keys.forEach((key) => {
              const publicKey = this.jwkToPublicKey(key);
              publicKeys[key.kid] = publicKey;
            });

            resolve(publicKeys);
          } catch (jwkError) {
            reject(jwkError);
          }
        });
      }).on('error', reject);
    });
  }

  /**
   * Converts JWK to public key format.
   * @param {object} jwk - JSON Web Key.
   * @returns {string} Public key in PEM format.
   * @example Convert JWK to public key
   * const pem = validator.jwkToPublicKey(jwkObject);
   */
  jwkToPublicKey(jwk) {
    // Convert JWK to PEM format for jwt.verify()
    const { kty, n } = jwk;

    if (kty !== 'RSA') {
      throw new Error('Unsupported key type');
    }

    // This is a simplified conversion - in production, use a proper JWK library
    const publicKeyPem = `-----BEGIN PUBLIC KEY-----\n${Buffer.from(n, 'base64').toString('base64')}\n-----END PUBLIC KEY-----`;
    return publicKeyPem;
  }
}

module.exports = { AppleIdTokenValidator };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdminController.html">AdminController</a></li><li><a href="AmexingAuthMiddleware.html">AmexingAuthMiddleware</a></li><li><a href="AmexingAuthService.html">AmexingAuthService</a></li><li><a href="AmexingUser.html">AmexingUser</a></li><li><a href="ApiController.html">ApiController</a></li><li><a href="AppleIdTokenValidator.html">AppleIdTokenValidator</a></li><li><a href="AppleOAuthService.html">AppleOAuthService</a></li><li><a href="AppleOAuthServiceCore.html">AppleOAuthServiceCore</a></li><li><a href="AppleSignInButton.html">AppleSignInButton</a></li><li><a href="AppleTokenExchanger.html">AppleTokenExchanger</a></li><li><a href="AuthController.html">AuthController</a></li><li><a href="AuthMiddleware.html">AuthMiddleware</a></li><li><a href="AuthenticationService.html">AuthenticationService</a></li><li><a href="AuthenticationServiceCore.html">AuthenticationServiceCore</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="Client.html">Client</a></li><li><a href="ClientController.html">ClientController</a></li><li><a href="CorporateOAuthInterface.html">CorporateOAuthInterface</a></li><li><a href="CorporateOAuthService.html">CorporateOAuthService</a></li><li><a href="CorporateSyncService.html">CorporateSyncService</a></li><li><a href="DashboardAuthMiddleware.html">DashboardAuthMiddleware</a></li><li><a href="DashboardController.html">DashboardController</a></li><li><a href="Department.html">Department</a></li><li><a href="DepartmentManagerController.html">DepartmentManagerController</a></li><li><a href="DepartmentOAuthFlowService.html">DepartmentOAuthFlowService</a></li><li><a href="DriverController.html">DriverController</a></li><li><a href="EmployeeController.html">EmployeeController</a></li><li><a href="GuestController.html">GuestController</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="IntelligentProviderSelector.html">IntelligentProviderSelector</a></li><li><a href="MobileOAuthOptimizer.html">MobileOAuthOptimizer</a></li><li><a href="NotificationsController.html">NotificationsController</a></li><li><a href="OAuthPermissionService.html">OAuthPermissionService</a></li><li><a href="OAuthProvider.html">OAuthProvider</a></li><li><a href="OAuthSecurityValidator.html">OAuthSecurityValidator</a></li><li><a href="OAuthService.html">OAuthService</a></li><li><a href="PermissionAuditService.html">PermissionAuditService</a></li><li><a href="PermissionContextService.html">PermissionContextService</a></li><li><a href="PermissionDelegationService.html">PermissionDelegationService</a></li><li><a href="PermissionInheritanceService.html">PermissionInheritanceService</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RoleBasedController.html">RoleBasedController</a></li><li><a href="SecureSecretsManager.html">SecureSecretsManager</a></li><li><a href="SecurityMiddleware.html">SecurityMiddleware</a></li><li><a href="SuperAdminController.html">SuperAdminController</a></li><li><a href="UserManagementController.html">UserManagementController</a></li><li><a href="global.html#UserManagementService">UserManagementService</a></li><li><a href="ValidationMiddleware.html">ValidationMiddleware</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BaseModel">BaseModel</a></li><li><a href="global.html#Parse">Parse</a></li><li><a href="global.html#about">about</a></li><li><a href="global.html#addCorporateDomain">addCorporateDomain</a></li><li><a href="global.html#authRateLimit">authRateLimit</a></li><li><a href="global.html#authenticateOptional">authenticateOptional</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#autoRefreshToken">autoRefreshToken</a></li><li><a href="global.html#checkUserPermission">checkUserPermission</a></li><li><a href="global.html#createEmergencyElevation">createEmergencyElevation</a></li><li><a href="global.html#createPermissionDelegation">createPermissionDelegation</a></li><li><a href="global.html#createPermissionOverride">createPermissionOverride</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#expressRateLimit">expressRateLimit</a></li><li><a href="global.html#extractUser">extractUser</a></li><li><a href="global.html#findUserById">findUserById</a></li><li><a href="global.html#generateCorporateOAuthURL">generateCorporateOAuthURL</a></li><li><a href="global.html#generateTokens">generateTokens</a></li><li><a href="global.html#getActiveDelegations">getActiveDelegations</a></li><li><a href="global.html#getAllSyncStatuses">getAllSyncStatuses</a></li><li><a href="global.html#getAppleOAuthAnalytics">getAppleOAuthAnalytics</a></li><li><a href="global.html#getAppleOAuthConfig">getAppleOAuthConfig</a></li><li><a href="global.html#getAppleUserData">getAppleUserData</a></li><li><a href="global.html#getAvailableContexts">getAvailableContexts</a></li><li><a href="global.html#getAvailableCorporateDomains">getAvailableCorporateDomains</a></li><li><a href="global.html#getAvailableDepartments">getAvailableDepartments</a></li><li><a href="global.html#getAvailablePermissions">getAvailablePermissions</a></li><li><a href="global.html#getCorporateClientDepartments">getCorporateClientDepartments</a></li><li><a href="global.html#getCorporateLandingConfig">getCorporateLandingConfig</a></li><li><a href="global.html#getCorporateSyncHistory">getCorporateSyncHistory</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDatabaseMetrics">getDatabaseMetrics</a></li><li><a href="global.html#getDelegatedPermissions">getDelegatedPermissions</a></li><li><a href="global.html#getDepartmentOAuthAnalytics">getDepartmentOAuthAnalytics</a></li><li><a href="global.html#getDepartmentOAuthConfig">getDepartmentOAuthConfig</a></li><li><a href="global.html#getDepartmentOAuthProviders">getDepartmentOAuthProviders</a></li><li><a href="global.html#getDepartmentPermissions">getDepartmentPermissions</a></li><li><a href="global.html#getErrorDetails">getErrorDetails</a></li><li><a href="global.html#getOAuthAuditLogs">getOAuthAuditLogs</a></li><li><a href="global.html#getOAuthProviderStatus">getOAuthProviderStatus</a></li><li><a href="global.html#getPermissionAuditReport">getPermissionAuditReport</a></li><li><a href="global.html#getPermissionAuditStats">getPermissionAuditStats</a></li><li><a href="global.html#getProviderDisplayName">getProviderDisplayName</a></li><li><a href="global.html#getRequestProperty">getRequestProperty</a></li><li><a href="global.html#getRolePermissions">getRolePermissions</a></li><li><a href="global.html#getSecretsManager">getSecretsManager</a></li><li><a href="global.html#getStatus">getStatus</a></li><li><a href="global.html#getSystemMetrics">getSystemMetrics</a></li><li><a href="global.html#getUserEffectivePermissions">getUserEffectivePermissions</a></li><li><a href="global.html#getUserPermissionInheritance">getUserPermissionInheritance</a></li><li><a href="global.html#getUserProfile">getUserProfile</a></li><li><a href="global.html#getVersion">getVersion</a></li><li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li><li><a href="global.html#handleAppleOAuthCallback">handleAppleOAuthCallback</a></li><li><a href="global.html#handleAppleWebhook">handleAppleWebhook</a></li><li><a href="global.html#handleDepartmentOAuthCallback">handleDepartmentOAuthCallback</a></li><li><a href="global.html#handleMongoError">handleMongoError</a></li><li><a href="global.html#handleParseError">handleParseError</a></li><li><a href="global.html#handleValidationError">handleValidationError</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#https">https</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initiateAppleOAuth">initiateAppleOAuth</a></li><li><a href="global.html#initiateDepartmentOAuth">initiateDepartmentOAuth</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#loadPrivateKey">loadPrivateKey</a></li><li><a href="global.html#logAccessAttempt">logAccessAttempt</a></li><li><a href="global.html#logDataAccess">logDataAccess</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logSecurityEvent">logSecurityEvent</a></li><li><a href="global.html#logSystemChange">logSystemChange</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#recordSuccessfulLogin">recordSuccessfulLogin</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerCloudFunctions">registerCloudFunctions</a></li><li><a href="global.html#requireRole">requireRole</a></li><li><a href="global.html#revokeAppleOAuth">revokeAppleOAuth</a></li><li><a href="global.html#revokePermissionDelegation">revokePermissionDelegation</a></li><li><a href="global.html#setRequestProperty">setRequestProperty</a></li><li><a href="global.html#showForgotPassword">showForgotPassword</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#showRegister">showRegister</a></li><li><a href="global.html#showResetPassword">showResetPassword</a></li><li><a href="global.html#startPeriodicSync">startPeriodicSync</a></li><li><a href="global.html#stopPeriodicSync">stopPeriodicSync</a></li><li><a href="global.html#switchPermissionContext">switchPermissionContext</a></li><li><a href="global.html#switchToDepartmentContext">switchToDepartmentContext</a></li><li><a href="global.html#testCorporateDomain">testCorporateDomain</a></li><li><a href="global.html#triggerCorporateSync">triggerCorporateSync</a></li><li><a href="global.html#updateUserProfile">updateUserProfile</a></li><li><a href="global.html#validateAppleDomain">validateAppleDomain</a></li><li><a href="global.html#validateCorporateLandingAccess">validateCorporateLandingAccess</a></li><li><a href="global.html#validateDepartmentOAuthAccess">validateDepartmentOAuthAccess</a></li><li><a href="global.html#validateLogin">validateLogin</a></li><li><a href="global.html#validateNewPassword">validateNewPassword</a></li><li><a href="global.html#validatePassword">validatePassword</a></li><li><a href="global.html#validatePasswordReset">validatePasswordReset</a></li><li><a href="global.html#validateRegistration">validateRegistration</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUpdateProfile">validateUpdateProfile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Sep 24 2025 12:14:54 GMT-0600 (hora est√°ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: cloud/functions/corporate-landing.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: cloud/functions/corporate-landing.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Corporate Landing Pages Cloud Functions
 * Handles corporate-specific landing page generation and OAuth flows.
 * @author Amexing Development Team
 * @version 1.0.0
 * @created Sprint 02 - Corporate Landing Pages
 */

const Parse = require('parse/node');
const OAuthService = require('../../application/services/OAuthService');
const CorporateOAuthService = require('../../application/services/CorporateOAuthService');
const logger = require('../../infrastructure/logger');

/**
 * Generates corporate landing page configuration
 * Endpoint: GET /functions/getCorporateLandingConfig
 * Access: Public (but logs for security monitoring).
 * @param request
 * @example
   * // GET /api/endpoint
   * // Response: { "success": true, "data": [...] }
 */
const getCorporateLandingConfig = async (request) => {
  try {
    const { clientSlug, departmentCode, email } = request.params;

    let corporateConfig = null;
    let suggestedProvider = null;
    let autoSSO = false;

    // If email is provided, check for corporate domain
    if (email) {
      const domainConfig = OAuthService.getCorporateDomainConfig(email);
      if (domainConfig) {
        corporateConfig = domainConfig;
        suggestedProvider = domainConfig.primaryProvider;
        autoSSO = true;

        logger.logSecurityEvent('CORPORATE_LANDING_EMAIL_DETECTED', null, {
          email: CorporateOAuthService.maskEmail(email),
          domain: CorporateOAuthService.extractEmailDomain(email),
          provider: suggestedProvider,
          clientName: domainConfig.clientName,
        });
      }
    }

    // If client slug is provided, try to find corporate client
    let clientInfo = null;
    if (clientSlug) {
      try {
        const clientQuery = new Parse.Query('Client');
        clientQuery.equalTo('urlSlug', clientSlug);
        clientQuery.equalTo('active', true);

        const client = await clientQuery.first({ useMasterKey: true });

        if (client) {
          clientInfo = {
            id: client.id,
            name: client.get('name'),
            isCorporate: client.get('isCorporate') || false,
            oauthEnabled: client.get('oauthEnabled') || false,
            primaryOAuthProvider: client.get('primaryOAuthProvider'),
            corporateDomain: client.get('corporateDomain'),
          };

          // If client has OAuth configured, set as corporate config
          if (clientInfo.oauthEnabled &amp;&amp; clientInfo.corporateDomain) {
            const domainConfig = OAuthService.getCorporateDomainConfig(`test@${clientInfo.corporateDomain}`);
            if (domainConfig) {
              corporateConfig = domainConfig;
              suggestedProvider = clientInfo.primaryOAuthProvider || domainConfig.primaryProvider;
            }
          }
        }
      } catch (error) {
        logger.error('Error finding client by slug:', error);
      }
    }

    // Get available OAuth providers
    const availableProviders = OAuthService.getAvailableProviders();
    const providerConfigs = {};

    for (const provider of availableProviders) {
      const config = OAuthService.getProviderConfig(provider);
      providerConfigs[provider] = {
        name: provider,
        enabled: config.enabled,
        mockMode: config.mockMode,
      };
    }

    const response = {
      success: true,
      clientInfo,
      corporateConfig,
      suggestedProvider,
      autoSSO,
      availableProviders: providerConfigs,
      departmentCode: departmentCode || null,
      ssoEnabled: !!corporateConfig,
    };

    // Log landing page access for security monitoring
    logger.logSecurityEvent('CORPORATE_LANDING_ACCESSED', null, {
      clientSlug: clientSlug || 'none',
      departmentCode: departmentCode || 'none',
      hasEmail: !!email,
      ssoEnabled: response.ssoEnabled,
      suggestedProvider: suggestedProvider || 'none',
    });

    return response;
  } catch (error) {
    logger.error('Error generating corporate landing config:', error);
    throw error;
  }
};

/**
 * Generates OAuth authorization URL for corporate landing
 * Endpoint: POST /functions/generateCorporateOAuthURL
 * Access: Public.
 * @param request
 * @example
   * // POST /api/endpoint
   * // Body: { "data": "value" }
   * // Response: { "success": true, "message": "Created" }
 */
const generateCorporateOAuthURL = async (request) => {
  try {
    const {
      provider, email, clientSlug, departmentCode, redirectUri,
    } = request.params;

    if (!provider) {
      throw new Parse.Error(Parse.Error.INVALID_QUERY, 'Provider is required');
    }

    // Validate provider
    const availableProviders = OAuthService.getAvailableProviders();
    if (!availableProviders.includes(provider)) {
      throw new Parse.Error(
        Parse.Error.INVALID_QUERY,
        `Invalid provider. Available: ${availableProviders.join(', ')}`
      );
    }

    // If email is provided, validate corporate configuration
    let corporateInfo = null;
    if (email) {
      const domainConfig = OAuthService.getCorporateDomainConfig(email);
      if (domainConfig) {
        corporateInfo = {
          domain: CorporateOAuthService.extractEmailDomain(email),
          clientName: domainConfig.clientName,
          primaryProvider: domainConfig.primaryProvider,
        };

        // Warn if using different provider than configured
        if (domainConfig.primaryProvider !== provider) {
          logger.logSecurityEvent('CORPORATE_OAUTH_PROVIDER_MISMATCH', null, {
            email: CorporateOAuthService.maskEmail(email),
            configuredProvider: domainConfig.primaryProvider,
            requestedProvider: provider,
          });
        }
      }
    }

    // Generate OAuth URL with corporate context
    const state = JSON.stringify({
      clientSlug: clientSlug || null,
      departmentCode: departmentCode || null,
      corporateDomain: corporateInfo?.domain || null,
      timestamp: Date.now(),
    });

    const authURL = await OAuthService.generateAuthorizationURL(
      provider,
      redirectUri || `${process.env.PARSE_PUBLIC_SERVER_URL}/auth/${provider}/callback`,
      state
    );

    logger.logSecurityEvent('CORPORATE_OAUTH_URL_GENERATED', null, {
      provider,
      hasEmail: !!email,
      hasCorporateInfo: !!corporateInfo,
      clientSlug: clientSlug || 'none',
      departmentCode: departmentCode || 'none',
    });

    return {
      success: true,
      authURL,
      provider,
      corporateInfo,
      state,
    };
  } catch (error) {
    logger.error('Error generating corporate OAuth URL:', error);
    throw error;
  }
};

/**
 * Validates corporate landing page access
 * Endpoint: POST /functions/validateCorporateLandingAccess
 * Access: Public (with rate limiting).
 * @param request
 * @example
   * // POST /api/endpoint
   * // Body: { "data": "value" }
   * // Response: { "success": true, "message": "Created" }
 */
const validateCorporateLandingAccess = async (request) => {
  try {
    const {
      clientSlug, departmentCode, email,
    } = request.params;

    // Basic validation
    if (!clientSlug) {
      throw new Parse.Error(Parse.Error.INVALID_QUERY, 'Client slug is required');
    }

    // Find client
    const clientQuery = new Parse.Query('Client');
    clientQuery.equalTo('urlSlug', clientSlug);
    clientQuery.equalTo('active', true);

    const client = await clientQuery.first({ useMasterKey: true });

    if (!client) {
      throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Client not found');
    }

    let accessGranted = true;
    let requiresSSO = false;
    let ssoProvider = null;

    // Check if this is a corporate client with SSO requirements
    if (client.get('isCorporate') &amp;&amp; client.get('oauthEnabled')) {
      requiresSSO = true;
      ssoProvider = client.get('primaryOAuthProvider');

      // If email is provided and matches corporate domain, allow access
      if (email &amp;&amp; client.get('corporateDomain')) {
        const emailDomain = CorporateOAuthService.extractEmailDomain(email);
        if (emailDomain !== client.get('corporateDomain')) {
          accessGranted = false;
        }
      }
    }

    // Check department access if specified
    let departmentInfo = null;
    if (departmentCode &amp;&amp; client.get('isCorporate')) {
      try {
        const deptQuery = new Parse.Query('ClientDepartment');
        deptQuery.equalTo('clientId', client.id);
        deptQuery.equalTo('departmentCode', departmentCode);
        deptQuery.equalTo('active', true);

        const department = await deptQuery.first({ useMasterKey: true });

        if (department) {
          departmentInfo = {
            id: department.id,
            name: department.get('name'),
            code: department.get('departmentCode'),
            requiresApproval: department.get('requiresApproval') || false,
          };
        } else {
          // Department not found, but don't block access
          logger.logSecurityEvent('DEPARTMENT_NOT_FOUND', null, {
            clientSlug,
            departmentCode,
            clientId: client.id,
          });
        }
      } catch (error) {
        logger.error('Error finding department:', error);
      }
    }

    logger.logSecurityEvent('CORPORATE_LANDING_ACCESS_VALIDATED', null, {
      clientSlug,
      departmentCode: departmentCode || 'none',
      hasEmail: !!email,
      accessGranted,
      requiresSSO,
      ssoProvider: ssoProvider || 'none',
    });

    return {
      success: true,
      accessGranted,
      requiresSSO,
      ssoProvider,
      client: {
        id: client.id,
        name: client.get('name'),
        isCorporate: client.get('isCorporate'),
        corporateDomain: client.get('corporateDomain'),
      },
      departmentInfo,
      message: accessGranted
        ? 'Access granted to corporate landing page'
        : 'Access restricted - SSO required',
    };
  } catch (error) {
    logger.error('Error validating corporate landing access:', error);
    throw error;
  }
};

/**
 * Gets corporate client departments for landing page
 * Endpoint: GET /functions/getCorporateClientDepartments
 * Access: Public (for client-specific landing pages).
 * @param request
 * @example
   * // GET /api/endpoint
   * // Response: { "success": true, "data": [...] }
 */
const getCorporateClientDepartments = async (request) => {
  try {
    const { clientSlug } = request.params;

    if (!clientSlug) {
      throw new Parse.Error(Parse.Error.INVALID_QUERY, 'Client slug is required');
    }

    // Find client
    const clientQuery = new Parse.Query('Client');
    clientQuery.equalTo('urlSlug', clientSlug);
    clientQuery.equalTo('active', true);

    const client = await clientQuery.first({ useMasterKey: true });

    if (!client) {
      throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Client not found');
    }

    // Only return departments for corporate clients
    if (!client.get('isCorporate')) {
      return {
        success: true,
        departments: [],
        message: 'Client is not configured as corporate',
      };
    }

    // Get client departments
    const deptQuery = new Parse.Query('ClientDepartment');
    deptQuery.equalTo('clientId', client.id);
    deptQuery.equalTo('active', true);
    deptQuery.ascending('name');

    const departments = await deptQuery.find({ useMasterKey: true });

    const departmentList = departments.map((dept) => ({
      id: dept.id,
      name: dept.get('name'),
      code: dept.get('departmentCode'),
      description: dept.get('description'),
      requiresApproval: dept.get('requiresApproval') || false,
      color: dept.get('color') || '#007bff',
      icon: dept.get('icon') || 'department',
    }));

    logger.logSecurityEvent('CORPORATE_DEPARTMENTS_RETRIEVED', null, {
      clientSlug,
      clientId: client.id,
      departmentCount: departmentList.length,
    });

    return {
      success: true,
      client: {
        id: client.id,
        name: client.get('name'),
        isCorporate: true,
      },
      departments: departmentList,
      count: departmentList.length,
    };
  } catch (error) {
    logger.error('Error getting corporate client departments:', error);
    throw error;
  }
};

module.exports = {
  getCorporateLandingConfig,
  generateCorporateOAuthURL,
  validateCorporateLandingAccess,
  getCorporateClientDepartments,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdminController.html">AdminController</a></li><li><a href="AmexingAuthMiddleware.html">AmexingAuthMiddleware</a></li><li><a href="AmexingAuthService.html">AmexingAuthService</a></li><li><a href="AmexingUser.html">AmexingUser</a></li><li><a href="ApiController.html">ApiController</a></li><li><a href="AppleIdTokenValidator.html">AppleIdTokenValidator</a></li><li><a href="AppleOAuthService.html">AppleOAuthService</a></li><li><a href="AppleOAuthServiceCore.html">AppleOAuthServiceCore</a></li><li><a href="AppleSignInButton.html">AppleSignInButton</a></li><li><a href="AppleTokenExchanger.html">AppleTokenExchanger</a></li><li><a href="AuthController.html">AuthController</a></li><li><a href="AuthMiddleware.html">AuthMiddleware</a></li><li><a href="AuthenticationService.html">AuthenticationService</a></li><li><a href="AuthenticationServiceCore.html">AuthenticationServiceCore</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="Client.html">Client</a></li><li><a href="ClientController.html">ClientController</a></li><li><a href="CorporateOAuthInterface.html">CorporateOAuthInterface</a></li><li><a href="CorporateOAuthService.html">CorporateOAuthService</a></li><li><a href="CorporateSyncService.html">CorporateSyncService</a></li><li><a href="DashboardAuthMiddleware.html">DashboardAuthMiddleware</a></li><li><a href="DashboardController.html">DashboardController</a></li><li><a href="Department.html">Department</a></li><li><a href="DepartmentManagerController.html">DepartmentManagerController</a></li><li><a href="DepartmentOAuthFlowService.html">DepartmentOAuthFlowService</a></li><li><a href="DriverController.html">DriverController</a></li><li><a href="EmployeeController.html">EmployeeController</a></li><li><a href="GuestController.html">GuestController</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="IntelligentProviderSelector.html">IntelligentProviderSelector</a></li><li><a href="MobileOAuthOptimizer.html">MobileOAuthOptimizer</a></li><li><a href="NotificationsController.html">NotificationsController</a></li><li><a href="OAuthPermissionService.html">OAuthPermissionService</a></li><li><a href="OAuthProvider.html">OAuthProvider</a></li><li><a href="OAuthSecurityValidator.html">OAuthSecurityValidator</a></li><li><a href="OAuthService.html">OAuthService</a></li><li><a href="PermissionAuditService.html">PermissionAuditService</a></li><li><a href="PermissionContextService.html">PermissionContextService</a></li><li><a href="PermissionDelegationService.html">PermissionDelegationService</a></li><li><a href="PermissionInheritanceService.html">PermissionInheritanceService</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RoleBasedController.html">RoleBasedController</a></li><li><a href="SecureSecretsManager.html">SecureSecretsManager</a></li><li><a href="SecurityMiddleware.html">SecurityMiddleware</a></li><li><a href="SuperAdminController.html">SuperAdminController</a></li><li><a href="UserManagementController.html">UserManagementController</a></li><li><a href="global.html#UserManagementService">UserManagementService</a></li><li><a href="ValidationMiddleware.html">ValidationMiddleware</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BaseModel">BaseModel</a></li><li><a href="global.html#Parse">Parse</a></li><li><a href="global.html#about">about</a></li><li><a href="global.html#addCorporateDomain">addCorporateDomain</a></li><li><a href="global.html#authRateLimit">authRateLimit</a></li><li><a href="global.html#authenticateOptional">authenticateOptional</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#autoRefreshToken">autoRefreshToken</a></li><li><a href="global.html#checkUserPermission">checkUserPermission</a></li><li><a href="global.html#createEmergencyElevation">createEmergencyElevation</a></li><li><a href="global.html#createPermissionDelegation">createPermissionDelegation</a></li><li><a href="global.html#createPermissionOverride">createPermissionOverride</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#expressRateLimit">expressRateLimit</a></li><li><a href="global.html#extractUser">extractUser</a></li><li><a href="global.html#findUserById">findUserById</a></li><li><a href="global.html#generateCorporateOAuthURL">generateCorporateOAuthURL</a></li><li><a href="global.html#generateTokens">generateTokens</a></li><li><a href="global.html#getActiveDelegations">getActiveDelegations</a></li><li><a href="global.html#getAllSyncStatuses">getAllSyncStatuses</a></li><li><a href="global.html#getAppleOAuthAnalytics">getAppleOAuthAnalytics</a></li><li><a href="global.html#getAppleOAuthConfig">getAppleOAuthConfig</a></li><li><a href="global.html#getAppleUserData">getAppleUserData</a></li><li><a href="global.html#getAvailableContexts">getAvailableContexts</a></li><li><a href="global.html#getAvailableCorporateDomains">getAvailableCorporateDomains</a></li><li><a href="global.html#getAvailableDepartments">getAvailableDepartments</a></li><li><a href="global.html#getAvailablePermissions">getAvailablePermissions</a></li><li><a href="global.html#getCorporateClientDepartments">getCorporateClientDepartments</a></li><li><a href="global.html#getCorporateLandingConfig">getCorporateLandingConfig</a></li><li><a href="global.html#getCorporateSyncHistory">getCorporateSyncHistory</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDatabaseMetrics">getDatabaseMetrics</a></li><li><a href="global.html#getDelegatedPermissions">getDelegatedPermissions</a></li><li><a href="global.html#getDepartmentOAuthAnalytics">getDepartmentOAuthAnalytics</a></li><li><a href="global.html#getDepartmentOAuthConfig">getDepartmentOAuthConfig</a></li><li><a href="global.html#getDepartmentOAuthProviders">getDepartmentOAuthProviders</a></li><li><a href="global.html#getDepartmentPermissions">getDepartmentPermissions</a></li><li><a href="global.html#getErrorDetails">getErrorDetails</a></li><li><a href="global.html#getOAuthAuditLogs">getOAuthAuditLogs</a></li><li><a href="global.html#getOAuthProviderStatus">getOAuthProviderStatus</a></li><li><a href="global.html#getPermissionAuditReport">getPermissionAuditReport</a></li><li><a href="global.html#getPermissionAuditStats">getPermissionAuditStats</a></li><li><a href="global.html#getProviderDisplayName">getProviderDisplayName</a></li><li><a href="global.html#getRequestProperty">getRequestProperty</a></li><li><a href="global.html#getRolePermissions">getRolePermissions</a></li><li><a href="global.html#getSecretsManager">getSecretsManager</a></li><li><a href="global.html#getStatus">getStatus</a></li><li><a href="global.html#getSystemMetrics">getSystemMetrics</a></li><li><a href="global.html#getUserEffectivePermissions">getUserEffectivePermissions</a></li><li><a href="global.html#getUserPermissionInheritance">getUserPermissionInheritance</a></li><li><a href="global.html#getUserProfile">getUserProfile</a></li><li><a href="global.html#getVersion">getVersion</a></li><li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li><li><a href="global.html#handleAppleOAuthCallback">handleAppleOAuthCallback</a></li><li><a href="global.html#handleAppleWebhook">handleAppleWebhook</a></li><li><a href="global.html#handleDepartmentOAuthCallback">handleDepartmentOAuthCallback</a></li><li><a href="global.html#handleMongoError">handleMongoError</a></li><li><a href="global.html#handleParseError">handleParseError</a></li><li><a href="global.html#handleValidationError">handleValidationError</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#https">https</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initiateAppleOAuth">initiateAppleOAuth</a></li><li><a href="global.html#initiateDepartmentOAuth">initiateDepartmentOAuth</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#loadPrivateKey">loadPrivateKey</a></li><li><a href="global.html#logAccessAttempt">logAccessAttempt</a></li><li><a href="global.html#logDataAccess">logDataAccess</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logSecurityEvent">logSecurityEvent</a></li><li><a href="global.html#logSystemChange">logSystemChange</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#recordSuccessfulLogin">recordSuccessfulLogin</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerCloudFunctions">registerCloudFunctions</a></li><li><a href="global.html#requireRole">requireRole</a></li><li><a href="global.html#revokeAppleOAuth">revokeAppleOAuth</a></li><li><a href="global.html#revokePermissionDelegation">revokePermissionDelegation</a></li><li><a href="global.html#setRequestProperty">setRequestProperty</a></li><li><a href="global.html#showForgotPassword">showForgotPassword</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#showRegister">showRegister</a></li><li><a href="global.html#showResetPassword">showResetPassword</a></li><li><a href="global.html#startPeriodicSync">startPeriodicSync</a></li><li><a href="global.html#stopPeriodicSync">stopPeriodicSync</a></li><li><a href="global.html#switchPermissionContext">switchPermissionContext</a></li><li><a href="global.html#switchToDepartmentContext">switchToDepartmentContext</a></li><li><a href="global.html#testCorporateDomain">testCorporateDomain</a></li><li><a href="global.html#triggerCorporateSync">triggerCorporateSync</a></li><li><a href="global.html#updateUserProfile">updateUserProfile</a></li><li><a href="global.html#validateAppleDomain">validateAppleDomain</a></li><li><a href="global.html#validateCorporateLandingAccess">validateCorporateLandingAccess</a></li><li><a href="global.html#validateDepartmentOAuthAccess">validateDepartmentOAuthAccess</a></li><li><a href="global.html#validateLogin">validateLogin</a></li><li><a href="global.html#validateNewPassword">validateNewPassword</a></li><li><a href="global.html#validatePassword">validatePassword</a></li><li><a href="global.html#validatePasswordReset">validatePasswordReset</a></li><li><a href="global.html#validateRegistration">validateRegistration</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUpdateProfile">validateUpdateProfile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Sep 24 2025 12:14:54 GMT-0600 (hora est√°ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>

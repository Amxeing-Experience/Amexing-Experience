<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: application/services/AppleOAuthServiceCore.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: application/services/AppleOAuthServiceCore.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Apple OAuth Service Core - Refactored Sprint 04
 * Core Apple OAuth functionality split into manageable components.
 * Backend integration for Apple Sign In with privacy compliance.
 */

const Parse = require('parse/node');
const crypto = require('crypto');
const fs = require('fs');

const logger = require('../../infrastructure/logger');
const { AppleIdTokenValidator } = require('./AppleIdTokenValidator');
const { AppleTokenExchanger } = require('./AppleTokenExchanger');

/**
 * Apple OAuth Service Core - Core functionality for Apple Sign In integration.
 * Provides the foundational components for Apple OAuth authentication including
 * configuration management, private key handling, and core OAuth flow logic.
 *
 * This is the base class that contains shared functionality for Apple OAuth operations.
 * It manages Apple-specific configurations, validates ID tokens, and handles
 * the core authentication flow components.
 *
 * Features:
 * - Apple OAuth configuration validation
 * - Private key management for JWT signing
 * - ID token validation and verification
 * - Token exchange functionality
 * - User data parsing and validation
 * - Error handling and logging.
 * @class AppleOAuthServiceCore
 * @author Amexing Development Team
 * @version 2.0.0
 * @since 1.0.0
 * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
 * // Extend for specific Apple OAuth functionality
 * class AppleOAuthService extends AppleOAuthServiceCore {
 *   async handleCallback(callbackData) {
 *     return super.processAuthentication(callbackData);
 *   }
 * }
 *
 * // Direct usage for core operations
 * const core = new AppleOAuthServiceCore();
 * const isValid = core.validateConfig();
 * const tokenData = await core.exchangeCodeForTokens(authCode);
 */
class AppleOAuthServiceCore {
  constructor() {
    this.config = {
      teamId: process.env.APPLE_TEAM_ID,
      clientId: process.env.APPLE_CLIENT_ID,
      keyId: process.env.APPLE_KEY_ID,
      privateKeyPath: process.env.APPLE_PRIVATE_KEY_PATH,
      redirectUri: process.env.APPLE_REDIRECT_URI || `${process.env.PARSE_PUBLIC_SERVER_URL}/auth/oauth/apple/callback`,
      scope: 'email name',
      responseType: 'code id_token',
      responseMode: 'form_post',
    };

    this.validateConfig();
    this.loadPrivateKey();
    this.initializeHelpers();
  }

  /**
   * Validates Apple OAuth configuration.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  validateConfig() {
    const required = ['teamId', 'clientId', 'keyId', 'privateKeyPath'];
    // eslint-disable-next-line security/detect-object-injection
    const missing = required.filter((key) => !this.config[key]);

    /**
     * Handles missing configuration with environment-aware behavior.
     * In development: warns and disables service gracefully.
     * In production: throws error to prevent silent failures.
     */
    if (missing.length > 0) {
      if (process.env.NODE_ENV === 'development') {
        logger.warn(`Apple OAuth not configured in development: ${missing.join(', ')}`);
        this.disabled = true;
        return;
      }
      throw new Error(`Missing Apple OAuth configuration: ${missing.join(', ')}`);
    }
  }

  /**
   * Loads Apple private key from filesystem with error handling and validation.
   * Reads the private key file for JWT signing in Apple OAuth flow with
   * proper error handling and security validation for key format.
   * @function loadPrivateKey
   * @returns {void} Loads private key into service instance.
   * @throws {Error} If private key file cannot be read or is invalid.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   * // Load private key during service initialization
   * appleOAuthService.loadPrivateKey();
   */
  loadPrivateKey() {
    /**
     * Skips key loading if service is disabled due to missing configuration.
     * Prevents errors in development environments with incomplete setup.
     */
    if (this.disabled) {
      return;
    }

    try {
      // eslint-disable-next-line security/detect-non-literal-fs-filename
      if (!fs.existsSync(this.config.privateKeyPath)) {
        throw new Error(`Apple private key file not found: ${this.config.privateKeyPath}`);
      }

      // eslint-disable-next-line security/detect-non-literal-fs-filename
      this.privateKey = fs.readFileSync(this.config.privateKeyPath, 'utf8');
      logger.info('Apple OAuth private key loaded successfully');
    } catch (error) {
      logger.error('Failed to load Apple OAuth private key:', error);
      throw error;
    }
  }

  /**
   * Initializes helper services.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  initializeHelpers() {
    if (this.disabled) {
      return;
    }

    this.tokenValidator = new AppleIdTokenValidator(this.config);
    this.tokenExchanger = new AppleTokenExchanger(this.config, this.privateKey);
  }

  /**
   * Builds Apple OAuth authorization URL.
   * @param {object} options - Authorization options.
   * @returns {string} Authorization URL.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  buildAuthUrl(options = {}) {
    const {
      state,
      nonce,
      responseMode = this.config.responseMode,
    } = options;

    const params = new URLSearchParams({
      client_id: this.config.clientId,
      redirect_uri: this.config.redirectUri,
      response_type: this.config.responseType,
      scope: this.config.scope,
      response_mode: responseMode,
      state: state || crypto.randomBytes(16).toString('hex'),
      nonce: nonce || crypto.randomBytes(16).toString('hex'),
    });

    return `https://appleid.apple.com/auth/authorize?${params.toString()}`;
  }

  /**
   * Initiates Apple OAuth flow.
   * @param {object} options - OAuth initiation options.
   * @returns {Promise&lt;object>} OAuth initiation result.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  async initiateOAuth(options = {}) {
    const {
      department,
      corporateConfigId,
      redirectUri,
      state: providedState,
      headers = {},
      ip,
    } = options;

    try {
      const state = providedState || crypto.randomBytes(32).toString('hex');
      const nonce = crypto.randomBytes(32).toString('hex');

      // Build authorization URL
      const authUrl = this.buildAuthUrl({
        state,
        nonce,
        responseMode: 'form_post',
      });

      // Store OAuth state with Apple-specific data
      const stateData = {
        provider: 'apple',
        state,
        nonce,
        department,
        corporateConfigId,
        redirectUri: redirectUri || this.config.redirectUri,
        timestamp: new Date(),
        ip,
        userAgent: headers['user-agent'],
      };

      logger.info(`Apple OAuth initiated for department: ${department}, IP: ${ip}`);

      return {
        authUrl,
        state,
        nonce,
        expiresIn: 600000, // 10 minutes
        stateData,
      };
    } catch (error) {
      logger.error('Apple OAuth initiation failed:', error);
      throw new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'Failed to initiate Apple OAuth');
    }
  }

  /**
   * Verifies Apple ID token using token validator.
   * @param {string} idToken - Apple ID token.
   * @param {string} expectedNonce - Expected nonce.
   * @returns {Promise&lt;object>} Token payload.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  async verifyIdToken(idToken, expectedNonce) {
    return this.tokenValidator.verifyIdToken(idToken, expectedNonce);
  }

  /**
   * Exchanges authorization code for tokens.
   * @param {string} code - Authorization code.
   * @returns {Promise&lt;object>} Token data.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  async exchangeCodeForTokens(code) {
    return this.tokenExchanger.exchangeCodeForTokens(code);
  }

  /**
   * Builds user profile from Apple data.
   * @param {object} idTokenPayload - ID token payload.
   * @param {object} userData - User data from Apple.
   * @param {object} tokenData - Token exchange data.
   * @returns {object} User profile.
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  buildUserProfile(idTokenPayload, userData, tokenData) {
    const profile = {
      id: idTokenPayload.sub,
      email: idTokenPayload.email,
      emailVerified: idTokenPayload.email_verified === 'true',
      provider: 'apple',
      privacyCompliant: true,
    };

    // Add user data if available (only on first sign-in)
    if (userData &amp;&amp; userData.name) {
      profile.name = userData.name;
      profile.firstName = userData.name.firstName;
      profile.lastName = userData.name.lastName;
    }

    // Add token information
    if (tokenData) {
      profile.accessToken = tokenData.access_token;
      profile.refreshToken = tokenData.refresh_token;
      profile.tokenType = tokenData.token_type;
      profile.expiresIn = tokenData.expires_in;
    }

    // Privacy-compliant fields
    profile.isPrivateEmail = idTokenPayload.is_private_email === 'true';
    profile.realUserStatus = idTokenPayload.real_user_status;

    return profile;
  }
}

module.exports = { AppleOAuthServiceCore };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdminController.html">AdminController</a></li><li><a href="AmexingAuthMiddleware.html">AmexingAuthMiddleware</a></li><li><a href="AmexingAuthService.html">AmexingAuthService</a></li><li><a href="AmexingUser.html">AmexingUser</a></li><li><a href="ApiController.html">ApiController</a></li><li><a href="AppleIdTokenValidator.html">AppleIdTokenValidator</a></li><li><a href="AppleOAuthService.html">AppleOAuthService</a></li><li><a href="AppleOAuthServiceCore.html">AppleOAuthServiceCore</a></li><li><a href="AppleSignInButton.html">AppleSignInButton</a></li><li><a href="AppleTokenExchanger.html">AppleTokenExchanger</a></li><li><a href="AuthController.html">AuthController</a></li><li><a href="AuthMiddleware.html">AuthMiddleware</a></li><li><a href="AuthenticationService.html">AuthenticationService</a></li><li><a href="AuthenticationServiceCore.html">AuthenticationServiceCore</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="Client.html">Client</a></li><li><a href="ClientController.html">ClientController</a></li><li><a href="CorporateOAuthInterface.html">CorporateOAuthInterface</a></li><li><a href="CorporateOAuthService.html">CorporateOAuthService</a></li><li><a href="CorporateSyncService.html">CorporateSyncService</a></li><li><a href="DashboardAuthMiddleware.html">DashboardAuthMiddleware</a></li><li><a href="DashboardController.html">DashboardController</a></li><li><a href="Department.html">Department</a></li><li><a href="DepartmentManagerController.html">DepartmentManagerController</a></li><li><a href="DepartmentOAuthFlowService.html">DepartmentOAuthFlowService</a></li><li><a href="DriverController.html">DriverController</a></li><li><a href="EmployeeController.html">EmployeeController</a></li><li><a href="GuestController.html">GuestController</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="IntelligentProviderSelector.html">IntelligentProviderSelector</a></li><li><a href="MobileOAuthOptimizer.html">MobileOAuthOptimizer</a></li><li><a href="NotificationsController.html">NotificationsController</a></li><li><a href="OAuthPermissionService.html">OAuthPermissionService</a></li><li><a href="OAuthProvider.html">OAuthProvider</a></li><li><a href="OAuthSecurityValidator.html">OAuthSecurityValidator</a></li><li><a href="OAuthService.html">OAuthService</a></li><li><a href="PermissionAuditService.html">PermissionAuditService</a></li><li><a href="PermissionContextService.html">PermissionContextService</a></li><li><a href="PermissionDelegationService.html">PermissionDelegationService</a></li><li><a href="PermissionInheritanceService.html">PermissionInheritanceService</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RoleBasedController.html">RoleBasedController</a></li><li><a href="SecureSecretsManager.html">SecureSecretsManager</a></li><li><a href="SecurityMiddleware.html">SecurityMiddleware</a></li><li><a href="SuperAdminController.html">SuperAdminController</a></li><li><a href="UserManagementController.html">UserManagementController</a></li><li><a href="global.html#UserManagementService">UserManagementService</a></li><li><a href="ValidationMiddleware.html">ValidationMiddleware</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BaseModel">BaseModel</a></li><li><a href="global.html#Parse">Parse</a></li><li><a href="global.html#about">about</a></li><li><a href="global.html#addCorporateDomain">addCorporateDomain</a></li><li><a href="global.html#authRateLimit">authRateLimit</a></li><li><a href="global.html#authenticateOptional">authenticateOptional</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#autoRefreshToken">autoRefreshToken</a></li><li><a href="global.html#checkUserPermission">checkUserPermission</a></li><li><a href="global.html#createEmergencyElevation">createEmergencyElevation</a></li><li><a href="global.html#createPermissionDelegation">createPermissionDelegation</a></li><li><a href="global.html#createPermissionOverride">createPermissionOverride</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#expressRateLimit">expressRateLimit</a></li><li><a href="global.html#extractUser">extractUser</a></li><li><a href="global.html#findUserById">findUserById</a></li><li><a href="global.html#generateCorporateOAuthURL">generateCorporateOAuthURL</a></li><li><a href="global.html#generateTokens">generateTokens</a></li><li><a href="global.html#getActiveDelegations">getActiveDelegations</a></li><li><a href="global.html#getAllSyncStatuses">getAllSyncStatuses</a></li><li><a href="global.html#getAppleOAuthAnalytics">getAppleOAuthAnalytics</a></li><li><a href="global.html#getAppleOAuthConfig">getAppleOAuthConfig</a></li><li><a href="global.html#getAppleUserData">getAppleUserData</a></li><li><a href="global.html#getAvailableContexts">getAvailableContexts</a></li><li><a href="global.html#getAvailableCorporateDomains">getAvailableCorporateDomains</a></li><li><a href="global.html#getAvailableDepartments">getAvailableDepartments</a></li><li><a href="global.html#getAvailablePermissions">getAvailablePermissions</a></li><li><a href="global.html#getCorporateClientDepartments">getCorporateClientDepartments</a></li><li><a href="global.html#getCorporateLandingConfig">getCorporateLandingConfig</a></li><li><a href="global.html#getCorporateSyncHistory">getCorporateSyncHistory</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDatabaseMetrics">getDatabaseMetrics</a></li><li><a href="global.html#getDelegatedPermissions">getDelegatedPermissions</a></li><li><a href="global.html#getDepartmentOAuthAnalytics">getDepartmentOAuthAnalytics</a></li><li><a href="global.html#getDepartmentOAuthConfig">getDepartmentOAuthConfig</a></li><li><a href="global.html#getDepartmentOAuthProviders">getDepartmentOAuthProviders</a></li><li><a href="global.html#getDepartmentPermissions">getDepartmentPermissions</a></li><li><a href="global.html#getErrorDetails">getErrorDetails</a></li><li><a href="global.html#getOAuthAuditLogs">getOAuthAuditLogs</a></li><li><a href="global.html#getOAuthProviderStatus">getOAuthProviderStatus</a></li><li><a href="global.html#getPermissionAuditReport">getPermissionAuditReport</a></li><li><a href="global.html#getPermissionAuditStats">getPermissionAuditStats</a></li><li><a href="global.html#getProviderDisplayName">getProviderDisplayName</a></li><li><a href="global.html#getRequestProperty">getRequestProperty</a></li><li><a href="global.html#getRolePermissions">getRolePermissions</a></li><li><a href="global.html#getSecretsManager">getSecretsManager</a></li><li><a href="global.html#getStatus">getStatus</a></li><li><a href="global.html#getSystemMetrics">getSystemMetrics</a></li><li><a href="global.html#getUserEffectivePermissions">getUserEffectivePermissions</a></li><li><a href="global.html#getUserPermissionInheritance">getUserPermissionInheritance</a></li><li><a href="global.html#getUserProfile">getUserProfile</a></li><li><a href="global.html#getVersion">getVersion</a></li><li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li><li><a href="global.html#handleAppleOAuthCallback">handleAppleOAuthCallback</a></li><li><a href="global.html#handleAppleWebhook">handleAppleWebhook</a></li><li><a href="global.html#handleDepartmentOAuthCallback">handleDepartmentOAuthCallback</a></li><li><a href="global.html#handleMongoError">handleMongoError</a></li><li><a href="global.html#handleParseError">handleParseError</a></li><li><a href="global.html#handleValidationError">handleValidationError</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#https">https</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initiateAppleOAuth">initiateAppleOAuth</a></li><li><a href="global.html#initiateDepartmentOAuth">initiateDepartmentOAuth</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#loadPrivateKey">loadPrivateKey</a></li><li><a href="global.html#logAccessAttempt">logAccessAttempt</a></li><li><a href="global.html#logDataAccess">logDataAccess</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logSecurityEvent">logSecurityEvent</a></li><li><a href="global.html#logSystemChange">logSystemChange</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#recordSuccessfulLogin">recordSuccessfulLogin</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerCloudFunctions">registerCloudFunctions</a></li><li><a href="global.html#requireRole">requireRole</a></li><li><a href="global.html#revokeAppleOAuth">revokeAppleOAuth</a></li><li><a href="global.html#revokePermissionDelegation">revokePermissionDelegation</a></li><li><a href="global.html#setRequestProperty">setRequestProperty</a></li><li><a href="global.html#showForgotPassword">showForgotPassword</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#showRegister">showRegister</a></li><li><a href="global.html#showResetPassword">showResetPassword</a></li><li><a href="global.html#startPeriodicSync">startPeriodicSync</a></li><li><a href="global.html#stopPeriodicSync">stopPeriodicSync</a></li><li><a href="global.html#switchPermissionContext">switchPermissionContext</a></li><li><a href="global.html#switchToDepartmentContext">switchToDepartmentContext</a></li><li><a href="global.html#testCorporateDomain">testCorporateDomain</a></li><li><a href="global.html#triggerCorporateSync">triggerCorporateSync</a></li><li><a href="global.html#updateUserProfile">updateUserProfile</a></li><li><a href="global.html#validateAppleDomain">validateAppleDomain</a></li><li><a href="global.html#validateCorporateLandingAccess">validateCorporateLandingAccess</a></li><li><a href="global.html#validateDepartmentOAuthAccess">validateDepartmentOAuthAccess</a></li><li><a href="global.html#validateLogin">validateLogin</a></li><li><a href="global.html#validateNewPassword">validateNewPassword</a></li><li><a href="global.html#validatePassword">validatePassword</a></li><li><a href="global.html#validatePasswordReset">validatePasswordReset</a></li><li><a href="global.html#validateRegistration">validateRegistration</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUpdateProfile">validateUpdateProfile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Sep 24 2025 12:14:54 GMT-0600 (hora est√°ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>

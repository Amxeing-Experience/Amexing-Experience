<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: application/middleware/dashboardAuthMiddleware.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: application/middleware/dashboardAuthMiddleware.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const jwt = require('jsonwebtoken');
const logger = require('../../infrastructure/logger');

/**
 * Simplified Dashboard Authentication Middleware
 * Lightweight authentication for EJS dashboard views with role-based routing.
 */
class DashboardAuthMiddleware {
  constructor() {
    this.jwtSecret = process.env.JWT_SECRET || 'your-secret-key';
    this.roleHierarchy = {
      superadmin: 7,
      admin: 6,
      client: 5,
      department_manager: 4,
      employee: 3,
      driver: 2,
      guest: 1,
    };

    // Define role-based dashboard access permissions
    this.dashboardPermissions = {
      superadmin: ['superadmin', 'admin', 'client', 'department_manager', 'employee', 'driver', 'guest'],
      admin: ['admin', 'client', 'department_manager', 'employee', 'driver'],
      client: ['client', 'department_manager', 'employee'],
      department_manager: ['department_manager', 'employee'],
      employee: ['employee'],
      driver: ['driver'],
      guest: ['guest'],
    };
  }

  /**
   * Simple authentication middleware for dashboard routes with guard conditions.
   * @param req
   * @param res
   * @param next
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  requireAuth = (req, res, next) => {
    // Skip authentication for logout requests
    if (req.isLogout) {
      return next();
    }

    // Guard condition: prevent circular redirects to login
    const currentPath = req.path;
    if (currentPath === '/login' || currentPath.startsWith('/auth/') || currentPath === '/logout') {
      return next();
    }

    const accessToken = req.cookies?.accessToken;
    const sessionToken = req.cookies?.sessionToken;

    if (!accessToken &amp;&amp; !sessionToken) {
      return res.redirect(`/login?returnTo=${encodeURIComponent(req.originalUrl)}`);
    }

    // Extract user info from JWT token if available
    let user = {
      id: 'unknown',
      username: 'unknown',
      role: 'guest',
      name: 'Unknown User',
      isActive: true,
    };

    if (accessToken) {
      try {
        const decoded = jwt.verify(accessToken, this.jwtSecret);
        user = {
          id: decoded.userId || 'unknown',
          username: decoded.username || 'unknown',
          role: decoded.role || 'guest',
          name: decoded.username || 'Unknown User',
          isActive: true,
        };
      } catch (error) {
        logger.warn('Invalid JWT token:', error.message);
      }
    }

    // Attach user to request and locals for EJS templates
    req.user = user;
    res.locals.user = user;
    res.locals.userRole = user.role;
    res.locals.userName = user.name || user.username;
    res.locals.userId = user.id;
    res.locals.accessToken = accessToken; // Pass token to templates

    next();
  };

  /**
   * Role-based access control middleware with redirect prevention.
   * @param requiredRole
   * @example
   * // app.use(middlewareName);
   * // Middleware protects routes with validation/authentication
   */
  requireRole = (requiredRole) => (req, res, next) => {
    // Guard condition: prevent redirects during logout
    if (req.isLogout) {
      return next();
    }

    const currentPath = req.path;

    // Guard condition: skip role checks for auth routes
    if (currentPath === '/login' || currentPath.startsWith('/auth/') || currentPath === '/logout') {
      return next();
    }

    if (!req.user) {
      return res.redirect(`/login?returnTo=${encodeURIComponent(req.originalUrl)}`);
    }

    const userRole = req.user.role;
    const userLevel = this.roleHierarchy[userRole] || 0;
    const requiredLevel = this.roleHierarchy[requiredRole] || 0;

    if (userLevel &lt; requiredLevel) {
      logger.warn('Dashboard access denied - insufficient role:', {
        userId: req.user.id,
        userRole,
        requiredRole,
        url: req.originalUrl,
      });

      // Instead of error page, redirect to user's own dashboard to prevent loops
      return res.redirect(`/dashboard/${userRole}`);
    }

    next();
  };

  /**
   * Dashboard-specific role validation with redirect loop prevention.
   * @param req
   * @param res
   * @param next
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  requireDashboardAccess = (req, res, next) => {
    if (!req.user) {
      return res.redirect(`/login?returnTo=${encodeURIComponent(req.originalUrl)}`);
    }

    // Extract requested dashboard role from URL
    const urlParts = req.path.split('/');
    const requestedDashboard = urlParts[2]; // /dashboard/{role}/...

    if (!requestedDashboard) {
      // Root dashboard access - redirect to user's default dashboard
      return res.redirect(`/dashboard/${req.user.role}`);
    }

    const userRole = req.user.role;
    const allowedDashboards = this.dashboardPermissions[userRole] || [];

    // Check if the requested dashboard is valid
    if (!Object.prototype.hasOwnProperty.call(this.roleHierarchy, requestedDashboard)) {
      logger.warn('Invalid dashboard requested - redirecting to user dashboard:', {
        userId: req.user.id,
        userRole,
        requestedDashboard,
      });
      return res.redirect(`/dashboard/${userRole}`);
    }

    // Allow access if user has permission OR if it's their own dashboard
    if (allowedDashboards.includes(requestedDashboard) || requestedDashboard === userRole) {
      next();
    } else {
      logger.warn('Dashboard access denied - redirecting to user dashboard:', {
        userId: req.user.id,
        userRole,
        requestedDashboard,
        allowedDashboards,
      });
      return res.redirect(`/dashboard/${userRole}`);
    }
  };

  /**
   * Optional middleware - inject user context even if not authenticated.
   * @param req
   * @param res
   * @param next
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  injectUserContext = (req, res, next) => {
    const accessToken = req.cookies?.accessToken;

    if (accessToken) {
      try {
        const decoded = jwt.verify(accessToken, this.jwtSecret);
        const user = {
          id: decoded.userId || 'unknown',
          username: decoded.username || 'unknown',
          role: decoded.role || 'guest',
          name: decoded.username || 'Unknown User',
          isActive: true,
        };

        req.user = user;
        res.locals.user = user;
        res.locals.userRole = user.role;
        res.locals.userName = user.name || user.username;
        res.locals.userId = user.id;
        res.locals.isAuthenticated = true;
      } catch (error) {
        res.locals.isAuthenticated = false;
        res.locals.user = null;
      }
    } else {
      res.locals.isAuthenticated = false;
      res.locals.user = null;
    }

    next();
  };

  /**
   * Logout middleware - clear all authentication tokens.
   * @param req
   * @param res
   * @param next
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  logout = (req, res, next) => {
    // Clear authentication cookies with proper options
    res.clearCookie('accessToken', {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'strict',
    });
    res.clearCookie('refreshToken', {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'strict',
    });
    res.clearCookie('sessionToken', {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'strict',
    });

    // Clear user from request/locals immediately
    req.user = null;
    res.locals.user = null;
    res.locals.isAuthenticated = false;

    // Mark this request as a logout to prevent redirects
    req.isLogout = true;

    // Clear session data if exists
    if (req.session) {
      req.session.destroy((err) => {
        if (err) {
          logger.error('Session destruction failed:', err);
        }
        next();
      });
    } else {
      next();
    }
  };

  /**
   * Redirect authenticated users away from auth pages with improved guards.
   * @param req
   * @param res
   * @param next
   * @example
   * // const result = await authService.login(credentials);
   * // Returns: { success: true, user: {...}, tokens: {...} }
   */
  redirectIfAuthenticated = (req, res, next) => {
    // Skip redirect check if this is a logout request
    if (req.isLogout) {
      return next();
    }

    // Guard condition: only apply to login/register pages
    const currentPath = req.path;
    if (currentPath !== '/login' &amp;&amp; currentPath !== '/register' &amp;&amp; !currentPath.startsWith('/auth/')) {
      return next();
    }

    const accessToken = req.cookies?.accessToken;
    const sessionToken = req.cookies?.sessionToken;

    // If no tokens present, allow access to auth pages
    if (!accessToken &amp;&amp; !sessionToken) {
      return next();
    }

    // Simple JWT validation without database calls
    if (accessToken) {
      try {
        const decoded = jwt.verify(accessToken, this.jwtSecret);
        if (decoded &amp;&amp; decoded.role) {
          const returnTo = req.query.returnTo || `/dashboard/${decoded.role}`;
          logger.info('Redirecting authenticated user from auth page:', {
            from: currentPath,
            to: returnTo,
            userRole: decoded.role,
          });
          return res.redirect(returnTo);
        }
      } catch (error) {
        // Invalid token, clear it and allow access to auth pages
        res.clearCookie('accessToken');
        return next();
      }
    }

    // If sessionToken exists but no valid JWT, allow access to auth pages
    next();
  };
}

module.exports = new DashboardAuthMiddleware();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdminController.html">AdminController</a></li><li><a href="AmexingAuthMiddleware.html">AmexingAuthMiddleware</a></li><li><a href="AmexingAuthService.html">AmexingAuthService</a></li><li><a href="AmexingUser.html">AmexingUser</a></li><li><a href="ApiController.html">ApiController</a></li><li><a href="AppleIdTokenValidator.html">AppleIdTokenValidator</a></li><li><a href="AppleOAuthService.html">AppleOAuthService</a></li><li><a href="AppleOAuthServiceCore.html">AppleOAuthServiceCore</a></li><li><a href="AppleSignInButton.html">AppleSignInButton</a></li><li><a href="AppleTokenExchanger.html">AppleTokenExchanger</a></li><li><a href="AuthController.html">AuthController</a></li><li><a href="AuthMiddleware.html">AuthMiddleware</a></li><li><a href="AuthenticationService.html">AuthenticationService</a></li><li><a href="AuthenticationServiceCore.html">AuthenticationServiceCore</a></li><li><a href="BaseController.html">BaseController</a></li><li><a href="Client.html">Client</a></li><li><a href="ClientController.html">ClientController</a></li><li><a href="CorporateOAuthInterface.html">CorporateOAuthInterface</a></li><li><a href="CorporateOAuthService.html">CorporateOAuthService</a></li><li><a href="CorporateSyncService.html">CorporateSyncService</a></li><li><a href="DashboardAuthMiddleware.html">DashboardAuthMiddleware</a></li><li><a href="DashboardController.html">DashboardController</a></li><li><a href="Department.html">Department</a></li><li><a href="DepartmentManagerController.html">DepartmentManagerController</a></li><li><a href="DepartmentOAuthFlowService.html">DepartmentOAuthFlowService</a></li><li><a href="DriverController.html">DriverController</a></li><li><a href="EmployeeController.html">EmployeeController</a></li><li><a href="GuestController.html">GuestController</a></li><li><a href="HomeController.html">HomeController</a></li><li><a href="IntelligentProviderSelector.html">IntelligentProviderSelector</a></li><li><a href="MobileOAuthOptimizer.html">MobileOAuthOptimizer</a></li><li><a href="NotificationsController.html">NotificationsController</a></li><li><a href="OAuthPermissionService.html">OAuthPermissionService</a></li><li><a href="OAuthProvider.html">OAuthProvider</a></li><li><a href="OAuthSecurityValidator.html">OAuthSecurityValidator</a></li><li><a href="OAuthService.html">OAuthService</a></li><li><a href="PermissionAuditService.html">PermissionAuditService</a></li><li><a href="PermissionContextService.html">PermissionContextService</a></li><li><a href="PermissionDelegationService.html">PermissionDelegationService</a></li><li><a href="PermissionInheritanceService.html">PermissionInheritanceService</a></li><li><a href="PermissionService.html">PermissionService</a></li><li><a href="RoleBasedController.html">RoleBasedController</a></li><li><a href="SecureSecretsManager.html">SecureSecretsManager</a></li><li><a href="SecurityMiddleware.html">SecurityMiddleware</a></li><li><a href="SuperAdminController.html">SuperAdminController</a></li><li><a href="UserManagementController.html">UserManagementController</a></li><li><a href="global.html#UserManagementService">UserManagementService</a></li><li><a href="ValidationMiddleware.html">ValidationMiddleware</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BaseModel">BaseModel</a></li><li><a href="global.html#Parse">Parse</a></li><li><a href="global.html#about">about</a></li><li><a href="global.html#addCorporateDomain">addCorporateDomain</a></li><li><a href="global.html#authRateLimit">authRateLimit</a></li><li><a href="global.html#authenticateOptional">authenticateOptional</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#autoRefreshToken">autoRefreshToken</a></li><li><a href="global.html#checkUserPermission">checkUserPermission</a></li><li><a href="global.html#createEmergencyElevation">createEmergencyElevation</a></li><li><a href="global.html#createPermissionDelegation">createPermissionDelegation</a></li><li><a href="global.html#createPermissionOverride">createPermissionOverride</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#expressRateLimit">expressRateLimit</a></li><li><a href="global.html#extractUser">extractUser</a></li><li><a href="global.html#findUserById">findUserById</a></li><li><a href="global.html#generateCorporateOAuthURL">generateCorporateOAuthURL</a></li><li><a href="global.html#generateTokens">generateTokens</a></li><li><a href="global.html#getActiveDelegations">getActiveDelegations</a></li><li><a href="global.html#getAllSyncStatuses">getAllSyncStatuses</a></li><li><a href="global.html#getAppleOAuthAnalytics">getAppleOAuthAnalytics</a></li><li><a href="global.html#getAppleOAuthConfig">getAppleOAuthConfig</a></li><li><a href="global.html#getAppleUserData">getAppleUserData</a></li><li><a href="global.html#getAvailableContexts">getAvailableContexts</a></li><li><a href="global.html#getAvailableCorporateDomains">getAvailableCorporateDomains</a></li><li><a href="global.html#getAvailableDepartments">getAvailableDepartments</a></li><li><a href="global.html#getAvailablePermissions">getAvailablePermissions</a></li><li><a href="global.html#getCorporateClientDepartments">getCorporateClientDepartments</a></li><li><a href="global.html#getCorporateLandingConfig">getCorporateLandingConfig</a></li><li><a href="global.html#getCorporateSyncHistory">getCorporateSyncHistory</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDatabaseMetrics">getDatabaseMetrics</a></li><li><a href="global.html#getDelegatedPermissions">getDelegatedPermissions</a></li><li><a href="global.html#getDepartmentOAuthAnalytics">getDepartmentOAuthAnalytics</a></li><li><a href="global.html#getDepartmentOAuthConfig">getDepartmentOAuthConfig</a></li><li><a href="global.html#getDepartmentOAuthProviders">getDepartmentOAuthProviders</a></li><li><a href="global.html#getDepartmentPermissions">getDepartmentPermissions</a></li><li><a href="global.html#getErrorDetails">getErrorDetails</a></li><li><a href="global.html#getOAuthAuditLogs">getOAuthAuditLogs</a></li><li><a href="global.html#getOAuthProviderStatus">getOAuthProviderStatus</a></li><li><a href="global.html#getPermissionAuditReport">getPermissionAuditReport</a></li><li><a href="global.html#getPermissionAuditStats">getPermissionAuditStats</a></li><li><a href="global.html#getProviderDisplayName">getProviderDisplayName</a></li><li><a href="global.html#getRequestProperty">getRequestProperty</a></li><li><a href="global.html#getRolePermissions">getRolePermissions</a></li><li><a href="global.html#getSecretsManager">getSecretsManager</a></li><li><a href="global.html#getStatus">getStatus</a></li><li><a href="global.html#getSystemMetrics">getSystemMetrics</a></li><li><a href="global.html#getUserEffectivePermissions">getUserEffectivePermissions</a></li><li><a href="global.html#getUserPermissionInheritance">getUserPermissionInheritance</a></li><li><a href="global.html#getUserProfile">getUserProfile</a></li><li><a href="global.html#getVersion">getVersion</a></li><li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li><li><a href="global.html#handleAppleOAuthCallback">handleAppleOAuthCallback</a></li><li><a href="global.html#handleAppleWebhook">handleAppleWebhook</a></li><li><a href="global.html#handleDepartmentOAuthCallback">handleDepartmentOAuthCallback</a></li><li><a href="global.html#handleMongoError">handleMongoError</a></li><li><a href="global.html#handleParseError">handleParseError</a></li><li><a href="global.html#handleValidationError">handleValidationError</a></li><li><a href="global.html#hasPermission">hasPermission</a></li><li><a href="global.html#https">https</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initiateAppleOAuth">initiateAppleOAuth</a></li><li><a href="global.html#initiateDepartmentOAuth">initiateDepartmentOAuth</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#loadPrivateKey">loadPrivateKey</a></li><li><a href="global.html#logAccessAttempt">logAccessAttempt</a></li><li><a href="global.html#logDataAccess">logDataAccess</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logSecurityEvent">logSecurityEvent</a></li><li><a href="global.html#logSystemChange">logSystemChange</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#optionalAuth">optionalAuth</a></li><li><a href="global.html#recordSuccessfulLogin">recordSuccessfulLogin</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#registerCloudFunctions">registerCloudFunctions</a></li><li><a href="global.html#requireRole">requireRole</a></li><li><a href="global.html#revokeAppleOAuth">revokeAppleOAuth</a></li><li><a href="global.html#revokePermissionDelegation">revokePermissionDelegation</a></li><li><a href="global.html#setRequestProperty">setRequestProperty</a></li><li><a href="global.html#showForgotPassword">showForgotPassword</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#showRegister">showRegister</a></li><li><a href="global.html#showResetPassword">showResetPassword</a></li><li><a href="global.html#startPeriodicSync">startPeriodicSync</a></li><li><a href="global.html#stopPeriodicSync">stopPeriodicSync</a></li><li><a href="global.html#switchPermissionContext">switchPermissionContext</a></li><li><a href="global.html#switchToDepartmentContext">switchToDepartmentContext</a></li><li><a href="global.html#testCorporateDomain">testCorporateDomain</a></li><li><a href="global.html#triggerCorporateSync">triggerCorporateSync</a></li><li><a href="global.html#updateUserProfile">updateUserProfile</a></li><li><a href="global.html#validateAppleDomain">validateAppleDomain</a></li><li><a href="global.html#validateCorporateLandingAccess">validateCorporateLandingAccess</a></li><li><a href="global.html#validateDepartmentOAuthAccess">validateDepartmentOAuthAccess</a></li><li><a href="global.html#validateLogin">validateLogin</a></li><li><a href="global.html#validateNewPassword">validateNewPassword</a></li><li><a href="global.html#validatePassword">validatePassword</a></li><li><a href="global.html#validatePasswordReset">validatePasswordReset</a></li><li><a href="global.html#validateRegistration">validateRegistration</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUpdateProfile">validateUpdateProfile</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Sep 24 2025 12:14:54 GMT-0600 (hora est√°ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>

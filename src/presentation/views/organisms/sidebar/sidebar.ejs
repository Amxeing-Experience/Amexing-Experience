<%
/**
 * Dynamic Sidebar Organism
 * Role-based navigation component with responsive design
 *
 * @param {string} userRole - Current user role
 * @param {string} currentPath - Current page path for active states
 */

const sidebarUserRole = typeof userRole !== 'undefined' ? userRole : 'guest';
const sidebarCurrentPath = typeof currentPath !== 'undefined' ? currentPath : '';

// Navigation items based on role
const navigationItems = {
    superadmin: [
        { name: 'Dashboard', icon: 'ti-dashboard', path: '/dashboard/superadmin', id: 'dashboard' },
        { name: 'Usuarios', icon: 'ti-users', path: '/dashboard/superadmin/users', id: 'users' },
        { name: 'Clientes', icon: 'ti-building', path: '/dashboard/superadmin/clients', id: 'clients' },
        { name: 'Permisos', icon: 'ti-key', path: '/dashboard/superadmin/permissions', id: 'permissions' },
        { name: 'Analytics', icon: 'ti-chart-bar', path: '/dashboard/superadmin/analytics', id: 'analytics' },
        { name: 'Reportes', icon: 'ti-report', path: '/dashboard/superadmin/reports', id: 'reports' },
        { name: 'Auditor铆a', icon: 'ti-shield-check', path: '/dashboard/superadmin/audit', id: 'audit' },
        { name: 'Configuraci贸n', icon: 'ti-settings', path: '/dashboard/superadmin/settings', id: 'settings' },
        { name: 'Integraciones', icon: 'ti-plug', path: '/dashboard/superadmin/integrations', id: 'integrations' },
        { name: 'Seguridad', icon: 'ti-shield-lock', path: '/dashboard/superadmin/security', id: 'security' },
        { name: 'Compliance', icon: 'ti-checklist', path: '/dashboard/superadmin/compliance', id: 'compliance' }
    ],
    admin: [
        { name: 'Dashboard', icon: 'ti-dashboard', path: '/dashboard/admin', id: 'dashboard' },
        { name: 'Eventos', icon: 'ti-calendar-event', path: '/dashboard/admin/events', id: 'events' },
        { name: 'Clientes', icon: 'ti-users', path: '/dashboard/admin/clients', id: 'clients' },
        { name: 'Reservaciones', icon: 'ti-car', path: '/dashboard/admin/bookings', id: 'bookings' },
        { name: 'Veh铆culos', icon: 'ti-car-garage', path: '/dashboard/admin/vehicles', id: 'vehicles' },
        { name: 'Conductores', icon: 'ti-user-check', path: '/dashboard/admin/drivers', id: 'drivers' },
        { name: 'Calendario', icon: 'ti-calendar', path: '/dashboard/admin/schedule', id: 'schedule' },
        { name: 'Reportes', icon: 'ti-report', path: '/dashboard/admin/reports', id: 'reports' }
    ],
    client: [
        { name: 'Mi Dashboard', icon: 'ti-dashboard', path: '/dashboard/client', id: 'dashboard' },
        { name: 'Mis Eventos', icon: 'ti-calendar-event', path: '/dashboard/client/events', id: 'events' },
        { name: 'Landing Pages', icon: 'ti-world', path: '/dashboard/client/landing-pages', id: 'landing-pages' },
        { name: 'Reservaciones', icon: 'ti-car', path: '/dashboard/client/bookings', id: 'bookings' },
        { name: 'Servicios', icon: 'ti-list', path: '/dashboard/client/services', id: 'services' },
        { name: 'Facturaci贸n', icon: 'ti-receipt', path: '/dashboard/client/billing', id: 'billing' }
    ],
    department_manager: [
        { name: 'Dashboard', icon: 'ti-dashboard', path: '/dashboard/department-manager', id: 'dashboard' },
        { name: 'Mi Equipo', icon: 'ti-users', path: '/dashboard/department-manager/team', id: 'team' },
        { name: 'Reservaciones', icon: 'ti-car', path: '/dashboard/department-manager/bookings', id: 'bookings' },
        { name: 'Aprobaciones', icon: 'ti-check', path: '/dashboard/department-manager/approvals', id: 'approvals' },
        { name: 'Presupuesto', icon: 'ti-coin', path: '/dashboard/department-manager/budget', id: 'budget' },
        { name: 'Reportes', icon: 'ti-report', path: '/dashboard/department-manager/reports', id: 'reports' }
    ],
    employee: [
        { name: 'Dashboard', icon: 'ti-dashboard', path: '/dashboard/employee', id: 'dashboard' },
        { name: 'Mis Reservaciones', icon: 'ti-car', path: '/dashboard/employee/bookings', id: 'bookings' },
        { name: 'Servicios', icon: 'ti-list', path: '/dashboard/employee/services', id: 'services' },
        { name: 'Mi Perfil', icon: 'ti-user', path: '/dashboard/employee/profile', id: 'profile' }
    ],
    driver: [
        { name: 'Dashboard', icon: 'ti-dashboard', path: '/dashboard/driver', id: 'dashboard' },
        { name: 'Mis Viajes', icon: 'ti-route', path: '/dashboard/driver/trips', id: 'trips' },
        { name: 'Calendario', icon: 'ti-calendar', path: '/dashboard/driver/schedule', id: 'schedule' },
        { name: 'Mi Veh铆culo', icon: 'ti-car', path: '/dashboard/driver/vehicle', id: 'vehicle' },
        { name: 'Historial', icon: 'ti-history', path: '/dashboard/driver/history', id: 'history' }
    ],
    guest: [
        { name: 'Inicio', icon: 'ti-home', path: '/', id: 'home' }
    ]
};

const menuItems = navigationItems[sidebarUserRole] || navigationItems.guest;

// Helper function to determine if menu item is active
function isActiveMenuItem(itemPath, currentPath) {
    if (itemPath === currentPath) return true;
    if (currentPath.startsWith(itemPath) && itemPath !== '/') return true;
    return false;
}

// Role-based branding colors
const roleColors = {
    superadmin: { primary: '#ff6b6b', secondary: '#4ecdc4' },
    admin: { primary: '#5d87ff', secondary: '#49beff' },
    client: { primary: '#8b5cf6', secondary: '#ec4899' },
    department_manager: { primary: '#10b981', secondary: '#3b82f6' },
    employee: { primary: '#06b6d4', secondary: '#8b5cf6' },
    driver: { primary: '#f59e0b', secondary: '#ef4444' },
    guest: { primary: '#6b7280', secondary: '#9ca3af' }
};

const colors = roleColors[sidebarUserRole] || roleColors.guest;
%>

<!-- Sidebar Start -->
<aside class="left-sidebar">
    <!-- Sidebar scroll-->
    <div>
        <div class="brand-logo d-flex align-items-center justify-content-between p-3">
            <a href="/dashboard/<%= sidebarUserRole %>" class="text-nowrap brand-logo-link">
                <img src="/dashboard/images/logos/amexing-logo.svg" width="140" alt="Amexing Logo" class="img-fluid" />
            </a>
            <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                <i class="ti ti-x fs-8"></i>
            </div>
        </div>

        <!-- Role Badge -->
        <div class="px-3 pb-3">
            <div class="badge-role p-2 rounded-3 text-center" style="background: linear-gradient(135deg, <%= colors.primary %>, <%= colors.secondary %>);">
                <small class="text-white fw-bold text-uppercase">
                    <% if (sidebarUserRole === 'department_manager') { %>
                        Jefe de Departamento
                    <% } else if (sidebarUserRole === 'superadmin') { %>
                        Super Administrador
                    <% } else { %>
                        <%= sidebarUserRole.charAt(0).toUpperCase() + sidebarUserRole.slice(1) %>
                    <% } %>
                </small>
            </div>
        </div>

        <!-- Sidebar navigation-->
        <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
            <ul id="sidebarnav" class="list-unstyled">
                <% menuItems.forEach(function(item, index) { %>
                    <% const isActive = isActiveMenuItem(item.path, sidebarCurrentPath); %>
                    <li class="nav-small-cap">
                        <% if (index === 0) { %>
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">Principal</span>
                        <% } else if (index === Math.floor(menuItems.length / 2)) { %>
                            <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">Gesti贸n</span>
                        <% } %>
                    </li>

                    <li class="sidebar-item <%= isActive ? 'selected' : '' %>">
                        <a class="sidebar-link <%= isActive ? 'active' : '' %>"
                           href="<%= item.path %>"
                           aria-expanded="false"
                           data-menu-id="<%= item.id %>">
                            <span>
                                <i class="<%= item.icon %>"></i>
                            </span>
                            <span class="hide-menu"><%= item.name %></span>
                            <% if (item.badge) { %>
                                <span class="badge bg-<%= item.badge.color %> ms-auto"><%= item.badge.text %></span>
                            <% } %>
                        </a>

                        <% if (item.submenu) { %>
                            <ul aria-expanded="false" class="collapse first-level">
                                <% item.submenu.forEach(function(subitem) { %>
                                    <% const isSubActive = isActiveMenuItem(subitem.path, sidebarCurrentPath); %>
                                    <li class="sidebar-item <%= isSubActive ? 'selected' : '' %>">
                                        <a href="<%= subitem.path %>" class="sidebar-link <%= isSubActive ? 'active' : '' %>">
                                            <div class="round-16 d-flex align-items-center justify-content-center">
                                                <i class="ti ti-circle"></i>
                                            </div>
                                            <span class="hide-menu"><%= subitem.name %></span>
                                        </a>
                                    </li>
                                <% }); %>
                            </ul>
                        <% } %>
                    </li>
                <% }); %>

                <!-- Special sections for certain roles -->
                <% if (['superadmin', 'admin'].includes(sidebarUserRole)) { %>
                    <li class="nav-small-cap">
                        <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                        <span class="hide-menu">Sistema</span>
                    </li>

                    <li class="sidebar-item">
                        <a class="sidebar-link" href="/api/docs" target="_blank">
                            <span>
                                <i class="ti ti-api"></i>
                            </span>
                            <span class="hide-menu">API Docs</span>
                            <i class="ti ti-external-link ms-auto"></i>
                        </a>
                    </li>

                    <li class="sidebar-item">
                        <a class="sidebar-link" href="/dashboard/system/health">
                            <span>
                                <i class="ti ti-heart"></i>
                            </span>
                            <span class="hide-menu">System Health</span>
                            <span class="badge bg-success ms-auto">
                                <i class="ti ti-circle-filled"></i>
                            </span>
                        </a>
                    </li>
                <% } %>

                <!-- User section at bottom -->
                <li class="nav-small-cap mt-4">
                    <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                    <span class="hide-menu">Usuario</span>
                </li>

                <li class="sidebar-item">
                    <a class="sidebar-link" href="/dashboard/<%= sidebarUserRole %>/profile">
                        <span>
                            <i class="ti ti-user"></i>
                        </span>
                        <span class="hide-menu">Mi Perfil</span>
                    </a>
                </li>

                <li class="sidebar-item">
                    <a class="sidebar-link" href="/dashboard/<%= sidebarUserRole %>/settings">
                        <span>
                            <i class="ti ti-settings"></i>
                        </span>
                        <span class="hide-menu">Configuraci贸n</span>
                    </a>
                </li>

                <li class="sidebar-item">
                    <a class="sidebar-link" href="/auth/logout" data-confirm="驴Cerrar sesi贸n?">
                        <span>
                            <i class="ti ti-logout"></i>
                        </span>
                        <span class="hide-menu">Cerrar Sesi贸n</span>
                    </a>
                </li>
            </ul>

            <!-- Footer info -->
            <div class="sidebar-footer mt-4 p-3">
                <div class="d-flex align-items-center">
                    <div class="me-2">
                        <div class="round-20 d-flex align-items-center justify-content-center"
                             style="background: <%= colors.primary %>20; color: <%= colors.primary %>;">
                            <i class="ti ti-info-circle"></i>
                        </div>
                    </div>
                    <div>
                        <small class="text-muted d-block">Amexing v1.0</small>
                        <small class="text-muted">漏 2024 Meeplab</small>
                    </div>
                </div>
            </div>
        </nav>
        <!-- End Sidebar navigation -->
    </div>
    <!-- End Sidebar scroll-->
</aside>
<!-- Sidebar End -->

<style>
    /* Role-specific sidebar styling - Enhanced with Flexy */
    .left-sidebar {
        background: #fff;
        border-right: 1px solid #e0e6ed;
        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .brand-logo-link {
        text-decoration: none;
        transition: opacity 0.3s ease;
    }

    .brand-logo-link:hover {
        opacity: 0.8;
    }

    .badge-role {
        background: linear-gradient(135deg, <%= colors.primary %>, <%= colors.secondary %>) !important;
        color: white !important;
        border: none;
        box-shadow: 0 4px 15px rgba(93, 135, 255, 0.2);
        border-radius: 8px;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .sidebar-nav .sidebar-item.selected .sidebar-link,
    .sidebar-nav .sidebar-item .sidebar-link.active {
        background: linear-gradient(135deg, <%= colors.primary %>10, <%= colors.secondary %>10);
        color: <%= colors.primary %>;
        border-radius: 0 50px 50px 0;
        margin-right: 10px;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(93, 135, 255, 0.15);
    }

    .sidebar-nav .sidebar-item .sidebar-link:hover {
        background: linear-gradient(135deg, <%= colors.primary %>08, <%= colors.secondary %>08);
        color: <%= colors.primary %>;
        border-radius: 0 25px 25px 0;
        margin-right: 15px;
        transform: translateX(5px);
        transition: all 0.3s ease;
    }

    .sidebar-nav .nav-small-cap {
        color: #6c757d;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.6875rem;
        letter-spacing: 1px;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
        padding: 0 20px;
    }

    .sidebar-nav .nav-small-cap .nav-small-cap-icon {
        color: <%= colors.primary %>;
        margin-right: 8px;
    }

    .sidebar-footer {
        border-top: 1px solid #e0e6ed;
        margin-top: auto;
        background: linear-gradient(135deg, #fafbfe, #f8f9fb);
        border-radius: 12px 12px 0 0;
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .left-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1050;
        }

        .left-sidebar.show {
            transform: translateX(0);
        }

        .close-btn {
            display: block !important;
        }
    }

    /* Custom scrollbar for sidebar */
    .scroll-sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .scroll-sidebar::-webkit-scrollbar-track {
        background: transparent;
    }

    .scroll-sidebar::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.1);
        border-radius: 3px;
    }

    .scroll-sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.2);
    }
</style>

<script>
// Sidebar specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Handle confirmation dialogs for logout
    document.querySelectorAll('[data-confirm]').forEach(function(element) {
        element.addEventListener('click', function(e) {
            const message = this.dataset.confirm;
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });

    // Track active menu item
    const currentPath = '<%= sidebarCurrentPath %>';
    const currentRole = '<%= sidebarUserRole %>';

    console.log(' Sidebar initialized for role:', currentRole);
    console.log(' Current path:', currentPath);

    // Add active states based on current path
    document.querySelectorAll('.sidebar-link').forEach(function(link) {
        const href = link.getAttribute('href');
        if (href === currentPath || (currentPath.startsWith(href) && href !== '/')) {
            link.classList.add('active');
            link.closest('.sidebar-item').classList.add('selected');
        }
    });
});
</script>
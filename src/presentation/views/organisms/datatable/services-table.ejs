<%
/**
 * Service DataTable Organism
 * DataTable component for transportation service management
 *
 * Atomic Design Level: Organism
 * Category: Dashboard Data Tables
 *
 * @param {string} tableId - Unique table identifier
 * @param {string} apiEndpoint - API endpoint for data loading
 * @param {string} userRole - Current user role
 * @param {boolean} showActions - Whether to show action buttons
 */

const dtTableId = typeof tableId !== 'undefined' ? tableId : 'services-table';
const dtApiEndpoint = typeof apiEndpoint !== 'undefined' ? apiEndpoint : '/api/services';
const dtShowActions = typeof showActions !== 'undefined' ? showActions : true;
const dtUserRole = typeof userRole !== 'undefined' ? userRole : 'admin';
const dtShowClientPricing = typeof showClientPricing !== 'undefined' ? showClientPricing : false;

const canEdit = ['superadmin', 'admin'].includes(dtUserRole);
const canDelete = ['superadmin', 'admin'].includes(dtUserRole);
const canCreate = ['superadmin', 'admin'].includes(dtUserRole);
const isDepartmentManager = dtUserRole === 'department_manager';
%>

<style>
/* Hide default DataTables sorting icons */
.dt-control::before,
.dt-control::after {
    display: none !important;
}

/* Custom styling for price column */
.price-expand-container {
    text-align: left;
}

/* Hide any default sorting indicators */
table.dataTable thead .sorting::before,
table.dataTable thead .sorting::after,
table.dataTable thead .sorting_asc::before,
table.dataTable thead .sorting_asc::after,
table.dataTable thead .sorting_desc::before,
table.dataTable thead .sorting_desc::after {
    display: none !important;
}

/* Ensure only our button shows */
td.dt-control {
    position: relative;
}

/* Remove DataTables default row hover effect */
table.dataTable tbody tr:hover,
table.dataTable tbody tr.hover {
    background-color: transparent !important;
}

/* Add hover effect specifically to expand button */
.expand-btn:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
    border-radius: 4px !important;
    transform: scale(1.05);
    transition: all 0.2s ease;
}

.expand-btn:hover i,
.expand-btn:hover small {
    color: #0d6efd !important;
}

/* Smooth transition for expand button */
.expand-btn {
    transition: all 0.2s ease;
}

/* Custom styling for nav pills with borders */
.nav-pills .nav-link {
    border: 1px solid #dee2e6;
    color: #6c757d;
    background-color: transparent;
    margin-right: 0.25rem;
    transition: all 0.2s ease;
}

.nav-pills .nav-link:hover {
    border-color: #10b981;
    color: #10b981;
    background-color: rgba(16, 185, 129, 0.1);
}

.nav-pills .nav-link.active {
    border-color: #10b981;
    background-color: #10b981;
    color: white;
}

/* Price column styling */
.price-container {
    text-align: left;
}

.price-container .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.4rem;
}

.price-container .small {
    margin-bottom: 0.2rem;
}

/* Make dropdown clickable in header */
[id^="headerRateFilter-"] {
    pointer-events: all !important;
    z-index: 1000;
    position: relative;
    width: 100% !important;
}

/* Prevent DataTables from interfering with dropdown container */
table.dataTable thead th:nth-child(2) div {
    pointer-events: none;
}

table.dataTable thead th:nth-child(2) select {
    pointer-events: all !important;
}
</style>

<div class="card border-0 shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="card-title mb-0 text-white">
                    Traslados
                </h5>
            </div>
            <div class="col-auto">
                <% if (canCreate) { %>
                    <button type="button" class="btn btn-light btn-sm" id="createServiceBtn">
                        <i class="ti ti-plus me-1"></i>Nuevo Traslado
                    </button>
                <% } %>
            </div>
        </div>
    </div>

    <div class="card-body" id="services-content">
        <!-- Filter Controls -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Leading Pills (Segmented Control) -->
            <ul class="nav nav-pills" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active filter-pill" data-filter="airport" type="button" role="tab">
                        Aeropuerto
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link filter-pill" data-filter="p2p" type="button" role="tab">
                        Punto a Punto
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link filter-pill" data-filter="local" type="button" role="tab">
                        Local
                    </button>
                </li>
            </ul>

            <!-- Trailing Dropdowns -->
            <div class="d-flex gap-2 align-items-center">

                <!-- Currency Dropdown -->
                <div class="d-flex align-items-center gap-1">
                    <label for="currencyFilter-<%= dtTableId %>" class="form-label mb-0 text-muted">Moneda:</label>
                    <select class="form-select" id="currencyFilter-<%= dtTableId %>" style="min-width: 100px;">
                        <option value="MXN" selected>MXN</option>
                        <option value="USD">USD</option>
                    </select>
                </div>

                <!-- Payment Type Dropdown -->
                <div class="d-flex align-items-center gap-1">
                    <label for="paymentTypeFilter-<%= dtTableId %>" class="form-label mb-0 text-muted">Pago:</label>
                    <select class="form-select" id="paymentTypeFilter-<%= dtTableId %>" style="min-width: 140px;">
                        <option value="efectivo" selected>Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <% if (!isDepartmentManager) { %>
                        <option value="transf_agencias">Transf. Agencias</option>
                        <% } %>
                    </select>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="<%= dtTableId %>" class="table table-hover" style="width:100%">
                <thead class="table-light">
                    <tr>
                        <th style="width: 25%;">Ruta (One-way trip)</th>
                        <th style="width: 30%; min-width: 250px;">
                            <div class="text-center mb-1" style="font-size: 0.875rem; font-weight: 500;">
                                Seleccionar categor√≠a...
                            </div>
                            <select class="form-select" id="headerRateFilter-<%= dtTableId %>" style="min-width: 120px; width: 100%;">
                            </select>
                        </th>
                        <th style="width: 30%;">Notas</th>
                        <th style="width: 15%;">Estado</th>
                        <% if (dtShowClientPricing) { %>
                            <th class="text-center" style="width: 15%;">Precio Cliente</th>
                        <% } %>
                        <% if (dtShowActions) { %>
                            <th class="text-center" style="width: 15%;">Acciones</th>
                        <% } %>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Service Modal -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-white" id="serviceModalLabel">
                    <i class="ti ti-briefcase me-2"></i><span id="modalTitle">Crear Nuevo Traslado</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Alert container for modal-specific errors -->
                <div id="serviceModalAlerts"></div>

                <form id="serviceForm">
                    <input type="hidden" id="serviceId">

                    <!-- Secci√≥n: Informaci√≥n de Ruta -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-route me-1"></i>
                            Informaci√≥n de Ruta
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <%- include('../../atoms/common/tom-select', {
                                    id: 'originPOI',
                                    name: 'originPOI',
                                    multiple: false,
                                    placeholder: 'Sin origen (traslado local)',
                                    label: 'Origen',
                                    required: false,
                                    helpText: 'Punto de inicio (opcional para traslados locales)',
                                    options: [],
                                    selected: []
                                }) %>
                            </div>

                            <div class="col-md-6 mb-3">
                                <%- include('../../atoms/common/tom-select', {
                                    id: 'destinationPOI',
                                    name: 'destinationPOI',
                                    multiple: false,
                                    placeholder: 'Seleccionar destino',
                                    label: 'Destino',
                                    required: true,
                                    helpText: 'Punto final del traslado',
                                    options: [],
                                    selected: []
                                }) %>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n: Informaci√≥n del Veh√≠culo y Tarifa -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-car me-1"></i>
                            Informaci√≥n del Veh√≠culo y Tarifa
                        </h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vehicleType" class="form-label">Tipo de Veh√≠culo <span class="text-danger">*</span></label>
                                <select class="form-select" id="vehicleType" name="vehicleType" required>
                                    <option value="">Seleccionar tipo de veh√≠culo</option>
                                </select>
                                <div class="form-text">Tipo de veh√≠culo asignado para esta ruta</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="rate" class="form-label">Tarifa <span class="text-danger">*</span></label>
                                <select class="form-select" id="rate" name="rate" required>
                                    <option value="">Seleccionar tarifa</option>
                                </select>
                                <div class="form-text">Tarifa aplicable a este traslado</div>
                            </div>
                        </div>
                    </div>


                    <!-- Secci√≥n: Notas Adicionales -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-3">
                            <i class="ti ti-notes me-1"></i>
                            Notas Adicionales
                        </h6>

                        <div class="mb-3">
                            <label for="note" class="form-label">Nota</label>
                            <textarea class="form-control" id="note" name="note" rows="3" maxlength="500" placeholder="Notas adicionales sobre el traslado..."></textarea>
                            <div class="form-text">M√°ximo 500 caracteres (opcional)</div>
                        </div>
                    </div>

                    <!-- Alert informativo -->
                    <div class="alert alert-info d-flex align-items-start" role="alert">
                        <i class="ti ti-info-circle me-2 fs-5 mt-1"></i>
                        <div>
                            <strong>Traslado:</strong>
                            <p class="mb-0 mt-1">Define una ruta espec√≠fica con origen, destino, tipo de veh√≠culo y precio. Este traslado estar√° disponible para reservaciones una vez activado.</p>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="saveServiceBtn">
                    <i class="ti ti-check me-1"></i><span id="saveButtonText">Crear Traslado</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Wait for DOM and all dependencies to be ready
    function initWhenReady() {
        // Check if jQuery and DataTables are loaded
        if (typeof jQuery === 'undefined') {
            console.warn('jQuery not loaded yet, waiting...');
            setTimeout(initWhenReady, 100);
            return;
        }

        if (!jQuery.fn.dataTable) {
            console.warn('DataTables not loaded yet, waiting...');
            setTimeout(initWhenReady, 100);
            return;
        }

        initServicesTable();
    }

    function initServicesTable() {
        const tableId = '<%= dtTableId %>';
        const apiEndpoint = '<%= dtApiEndpoint %>';
        const showActions = <%= dtShowActions %>;
        const showClientPricing = <%= dtShowClientPricing %>;
        const canEdit = <%= canEdit %>;
        const canDelete = <%= canDelete %>;
        const userRole = '<%= dtUserRole %>';

        // Get JWT token from localStorage or cookies
        function getAccessToken() {
            // First try localStorage (used by other parts of the app)
            const tokenFromStorage = localStorage.getItem('accessToken');
            if (tokenFromStorage) {
                return tokenFromStorage;
            }
            
            // Fallback to cookies (httpOnly cookies won't work, but try anyway)
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'accessToken') {
                    return value;
                }
            }
            return null;
        }

        // Setup global AJAX configuration to include JWT token
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = getAccessToken();
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                }
            }
        });

        // Load dropdown data
        let poisData = [];
        let vehicleTypesData = [];
        let ratesData = [];

        // Color contrast functions for rate badges (from rates-table.ejs)
        function getLuminance(hex) {
            // WCAG 2.0 luminance calculation
            const rgb = parseInt(hex.slice(1), 16);
            const r = (rgb >> 16) & 0xff;
            const g = (rgb >> 8) & 0xff;
            const b = (rgb >> 0) & 0xff;

            const [rsRGB, gsRGB, bsRGB] = [r/255, g/255, b/255].map(val => {
                return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
            });

            return 0.2126 * rsRGB + 0.7152 * gsRGB + 0.0722 * bsRGB;
        }

        function getContrastTextColor(backgroundColor) {
            const luminance = getLuminance(backgroundColor);
            return luminance > 0.5 ? '#1F2937' : '#FFFFFF';
        }

        // Load all data once
        let allServicesData = [];
        let filteredData = [];

        // Load data from API
        function loadAllServices() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: apiEndpoint,
                    type: 'GET',
                    success: function(response) {
                        if (response.success && response.data) {
                            allServicesData = response.data;
                            
                            // Debug: Log all service types
                            console.log('All services loaded:', allServicesData.length);
                            
                            const serviceTypeCounts = {};
                            allServicesData.forEach(service => {
                                const type = service.destinationPOI?.serviceType?.name || 'Unknown';
                                serviceTypeCounts[type] = (serviceTypeCounts[type] || 0) + 1;
                            });
                            console.log('Service type counts:', serviceTypeCounts);
                            
                            // Filter to show airport services by default
                            filteredData = filterServicesByType('airport');
                            resolve(allServicesData);
                        } else {
                            reject('Invalid response format');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading services:', error);
                        reject('Error loading services');
                    }
                });
            });
        }

        // Filter services by type based on destination POI service type
        function filterServicesByType(type) {
            // Filter services by type
            
            if (type === 'all') {
                return allServicesData;
            }
            
            const filtered = allServicesData.filter(service => {
                // Get service type from destination POI
                const destinationPOI = service.destinationPOI;
                if (!destinationPOI) {
                    console.log(`‚ùå Service ${service.id} has no destinationPOI`);
                    return false;
                }
                
                const serviceType = destinationPOI.serviceType?.name;
                
                // Check service type match
                
                let matches = false;
                switch(type) {
                    case 'airport':
                        matches = serviceType === 'Aeropuerto';
                        break;
                    case 'p2p':
                        matches = serviceType === 'Punto a Punto';
                        break;
                    case 'local':
                        matches = serviceType === 'Local';
                        break;
                    default:
                        matches = true;
                }
                
                // Log result if needed for debugging
                return matches;
            });
            
            // Return filtered results
            return filtered;
        }

        // DataTable Configuration (Client-side)
        const dataTable = $(`#${tableId}`).DataTable({
            processing: true,
            serverSide: false, // Changed to client-side
            data: [], // Will be populated after data loads
            columns: [
                // 1. Ruta (Origin ‚Üí Destination)
                {
                    data: null,
                    render: function(data, type, row) {
                        const origin = row.originPOI?.name || null;
                        const destination = row.destinationPOI?.name || 'Destino';
                        
                        if (type === 'filter' || type === 'sort') {
                            return `${origin || 'Local'} ${destination}`;
                        }
                        
                        // Check if this is a local service (no origin or origin is null/empty)
                        if (!origin || origin === 'Sin origen') {
                            // For services without specific origin (like local services)
                            return `
                                <div class="d-flex flex-column">
                                    <div class="fw-semibold text-center" style="font-size: 0.85rem;">
                                        ${destination}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Show bidirectional route for services with both origin and destination
                        return `
                            <div class="d-flex flex-column">
                                <div class="fw-semibold text-center" style="font-size: 0.85rem;">
                                    ${origin}
                                </div>
                                <div class="text-center my-1">
                                    <span class="text-muted" style="font-size: 1.2rem;" title="Ruta bidireccional">‚Üî</span>
                                </div>
                                <div class="fw-semibold text-center" style="font-size: 0.85rem;">
                                    ${destination}
                                </div>
                            </div>
                        `;
                    }
                },
                // 2. Precio (based on selected rate from header dropdown)
                {
                    data: null,
                    render: function(data, type, row) {
                        const selectedRate = $(`#headerRateFilter-${tableId}`).val();
                        const selectedRateText = $(`#headerRateFilter-${tableId} option:selected`).text();
                        
                        // Check if we have price data for the selected rate
                        if (row.priceData && row.priceData.length > 0) {
                            // Show ALL vehicle types for selected rate (no limit) with enhanced card design
                            // Sort prices from low to high
                            const sortedPrices = [...row.priceData].sort((a, b) => (a.price || 0) - (b.price || 0));
                            let pricesHtml = sortedPrices.map(p => {
                                // Get capacity info from price data
                                const defaultCapacity = p.vehicleType?.defaultCapacity || 4;
                                const trunkCapacity = p.vehicleType?.trunkCapacity || 2;
                                const vehicleName = p.vehicleType?.name || p.vehicleCode;
                                const price = p.formattedPrice;
                                
                                return `
                                    <div class="price-item-card p-2 mb-2 border rounded bg-white" style="border-left: 3px solid #6c757d;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <div class="fw-semibold small text-dark">${vehicleName}</div>
                                                <div class="text-muted d-flex align-items-center gap-2" style="font-size: 0.7rem;">
                                                    <span>${defaultCapacity} <i class="ti ti-user"></i></span>
                                                    <span>${trunkCapacity} <i class="ti ti-briefcase"></i></span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div class="fw-bold text-primary small" data-original-price="${price}">${price}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            // Always show "Ver todos" button to see other rates
                            const expandButton = `
                                <button class="btn btn-link btn-sm p-0 mt-1 expand-prices-btn" 
                                        data-row-id="${row.id || row.objectId}"
                                        style="font-size: 0.75rem; text-decoration: none;">
                                    <i class="ti ti-chevron-down me-1"></i>
                                    Ver todos
                                </button>`;
                            
                            return `<div class="price-container" data-row-id="${row.id || row.objectId}">
                                        <div class="small text-primary fw-semibold mb-1">${selectedRateText}</div>
                                        <div class="prices-list">
                                            ${pricesHtml}
                                        </div>
                                        ${expandButton}
                                    </div>`;
                        } else if (selectedRate) {
                            // Selected rate but no prices for this service
                            const expandButton = `
                                <button class="btn btn-link btn-sm p-0 mt-1 expand-prices-btn" 
                                        data-row-id="${row.id || row.objectId}"
                                        style="font-size: 0.75rem; text-decoration: none;">
                                    <i class="ti ti-chevron-down me-1"></i>
                                    Ver todos
                                </button>`;
                                
                            return `<div class="price-container" data-row-id="${row.id || row.objectId}">
                                        <div class="small text-muted mb-1">Sin precios para ${selectedRateText}</div>
                                        ${expandButton}
                                    </div>`;
                        } else {
                            return '<span class="text-muted">Seleccionar tarifa</span>';
                        }
                    },
                    className: 'price-column'
                },
                // 3. Notas
                {
                    data: 'note',
                    render: function(data) {
                        if (!data) return '<span class="text-muted">-</span>';
                        const truncated = data.length > 50 ? data.substring(0, 50) + '...' : data;
                        return `<div class="small" title="${data}">${truncated}</div>`;
                    }
                },
                // 4. Estado
                {
                    data: 'active',
                    render: function(data) {
                        return data
                            ? '<span class="badge bg-success">Activo</span>'
                            : '<span class="badge bg-secondary">Inactivo</span>';
                    }
                },
                ...(showActions ? [{
                    data: null,
                    orderable: false,
                    searchable: false,
                    className: 'text-center',
                    render: function(data) {
                        let actions = '<div class="btn-group btn-group-sm" role="group">';

                        if (canEdit) {
                            // Edit button
                            actions += `<button type="button"
                                            class="btn btn-primary edit-service-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Editar Traslado">
                                            <i class="ti ti-edit"></i>
                                        </button>`;

                            // Toggle status button - usar iconos m√°s descriptivos
                            const statusIcon = data.active ? 'ti-archive' : 'ti-archive-off';
                            const statusTitle = data.active ? 'Desactivar Traslado' : 'Activar Traslado';
                            const statusClass = data.active ? 'btn-warning' : 'btn-success';

                            actions += `<button type="button"
                                            class="btn ${statusClass} toggle-status-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-current-status="${data.active}"
                                            data-origin="${data.originPOI?.name}"
                                            data-destination="${data.destinationPOI?.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="${statusTitle}">
                                            <i class="ti ${statusIcon}"></i>
                                        </button>`;
                        }

                        if (canDelete) {
                            // Delete button
                            actions += `<button type="button"
                                            class="btn btn-danger delete-service-btn"
                                            data-id="${data.objectId || data.id}"
                                            data-origin="${data.originPOI?.name}"
                                            data-destination="${data.destinationPOI?.name}"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Eliminar Traslado">
                                            <i class="ti ti-trash"></i>
                                        </button>`;
                        }

                        actions += '</div>';
                        return actions;
                    }
                }] : [])
            ].concat(showClientPricing ? [{
                data: null,
                orderable: false,
                searchable: false,
                className: 'text-center',
                render: function(data) {
                    const serviceId = data.objectId || data.id;
                    const clientPrice = data.clientPrice || null; // This would come from a client-specific pricing table
                    
                    if (clientPrice) {
                        const formatMXN = (amount) => new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: 'MXN'
                        }).format(amount);
                        
                        return `
                            <div class="text-center">
                                <div class="fw-bold text-info mb-1">
                                    ${formatMXN(clientPrice)}
                                </div>
                                <button class="btn btn-sm btn-outline-primary configure-client-price-btn" data-service-id="${serviceId}">
                                    <i class="ti ti-settings"></i> Editar
                                </button>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="text-center">
                                <button class="btn btn-sm btn-primary configure-client-price-btn" data-service-id="${serviceId}">
                                    <i class="ti ti-plus"></i> Configurar
                                </button>
                            </div>
                        `;
                    }
                }
            }] : []),
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-MX.json',
                processing: '<i class="fas fa-spinner fa-spin fa-2x"></i><br>Cargando traslados...'
            },
            order: [
                [1, 'asc'],  // 1. Categor√≠a/Tarifa
                [0, 'asc'],  // 2. Ruta
            ],
            pageLength: 10,
            searchDelay: 300,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            drawCallback: function() {
                // Reinitialize tooltips after table redraw
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
                // Re-apply filters after table redraw
                const currentPaymentType = $(`#paymentTypeFilter-${tableId}`).val();
                const currentCurrency = $(`#currencyFilter-${tableId}`).val();
                setTimeout(() => {
                    // Always apply currency formatting, even for default MXN
                    updatePricesForFilters(currentPaymentType, currentCurrency);
                }, 50);
            }
        });

        // Initialize data and table
        async function initializeTable() {
            try {
                await loadAllServices();
                // Data loaded and filtered successfully
                
                // Clear existing data and add filtered data
                dataTable.clear();
                dataTable.rows.add(filteredData);
                dataTable.draw();
                
                // Apply initial currency formatting and department manager defaults
                setTimeout(() => {
                    const currentPaymentType = $(`#paymentTypeFilter-${tableId}`).val();
                    const currentCurrency = $(`#currencyFilter-${tableId}`).val();
                    
                    // For department managers, ensure transferencia is applied
                    if (isDepartmentManager && currentPaymentType === 'transferencia') {
                        console.log('üíº Applying department manager defaults: Transferencia with Agency Rate');
                    }
                    
                    updatePricesForFilters(currentPaymentType, currentCurrency);
                }, 200);
                
                console.log('‚úÖ DataTable updated with', filteredData.length, 'rows');
            } catch (error) {
                console.error('Error initializing table:', error);
                showErrorAlert('Error al cargar los traslados');
            }
        }

        // Function to apply rate prices to data
        function applyRatePricesToData(data) {
            return data.map(service => {
                const serviceId = service.id;
                const vehicleTypes = ['SEDAN', 'SUBURBAN', 'SPRINTER', 'VAN', 'MODEL 3', 'MODEL Y'];
                const foundPrices = [];
                
                vehicleTypes.forEach(vehicleCode => {
                    const key = `${serviceId}_${vehicleCode}`;
                    const priceData = servicePricesMap.get(key);
                    if (priceData) {
                        foundPrices.push({
                            vehicleType: priceData.vehicleType,
                            vehicleCode: vehicleCode,
                            price: priceData.price,
                            formattedPrice: priceData.formattedPrice
                        });
                    }
                });
                
                // Create a copy with price data
                return {
                    ...service,
                    priceData: foundPrices
                };
            });
        }

        // Filter pill click handlers (nav-pills style)
        $('.filter-pill').on('click', function() {
            const filterType = $(this).data('filter');
            
            // Update active pill (nav-pills style)
            $('.filter-pill').removeClass('active');
            $(this).addClass('active');
            
            // Filter data
            filteredData = filterServicesByType(filterType);
            
            // Apply current rate prices to filtered data (if any rate is selected)
            const selectedRate = $(`#headerRateFilter-${tableId}`).val();
            if (selectedRate && servicePricesMap.size > 0) {
                filteredData = applyRatePricesToData(filteredData);
            }
            
            // Update DataTable
            dataTable.clear();
            dataTable.rows.add(filteredData);
            dataTable.draw();
        });

        // Load rates for header filter dropdown
        function loadRatesForFilter() {
            $.ajax({
                url: '/api/rates/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const select = $(`#headerRateFilter-${tableId}`);
                        select.find('option:not(:first)').remove();
                        response.data.forEach(function(rate) {
                            const option = $('<option></option>')
                                .attr('value', rate.value)
                                .text(rate.label);
                            select.append(option);
                        });
                        
                        // Auto-select first available option if data exists
                        if (response.data.length > 0) {
                            select.val(response.data[0].value);
                            // Trigger change after a short delay to ensure table is ready
                            setTimeout(() => {
                                select.trigger('change');
                            }, 500);
                        }
                    }
                },
                beforeSend: function(xhr) {
                    const token = getAccessToken();
                    if (token) {
                        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading rates for header filter:', error);
                }
            });
        }

        // Store rate prices data globally
        let servicePricesMap = new Map();

        // Header rate filter change handler
        $(`#headerRateFilter-${tableId}`).on('change', async function() {
            const selectedRate = $(this).val();
            const selectedRateText = $(this).find('option:selected').text();
            
            console.log('Rate filter changed:', { selectedRate, selectedRateText });
            
            if (selectedRate) {
                // Load rate prices for the selected rate
                try {
                    console.log('Making API request to /api/services/with-rate-prices with rateId:', selectedRate);
                    
                    const response = await $.ajax({
                        url: '/api/services/with-rate-prices',
                        type: 'GET',
                        data: { rateId: selectedRate },
                        beforeSend: function(xhr) {
                            const token = getAccessToken();
                            console.log('Access token found:', token ? 'yes' : 'no');
                            if (token) {
                                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                            }
                        }
                    });
                    
                    console.log('API response received:', response);

                    if (response.success && response.data) {
                        // Create a map of service ID + vehicle type -> price
                        servicePricesMap.clear();
                        response.data.forEach(item => {
                            if (item.service?.id && item.vehicleType?.code) {
                                const key = `${item.service.id}_${item.vehicleType.code}`;
                                servicePricesMap.set(key, item);
                            }
                        });

                        // Update each row in filteredData with price information
                        const updatedData = filteredData.map(service => {
                            const serviceId = service.id;
                            const vehicleTypes = ['SEDAN', 'SUBURBAN', 'SPRINTER', 'VAN', 'MODEL 3', 'MODEL Y'];
                            const foundPrices = [];
                            
                            vehicleTypes.forEach(vehicleCode => {
                                const key = `${serviceId}_${vehicleCode}`;
                                const priceData = servicePricesMap.get(key);
                                if (priceData) {
                                    foundPrices.push({
                                        vehicleType: priceData.vehicleType.name,
                                        vehicleCode: vehicleCode,
                                        price: priceData.price,
                                        formattedPrice: priceData.formattedPrice
                                    });
                                }
                            });

                            // Create a copy with price data
                            return {
                                ...service,
                                priceData: foundPrices
                            };
                        });

                        // Update the table with the new data
                        dataTable.clear();
                        dataTable.rows.add(updatedData);
                        dataTable.draw();
                        
                        // Re-apply filters after table update
                        setTimeout(() => {
                            const currentPaymentType = $(`#paymentTypeFilter-${tableId}`).val();
                            const currentCurrency = $(`#currencyFilter-${tableId}`).val();
                            if (currentPaymentType === 'transferencia' || currentCurrency === 'USD') {
                                updatePricesForFilters(currentPaymentType, currentCurrency);
                            }
                        }, 100);
                        
                    } else {
                        console.error('Error loading rate prices - response not successful:', response);
                        showErrorAlert('Error al cargar precios');
                    }
                } catch (error) {
                    console.error('Error loading rate prices - AJAX error:', error);
                    console.error('Error status:', error.status);
                    console.error('Error responseText:', error.responseText);
                    showErrorAlert('Error al cargar precios de la tarifa: ' + (error.responseText || error.message));
                }
            } else {
                // Reset to show without prices
                const resetData = filteredData.map(service => ({
                    ...service,
                    priceData: []
                }));
                servicePricesMap.clear();
                dataTable.clear();
                dataTable.rows.add(resetData);
                dataTable.draw();
                
                // Re-apply filters after table reset
                setTimeout(() => {
                    const currentPaymentType = $(`#paymentTypeFilter-${tableId}`).val();
                    const currentCurrency = $(`#currencyFilter-${tableId}`).val();
                    if (currentPaymentType === 'transferencia' || currentCurrency === 'USD') {
                        updatePricesForFilters(currentPaymentType, currentCurrency);
                    }
                }, 100);
            }
        });

        // Store transfer rate data globally
        let currentTransferRate = 0;
        
        // Store agency rate data globally (for department managers)
        let currentAgencyRate = 0;
        
        // Store exchange rate data globally
        let currentExchangeRate = 0;
        
        // Check if current user is department manager
        const isDepartmentManager = (typeof userRole !== 'undefined' && userRole === 'department_manager');

        // Load current transfer rate from API
        function loadCurrentTransferRate() {
            return $.ajax({
                url: '/api/transfer-rate/current',
                type: 'GET',
                beforeSend: function(xhr) {
                    const token = getAccessToken();
                    if (token) {
                        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    }
                },
                success: function(response) {
                    if (response.success && response.data) {
                        currentTransferRate = response.data.value || 0;
                        console.log('‚úÖ Current transfer rate loaded:', currentTransferRate + '%');
                    } else {
                        console.warn('‚ö†Ô∏è No active transfer rate found');
                        currentTransferRate = 0;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error loading transfer rate:', error);
                    currentTransferRate = 0;
                }
            });
        }

        // Function to apply rate to price (transfer rate for regular users, agency rate for department managers)
        function applyCommissionRate(priceString) {
            const rateToUse = isDepartmentManager ? currentAgencyRate : currentTransferRate;
            const rateName = isDepartmentManager ? 'agency rate' : 'transfer rate';
            
            if (rateToUse <= 0) return priceString;
            
            // Extract numeric value from price string (e.g., "$1,234.50" -> 1234.50)
            const numericValue = parseFloat(priceString.replace(/[^0-9.]/g, ''));
            if (isNaN(numericValue)) return priceString;
            
            // Apply rate percentage
            const newValue = numericValue * (1 + rateToUse / 100);
            
            console.log(`Applying ${rateName} ${rateToUse}% to $${numericValue} = $${newValue.toFixed(2)}`);
            
            // Format back to currency string
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(newValue);
        }

        // Function to apply agency rate to price (for admin "Transf. Agencias" option)
        function applyAgencyRate(priceString) {
            if (currentAgencyRate <= 0) return priceString;
            
            // Extract numeric value from price string (e.g., "$1,234.50" -> 1234.50)
            const numericValue = parseFloat(priceString.replace(/[^0-9.]/g, ''));
            if (isNaN(numericValue)) return priceString;
            
            // Apply agency rate percentage
            const newValue = numericValue * (1 + currentAgencyRate / 100);
            
            console.log(`Applying agency rate ${currentAgencyRate}% to $${numericValue} = $${newValue.toFixed(2)}`);
            
            // Format back to currency string
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(newValue);
        }

        // Function to format price with proper currency symbol
        function formatPriceWithCurrency(value, currency) {
            if (currency === 'USD') {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            } else {
                // MXN formatting - match backend format: "$1,234 MXN"
                return `$${value.toLocaleString()} MXN`;
            }
        }
        
        // Function to apply currency conversion to price with custom rounding rules
        function applyCurrencyConversion(priceString, currency) {
            // Extract numeric value from price string (e.g., "$1,234.50 MXN" -> 1234.50)
            // Remove any existing currency symbols, commas, and text
            const numericValue = parseFloat(priceString.replace(/[^0-9.]/g, ''));
            if (isNaN(numericValue)) return priceString;
            
            if (currency === 'USD' && currentExchangeRate > 0) {
                // Convert MXN to USD by dividing by exchange rate
                const convertedValue = numericValue / currentExchangeRate;
                
                // Apply custom USD rounding rules
                const roundedValue = applyUSDRoundingRules(convertedValue);
                
                // Debug log for rounding
                if (console && console.log) {
                    console.log(`USD Conversion: $${numericValue.toLocaleString()} MXN √∑ ${currentExchangeRate} = $${convertedValue.toFixed(2)} ‚Üí ${formatPriceWithCurrency(roundedValue, 'USD')}`);
                }
                
                return formatPriceWithCurrency(roundedValue, currency);
            } else {
                // MXN - always format consistently
                return formatPriceWithCurrency(numericValue, 'MXN');
            }
        }
        
        // Function to apply USD rounding rules
        function applyUSDRoundingRules(value) {
            // Find the base (nearest multiple of 5 below or equal)
            const base = Math.floor(value / 5) * 5;
            
            // Calculate remainder when dividing by 5
            const remainder = value % 5;
            
            // Special case: if remainder is 0 and value is not already a multiple of 5
            // or if remainder is between 0.1 and 2.7, round down to base
            // if remainder is > 2.7, round up to next multiple of 5
            
            if (remainder === 0) {
                // If exact multiple of 5, keep as is unless it needs adjustment per examples
                // Based on example $123.0 = $125, we round up when it's .0
                // But $170.0 stays $170, so this needs special handling
                
                // Check if the last digit is 3, 8 (which would make .0 round up)
                const lastDigitBeforeDecimal = Math.floor(value) % 10;
                if (lastDigitBeforeDecimal === 3 || lastDigitBeforeDecimal === 8) {
                    return base + 5; // Round up
                } else {
                    return base; // Keep as multiple of 5
                }
            } else if (remainder <= 2.7) {
                // Round down to nearest 5
                return base;
            } else {
                // Round up to next multiple of 5
                return base + 5;
            }
        }

        // Function to update all displayed prices based on payment type and currency
        function updatePricesForFilters(paymentType, currency) {
            // Update main price column
            $('.price-container').each(function() {
                const container = $(this);
                const originalPrices = container.find('.fw-bold');
                
                originalPrices.each(function() {
                    const priceElement = $(this);
                    let originalPrice = priceElement.data('original-price');
                    
                    // Store original price on first run
                    if (!originalPrice) {
                        originalPrice = priceElement.text();
                        priceElement.data('original-price', originalPrice);
                        console.log('üí∞ Storing original price:', originalPrice);
                    }
                    
                    let finalPrice = originalPrice;
                    
                    // Apply appropriate rate based on payment type
                    if (paymentType === 'transferencia') {
                        finalPrice = applyCommissionRate(finalPrice);
                    } else if (paymentType === 'transf_agencias') {
                        finalPrice = applyAgencyRate(finalPrice);
                    }
                    
                    // Always apply currency conversion/formatting
                    finalPrice = applyCurrencyConversion(finalPrice, currency);
                    
                    priceElement.text(finalPrice);
                });
            });
            
            // Update expanded rates view if open
            $('.vehicle-option .fw-bold').each(function() {
                const priceElement = $(this);
                let originalPrice = priceElement.data('original-price');
                
                if (!originalPrice) {
                    originalPrice = priceElement.text();
                    priceElement.data('original-price', originalPrice);
                }
                
                let finalPrice = originalPrice;
                
                // Apply appropriate rate based on payment type
                if (paymentType === 'transferencia') {
                    finalPrice = applyCommissionRate(finalPrice);
                } else if (paymentType === 'transf_agencias') {
                    finalPrice = applyAgencyRate(finalPrice);
                }
                
                // Always apply currency conversion/formatting
                finalPrice = applyCurrencyConversion(finalPrice, currency);
                
                priceElement.text(finalPrice);
            });
        }

        // Payment type filter change handler
        $(`#paymentTypeFilter-${tableId}`).on('change', function() {
            const selectedPaymentType = $(this).val();
            const selectedCurrency = $(`#currencyFilter-${tableId}`).val();
            console.log('Payment type changed:', selectedPaymentType);
            
            if (selectedPaymentType === 'transferencia') {
                if (isDepartmentManager && currentAgencyRate <= 0) {
                    // Load agency rate for department managers
                    loadCurrentAgencyRate().then(() => {
                        updatePricesForFilters(selectedPaymentType, selectedCurrency);
                    });
                } else if (!isDepartmentManager && currentTransferRate <= 0) {
                    // Load transfer rate for other users
                    loadCurrentTransferRate().then(() => {
                        updatePricesForFilters(selectedPaymentType, selectedCurrency);
                    });
                } else {
                    updatePricesForFilters(selectedPaymentType, selectedCurrency);
                }
            } else if (selectedPaymentType === 'transf_agencias') {
                // Load agency rate for admin "Transf. Agencias" option
                if (currentAgencyRate <= 0) {
                    loadCurrentAgencyRate().then(() => {
                        updatePricesForFilters(selectedPaymentType, selectedCurrency);
                    });
                } else {
                    updatePricesForFilters(selectedPaymentType, selectedCurrency);
                }
            } else {
                updatePricesForFilters(selectedPaymentType, selectedCurrency);
            }
        });

        // Currency filter change handler
        $(`#currencyFilter-${tableId}`).on('change', function() {
            const selectedCurrency = $(this).val();
            const selectedPaymentType = $(`#paymentTypeFilter-${tableId}`).val();
            console.log('Currency changed:', selectedCurrency);
            
            if (selectedCurrency === 'USD' && currentExchangeRate <= 0) {
                // Try to load exchange rate if not already loaded
                loadCurrentExchangeRate().then(() => {
                    updatePricesForFilters(selectedPaymentType, selectedCurrency);
                });
            } else {
                updatePricesForFilters(selectedPaymentType, selectedCurrency);
            }
        });

        // Notification functions removed - transfer rate applied silently

        // Load current agency rate from API (for department managers)
        function loadCurrentAgencyRate() {
            return $.ajax({
                url: '/api/agency-rate/current',
                type: 'GET',
                beforeSend: function(xhr) {
                    const token = getAccessToken();
                    if (token) {
                        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    }
                },
                success: function(response) {
                    if (response.success && response.data) {
                        currentAgencyRate = response.data.value || 0;
                        console.log('‚úÖ Current agency rate loaded:', currentAgencyRate + '%');
                    } else {
                        console.warn('‚ö†Ô∏è No active agency rate found');
                        currentAgencyRate = 0;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error loading agency rate:', error);
                    currentAgencyRate = 0;
                }
            });
        }

        // Load current exchange rate from API
        function loadCurrentExchangeRate() {
            return $.ajax({
                url: '/api/exchange-rate/current',
                type: 'GET',
                beforeSend: function(xhr) {
                    const token = getAccessToken();
                    if (token) {
                        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    }
                },
                success: function(response) {
                    if (response.success && response.data) {
                        currentExchangeRate = response.data.value || 0;
                        console.log('‚úÖ Current exchange rate loaded:', currentExchangeRate, 'MXN per USD');
                    } else {
                        console.warn('‚ö†Ô∏è No active exchange rate found');
                        currentExchangeRate = 0;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error loading exchange rate:', error);
                    currentExchangeRate = 0;
                }
            });
        }

        // Load rates on initialization based on user role
        if (isDepartmentManager) {
            // Load agency rate for department managers BEFORE initializing table
            console.log('üíº Department manager detected - loading Agency Rate first');
            loadCurrentAgencyRate().then(() => {
                // Set default payment type to transferencia AFTER agency rate is loaded
                $(`#paymentTypeFilter-${tableId}`).val('transferencia');
                console.log('üíº Agency rate loaded, setting default to Transferencia');
                
                // Load exchange rate
                loadCurrentExchangeRate();
                
                // Load rates for the header filter
                loadRatesForFilter();
                
                // Initialize table with data (with correct rates applied)
                initializeTable();
                
                console.log('üíº Department manager table initialized with AgencyRate applied');
            });
        } else {
            // Load transfer rate for other users
            loadCurrentTransferRate();
            // Load exchange rate on initialization
            loadCurrentExchangeRate();
        }

        // Handle expand/collapse prices functionality
        $(document).on('click', '.expand-prices-btn', function(e) {
            e.preventDefault();
            const button = $(this);
            const rowId = button.data('row-id');
            const isExpanded = button.hasClass('expanded');
            
            // Find the DataTable row
            const row = dataTable.rows().nodes().to$().filter(function() {
                return $(this).find('[data-row-id="' + rowId + '"]').length > 0;
            }).first();
            
            const dtRow = dataTable.row(row);
            
            if (!isExpanded) {
                // Expand - load and show all rates for this service
                button.prop('disabled', true).html('<i class="ti ti-spinner ti-spin me-1"></i>Cargando...');
                
                // Make API call to get prices for all rates for this service
                $.ajax({
                    url: '/api/services/' + rowId + '/all-rate-prices',
                    type: 'GET',
                    beforeSend: function(xhr) {
                        const token = getAccessToken();
                        if (token) {
                            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                        }
                    },
                    success: function(response) {
                        if (response.success && response.data) {
                            // Group prices by rate
                            const pricesByRate = {};
                            response.data.forEach(item => {
                                const rateName = item.rate?.name || 'Sin tarifa';
                                if (!pricesByRate[rateName]) {
                                    pricesByRate[rateName] = [];
                                }
                                pricesByRate[rateName].push(item);
                            });
                            
                            // Generate card-based HTML for all rates
                            let allRatesHtml = '<div class="row g-3 mt-2">';
                            
                            Object.keys(pricesByRate).forEach(rateName => {
                                const prices = pricesByRate[rateName];
                                
                                // Get rate color from the first price item (all items have same rate)
                                const rateColor = prices[0]?.rate?.color || '#6c757d';
                                
                                // Generate light background color from rate color
                                const bgColor = rateColor + '15'; // Add alpha transparency
                                
                                // Calculate base price (lowest price)
                                const basePrice = Math.min(...prices.map(p => p.price || 0));
                                
                                // Generate vehicle options (sorted by price low to high)
                                const sortedPrices = [...prices].sort((a, b) => (a.price || 0) - (b.price || 0));
                                const vehicleOptionsHtml = sortedPrices.map(p => {
                                    const vehicleCode = p.vehicleType?.code || 'N/A';
                                    const vehicleName = p.vehicleType?.name || 'Veh√≠culo';
                                    const price = p.formattedPrice || `$${p.price || 0}`;
                                    
                                    // Get capacity info from database
                                    const defaultCapacity = p.vehicleType?.defaultCapacity || 4;
                                    const trunkCapacity = p.vehicleType?.trunkCapacity || 2;
                                    const capacityInfo = `${defaultCapacity} <i class="ti ti-user"></i> ${trunkCapacity} <i class="ti ti-briefcase"></i>`;
                                    
                                    return `
                                        <div class="vehicle-option p-2 mb-1 border rounded bg-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <div class="rate-color-indicator me-2" style="background-color: ${rateColor}; width: 3px; height: 30px; border-radius: 2px;"></div>
                                                    <div>
                                                        <div class="fw-semibold small">${vehicleName}</div>
                                                        <div class="text-muted" style="font-size: 0.75rem;">${capacityInfo}</div>
                                                    </div>
                                                </div>
                                                <div class="fw-bold small" style="color: ${rateColor}" data-original-price="${price}">${price}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                                
                                allRatesHtml += `
                                    <div class="col-lg-3 col-md-6 col-sm-12">
                                        <div class="rate-card p-3 rounded-3 h-100" style="background-color: ${bgColor}; border-left: 4px solid ${rateColor};">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="rate-color-circle me-2" style="background-color: ${rateColor}; width: 12px; height: 12px; border-radius: 50%;"></div>
                                                <h6 class="mb-0 fw-bold" style="color: ${rateColor}">${rateName}</h6>
                                            </div>
                                            
                                            ${vehicleOptionsHtml}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            allRatesHtml += '</div>';
                            
                            // Create child row with full width content
                            const childRowContent = `
                                <div class="p-4 bg-light border-top">
                                    <div class="container-fluid">
                                        <div class="mb-3">
                                            <h6 class="mb-0 text-muted">
                                                <i class="ti ti-list me-2"></i>
                                                Comparar todas las tarifas disponibles
                                            </h6>
                                        </div>
                                        ${allRatesHtml}
                                    </div>
                                </div>
                            `;
                            
                            // Add child row to DataTable
                            dtRow.child(childRowContent).show();
                            
                            button.html('<i class="ti ti-chevron-up me-1"></i>Ver menos')
                                  .addClass('expanded')
                                  .prop('disabled', false);
                            
                            // Apply filters to expanded prices
                            setTimeout(() => {
                                const currentPaymentType = $(`#paymentTypeFilter-${tableId}`).val();
                                const currentCurrency = $(`#currencyFilter-${tableId}`).val();
                                // Always apply current filters to expanded prices
                                updatePricesForFilters(currentPaymentType, currentCurrency);
                            }, 100);
                        } else {
                            button.html('<i class="ti ti-chevron-down me-1"></i>Error al cargar')
                                  .prop('disabled', false);
                        }
                    },
                    error: function() {
                        button.html('<i class="ti ti-chevron-down me-1"></i>Ver todos')
                              .prop('disabled', false);
                        showErrorAlert('Error al cargar precios de todas las tarifas');
                    }
                });
                
            } else {
                // Collapse - hide child row and restore original state
                dtRow.child.hide();
                
                button.html('<i class="ti ti-chevron-down me-1"></i>Ver todos')
                      .removeClass('expanded');
            }
        });

        // Handle configure client price functionality
        $(document).on('click', '.configure-client-price-btn', function(e) {
            e.preventDefault();
            const button = $(this);
            const serviceId = button.data('service-id');
            
            if (serviceId) {
                configureServiceClientPrice(serviceId);
            }
        });

        // Initialize based on user role
        if (isDepartmentManager) {
            // For department managers, initialization is handled in the loadCurrentAgencyRate() promise above
            // This ensures AgencyRate is loaded and payment type is set before table initialization
            console.log('üíº Department manager initialization deferred to agency rate loading');
            // Load POIs and VehicleTypes for dropdowns
            loadDropdownData();
        } else {
            // For other users, proceed with normal initialization
            // Load rates for the header filter
            loadRatesForFilter();
            // Initialize table with data
            initializeTable();
            // Load POIs and VehicleTypes for dropdowns
            loadDropdownData();
        }

        // Event Handlers
        $('#createServiceBtn').on('click', function() {
            openServiceModal();
        });

        // Edit service
        $(`#${tableId}`).on('click', '.edit-service-btn', function() {
            const serviceId = $(this).data('id');
            loadServiceData(serviceId);
        });

        // Toggle status
        $(`#${tableId}`).on('click', '.toggle-status-btn', function() {
            const serviceId = $(this).data('id');
            const currentStatus = $(this).data('current-status');
            const origin = $(this).data('origin');
            const destination = $(this).data('destination');
            toggleServiceStatus(serviceId, currentStatus, origin, destination);
        });

        // Delete service
        $(`#${tableId}`).on('click', '.delete-service-btn', function() {
            const serviceId = $(this).data('id');
            const origin = $(this).data('origin');
            const destination = $(this).data('destination');
            deleteService(serviceId, origin, destination);
        });

        // Save service
        $('#saveServiceBtn').on('click', function() {
            saveService();
        });

        // Functions

        // Helper function to wait for Tom Select to be initialized
        function waitForTomSelect(elementId, maxAttempts = 50) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    const element = document.getElementById(elementId);
                    if (element && element.tomselect) {
                        clearInterval(checkInterval);
                        resolve(element.tomselect);
                    } else {
                        attempts++;
                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(new Error(`Tom Select not initialized on #${elementId}`));
                        }
                    }
                }, 100);
            });
        }

        function loadDropdownData() {
            // Load POIs
            $.ajax({
                url: '/api/pois/active',
                type: 'GET',
                success: async function(response) {
                    if (response.success && response.data) {
                        poisData = response.data;

                        try {
                            // Wait for Tom Select instances to be initialized
                            const originTS = await waitForTomSelect('originPOI');
                            const destTS = await waitForTomSelect('destinationPOI');

                            // Clear existing options
                            originTS.clearOptions();
                            destTS.clearOptions();

                            // Add options to both Tom Select instances
                            response.data.forEach(poi => {
                                const option = { value: poi.value, text: poi.label };
                                originTS.addOption(option);
                                destTS.addOption(option);
                            });

                            // Refresh to apply changes
                            originTS.refreshOptions(false);
                            destTS.refreshOptions(false);
                        } catch (error) {
                            console.error('Error initializing Tom Select:', error);
                        }
                    }
                },
                error: function(xhr) {
                    console.error('Error loading POIs:', xhr);
                }
            });

            // Load VehicleTypes
            $.ajax({
                url: '/api/vehicle-types/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        vehicleTypesData = response.data;
                        const options = response.data.map(vt =>
                            `<option value="${vt.value}">${vt.label}</option>`
                        ).join('');
                        $('#vehicleType').append(options);
                    }
                },
                error: function(xhr) {
                    console.error('Error loading vehicle types:', xhr);
                }
            });

            // Load Rates
            $.ajax({
                url: '/api/rates/active',
                type: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        ratesData = response.data;
                        const options = response.data.map(rate =>
                            `<option value="${rate.value}">${rate.label}</option>`
                        ).join('');
                        $('#rate').append(options);
                    }
                },
                error: function(xhr) {
                    console.error('Error loading rates:', xhr);
                }
            });
        }

        async function openServiceModal(isEdit = false) {
            // Clear any previous modal alerts
            const alertsContainer = document.getElementById('serviceModalAlerts');
            if (alertsContainer) {
                alertsContainer.querySelectorAll('.alert').forEach(el => el.remove());
            }

            $('#serviceModal').modal('show');
            $('#serviceForm')[0].reset();
            $('#serviceId').val('');
            $('#modalTitle').text(isEdit ? 'Editar Traslado' : 'Crear Nuevo Traslado');
            $('#saveButtonText').text(isEdit ? 'Guardar Cambios' : 'Crear Traslado');

            try {
                // Wait for and clear Tom Select instances
                const originTS = await waitForTomSelect('originPOI');
                const destTS = await waitForTomSelect('destinationPOI');

                originTS.clear();
                destTS.clear();
            } catch (error) {
                console.error('Error clearing Tom Select:', error);
            }
        }

        async function loadServiceData(serviceId) {
            // Open modal first in edit mode (this will reset the form)
            await openServiceModal(true);

            $.ajax({
                url: `${apiEndpoint}/${serviceId}`,
                type: 'GET',
                success: async function(response) {
                    if (response.success && response.data) {
                        const service = response.data;

                        try {
                            // Wait for Tom Select instances
                            const originTS = await waitForTomSelect('originPOI');
                            const destTS = await waitForTomSelect('destinationPOI');

                            // Populate the form with the data
                            $('#serviceId').val(service.id);

                            // Set Tom Select values
                            if (service.originPOI?.id) {
                                originTS.setValue(service.originPOI.id);
                            }
                            if (service.destinationPOI?.id) {
                                destTS.setValue(service.destinationPOI.id);
                            }

                            $('#vehicleType').val(service.vehicleType?.id);
                            $('#rate').val(service.rate?.id);
                            $('#note').val(service.note || '');
                        } catch (error) {
                            console.error('Error setting Tom Select values:', error);
                        }
                    } else {
                        showErrorAlert('Formato de respuesta inv√°lido');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', { xhr, status, error });
                    const errorMessage = xhr.responseJSON?.error || 'Error al cargar el traslado';
                    showModalError(errorMessage);
                }
            });
        }

        async function saveService() {
            const form = $('#serviceForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            const serviceId = $('#serviceId').val();
            const isEdit = !!serviceId;

            try {
                // Wait for Tom Select instances
                const originTS = await waitForTomSelect('originPOI');
                const destTS = await waitForTomSelect('destinationPOI');

                // Get values from Tom Select
                const originPOI = originTS.getValue();
                const destinationPOI = destTS.getValue();

                // Validate origin !== destination (only if both exist)
                if (originPOI && destinationPOI && originPOI === destinationPOI) {
                    showErrorAlert('El origen y el destino deben ser diferentes');
                    return;
                }

                const serviceData = {
                    originPOI: originPOI || null,
                    destinationPOI: destinationPOI,
                    vehicleType: $('#vehicleType').val(),
                    rate: $('#rate').val(),
                    note: $('#note').val().trim(),
                };

                const url = isEdit ? `${apiEndpoint}/${serviceId}` : apiEndpoint;
                const method = isEdit ? 'PUT' : 'POST';

                $.ajax({
                    url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(serviceData),
                    success: function(response) {
                        if (response.success) {
                            $('#serviceModal').modal('hide');
                            // Reload all data and refresh current filter
                            initializeTable();
                            showSuccessAlert(isEdit ? 'Traslado actualizado exitosamente' : 'Traslado creado exitosamente');
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = 'Error al guardar el traslado';

                        if (xhr.responseJSON?.error) {
                            const error = xhr.responseJSON.error;
                            if (error.includes('already exists') || error.includes('ya existe')) {
                                errorMessage = 'Ya existe un traslado con esta ruta, tipo de veh√≠culo y tarifa.';
                            } else if (error.includes('required')) {
                                errorMessage = 'Todos los campos requeridos deben ser completados.';
                            } else if (error.includes('different') || error.includes('diferentes')) {
                                errorMessage = 'El origen y destino deben ser diferentes.';
                            } else {
                                errorMessage = error;
                            }
                        }

                        showModalError(errorMessage);
                    }
                });
            } catch (error) {
                console.error('Error getting Tom Select values:', error);
                showModalError('Error al obtener los valores del formulario');
            }
        }

        function toggleServiceStatus(serviceId, currentStatus, origin, destination) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'activar' : 'desactivar';
            const actionTitle = newStatus ? 'Activar' : 'Desactivar';
            const btnClass = newStatus ? 'btn-success' : 'btn-warning';

            // Create confirmation modal
            const modalHtml = `
                <div class="modal fade" id="confirmToggleServiceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${actionTitle} Traslado</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¬øEst√°s seguro de que deseas ${action} el traslado <strong>"${origin} ‚Üí ${destination}"</strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn ${btnClass}" id="confirmToggleServiceBtn">${actionTitle}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            $('#confirmToggleServiceModal').remove();

            // Add modal to body
            $('body').append(modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('confirmToggleServiceModal'));
            modal.show();

            // Handle confirmation
            $('#confirmToggleServiceBtn').on('click', function() {
                $.ajax({
                    url: `${apiEndpoint}/${serviceId}/toggle-status`,
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({ active: newStatus }),
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            // Reload all data and refresh current filter
                            initializeTable();
                            showAlert('success', `Traslado ${newStatus ? 'activado' : 'desactivado'} exitosamente`);
                        } else {
                            modal.hide();
                            showAlert('danger', response.error || 'Error desconocido');
                        }
                    },
                    error: function(xhr) {
                        console.error('Toggle error:', xhr);
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al cambiar el estado del traslado';
                        showAlert('danger', error);
                    }
                });
            });
        }

        function deleteService(serviceId, origin, destination) {
            // Create confirmation modal
            const modalHtml = `
                <div class="modal fade" id="confirmDeleteServiceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title text-white">Eliminar Traslado</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¬øEst√°s seguro de que deseas eliminar el traslado <strong>"${origin} ‚Üí ${destination}"</strong>?</p>
                                <p class="text-muted mb-0">Esta acci√≥n no se puede deshacer.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteServiceBtn">Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            $('#confirmDeleteServiceModal').remove();

            // Add modal to body
            $('body').append(modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteServiceModal'));
            modal.show();

            // Handle confirmation
            $('#confirmDeleteServiceBtn').on('click', function() {
                $.ajax({
                    url: `${apiEndpoint}/${serviceId}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            modal.hide();
                            // Reload all data and refresh current filter
                            initializeTable();
                            showAlert('success', 'Traslado eliminado exitosamente');
                        }
                    },
                    error: function(xhr) {
                        modal.hide();
                        const error = xhr.responseJSON?.error || 'Error al eliminar el traslado';
                        showAlert('danger', error);
                    }
                });
            });
        }

        /**
         * Show error alert message inside the modal
         * @param {string} message - Error message to display
         */
        function showModalError(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('serviceModalAlerts');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);

                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 8000);
            }
        }

        /**
         * Show success alert message
         * @param {string} message - Success message to display
         */
        function showSuccessAlert(message) {
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ti ti-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('services-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);

                setTimeout(() => {
                    container.querySelectorAll('.alert').forEach(el => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 150);
                    });
                }, 5000);
            }
        }

        /**
         * Show error alert message
         * @param {string} message - Error message to display
         */
        function showErrorAlert(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const container = document.getElementById('services-content');
            if (container) {
                container.querySelectorAll('.alert').forEach(el => el.remove());
                container.insertAdjacentHTML('afterbegin', alertHtml);
            }
        }

        // Legacy function for backward compatibility
        function showAlert(type, message) {
            if (type === 'success') {
                showSuccessAlert(message);
            } else {
                showErrorAlert(message);
            }
        }

        // Configure Service Client Price functionality (only available when showClientPricing is true)
        function configureServiceClientPrice(serviceId) {
            console.log('Configure client price for service:', serviceId);
            
            // Find the service data from the DataTable
            let serviceData = null;
            
            if (dataTable) {
                // Try to find the service data in the DataTable
                dataTable.rows().every(function() {
                    const data = this.data();
                    if ((data.id || data.objectId) === serviceId) {
                        serviceData = data;
                        return false; // break the loop
                    }
                });
            }
            
            // For now, show an alert with the service information
            // This should be replaced with a proper modal implementation
            if (serviceData) {
                const origin = serviceData.originPOI?.name || 'Sin origen';
                const destination = serviceData.destinationPOI?.name || 'Sin destino';
                const route = origin !== 'Sin origen' ? `${origin} ‚Üí ${destination}` : destination;
                alert(`Configurar precio cliente para:\n\nRuta: ${route}\nID: ${serviceId}\n\n(Funcionalidad de modal pendiente)`);
            } else {
                alert(`Configurar precio cliente para Service ID: ${serviceId}\n\n(Funcionalidad de modal pendiente)`);
            }
        }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWhenReady);
    } else {
        initWhenReady();
    }
})();
</script>

<!-- Custom CSS for expandable prices -->
<style>
/* Price container styling */
.price-container {
    min-height: 60px;
}

.prices-list {
    margin-bottom: 4px;
}

.price-item {
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.price-item:last-child {
    margin-bottom: 0;
}

/* Expand button styling */
.expand-prices-btn {
    color: #6c757d !important;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
    border: none !important;
    background: none !important;
}

.expand-prices-btn:hover {
    color: #495057 !important;
    text-decoration: none !important;
}

.expand-prices-btn:focus {
    box-shadow: none !important;
    outline: none !important;
}

.expand-prices-btn i {
    transition: transform 0.2s ease-in-out;
}

.expand-prices-btn.expanded i {
    transform: rotate(180deg);
}

/* Badge styling for vehicle types */
.price-item .badge {
    font-size: 0.7rem;
    min-width: 50px;
    text-align: center;
}

/* Price column specific styling */
.price-column {
    vertical-align: top !important;
    max-width: 200px;
}

/* Animation for expanding/collapsing */
.prices-list {
    transition: all 0.3s ease-in-out;
}

/* Enhanced card styling for expanded rates */
.rate-card {
    border: 1px solid rgba(0,0,0,0.1);
    transition: all 0.2s ease-in-out;
}

.rate-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.vehicle-option {
    transition: all 0.2s ease-in-out;
    border: 1px solid #e9ecef !important;
}

.vehicle-option:hover {
    border-color: #007bff !important;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

/* Rate-specific styling */
.rate-card .h5 {
    font-weight: 700;
}

.rate-card .fw-semibold {
    color: #495057;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .rate-card {
        margin-bottom: 0.75rem;
    }
    
    .vehicle-option {
        padding: 0.5rem !important;
    }
    
    .dataTables_wrapper table.dataTable tbody tr.child .container-fluid {
        padding: 0 1rem;
    }
}

/* Icon styling */
.rate-card i[class*="ti-"] {
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
}

/* Price styling in vehicle options */
.vehicle-option .fw-bold {
    font-size: 0.9rem;
}

/* DataTables child row styling */
.dataTables_wrapper table.dataTable tbody tr.child {
    background-color: transparent;
}

.dataTables_wrapper table.dataTable tbody tr.child td {
    padding: 0 !important;
    border: none !important;
}

.dataTables_wrapper table.dataTable tbody tr.child td div {
    border-left: 3px solid #007bff;
    animation: fadeInUp 0.3s ease-in-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Expanded row styling */
.dataTables_wrapper table.dataTable tbody tr.child .container-fluid {
    max-width: 100%;
    padding: 0 2rem;
}

/* Rate color indicators */
.rate-color-indicator {
    transition: all 0.2s ease-in-out;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.rate-color-circle {
    transition: all 0.2s ease-in-out;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.vehicle-option:hover .rate-color-indicator {
    transform: scaleY(1.1);
}

.rate-card:hover .rate-color-circle {
    transform: scale(1.2);
}

/* Transfer rate styling */
.fw-bold.text-warning {
    font-weight: 600 !important;
    position: relative;
}

.transfer-rate-notification {
    border-left: 4px solid #17a2b8;
    background-color: rgba(23, 162, 184, 0.1);
}

.transfer-rate-notification .btn-close {
    filter: brightness(0) saturate(100%) invert(31%) sepia(81%) saturate(1059%) hue-rotate(162deg) brightness(92%) contrast(86%);
}
</style>

<%
/**
 * Dashboard Header Organism
 * Dynamic header component with user info, notifications, and responsive design
 *
 * @param {object} user - Current user object
 * @param {string} userRole - Current user role
 * @param {string} headerPageTitle - Current page title
 */

const headerUser = typeof user !== 'undefined' ? user : null;
const headerUserRole = typeof userRole !== 'undefined' ? userRole : 'guest';
const headerPageTitle = typeof pageTitle !== 'undefined' ? pageTitle : 'Dashboard';

// User display name
const firstName = headerUser?.firstName || '';
const lastName = headerUser?.lastName || '';
const displayName = headerUser ?
    (firstName && lastName ? `${firstName} ${lastName}` :
     firstName ? firstName :
     lastName ? lastName :
     headerUser.name || headerUser.email?.split('@')[0] || 'Usuario') : 'Usuario';
const userEmail = headerUser ? (headerUser.email || '') : '';
const profileImage = headerUser ? (headerUser.profileImage || '/dashboard/images/profile/user-default.jpg') : '/dashboard/images/profile/user-default.jpg';

// Role display names
const roleDisplayNames = {
    'superadmin': 'Super Administrador',
    'admin': 'Administrador',
    'client': 'Cliente',
    'department_manager': 'Jefe de Departamento',
    'employee': 'Empleado',
    'driver': 'Conductor',
    'guest': 'Invitado'
};

const roleDisplayName = roleDisplayNames[headerUserRole] || headerUserRole;

// Role-based header colors
const roleColors = {
    superadmin: { primary: '#ff6b6b', secondary: '#4ecdc4' },
    admin: { primary: '#5d87ff', secondary: '#49beff' },
    client: { primary: '#8b5cf6', secondary: '#ec4899' },
    department_manager: { primary: '#10b981', secondary: '#3b82f6' },
    employee: { primary: '#06b6d4', secondary: '#8b5cf6' },
    driver: { primary: '#f59e0b', secondary: '#ef4444' },
    guest: { primary: '#6b7280', secondary: '#9ca3af' }
};

const colors = roleColors[headerUserRole] || roleColors.guest;
%>

<!-- Header Start -->
<header class="app-header sticky-top bg-white border-bottom">
    <nav class="navbar navbar-expand-lg navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item d-block d-xl-none">
                <a class="nav-link sidebartoggler" id="headerCollapse" href="javascript:void(0)" data-bs-toggle="sidebar">
                    <i class="ti ti-menu-2 fs-6"></i>
                </a>
            </li>
        </ul>

        <!-- Page Title & Breadcrumb -->
        <div class="navbar-nav me-auto">
            <div class="nav-item">
                <h4 class="mb-0 fw-bold text-dark">
                    <i class="ti ti-dashboard me-2" style="color: <%= colors.primary %>;"></i>
                    <%= headerPageTitle %>
                </h4>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="/dashboard/<%= headerUserRole %>" class="text-decoration-none" style="color: <%= colors.primary %>;">
                                Dashboard
                            </a>
                        </li>
                        <% if (headerPageTitle !== 'Dashboard') { %>
                            <li class="breadcrumb-item active" aria-current="page"><%= headerPageTitle %></li>
                        <% } %>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- Right side nav items -->
        <div class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
            <!-- Global Search -->
            <li class="nav-item me-3">
                <div class="input-group" style="width: 300px;">
                    <span class="input-group-text bg-light border-end-0">
                        <i class="ti ti-search text-muted"></i>
                    </span>
                    <input type="text"
                           class="form-control border-start-0 bg-light"
                           placeholder="Buscar..."
                           id="global-search">
                </div>
            </li>

            <!-- Theme Toggle -->
            <li class="nav-item me-2">
                <a class="nav-link nav-icon-hover p-2 rounded-circle" href="javascript:void(0)" id="theme-toggle" data-bs-toggle="tooltip" title="Cambiar tema">
                    <i class="ti ti-moon fs-6"></i>
                </a>
            </li>

            <!-- Notifications Dropdown -->
            <li class="nav-item dropdown me-2">
                <a class="nav-link nav-icon-hover p-2 rounded-circle position-relative" href="#" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="ti ti-bell fs-6"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-count">
                        3
                        <span class="visually-hidden">notificaciones no le√≠das</span>
                    </span>
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up shadow-lg border-0" aria-labelledby="drop2" style="width: 360px;">
                    <div class="message-body">
                        <div class="d-flex align-items-center justify-content-between p-3 border-bottom">
                            <h6 class="mb-0 fw-bold">Notificaciones</h6>
                            <a href="#" class="btn btn-sm text-primary fw-bold">Ver todas</a>
                        </div>

                        <div class="message-list" id="notification-list">
                            <!-- Notification items will be loaded via JavaScript -->
                            <div class="message-item p-3 border-bottom">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="round-40 d-flex align-items-center justify-content-center bg-light-info text-info">
                                            <i class="ti ti-user-plus fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold fs-3">Nuevo usuario registrado</h6>
                                        <p class="mb-1 text-muted fs-2">Juan P√©rez se ha registrado</p>
                                        <small class="text-muted">Hace 5 minutos</small>
                                    </div>
                                </div>
                            </div>

                            <div class="message-item p-3 border-bottom">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="round-40 d-flex align-items-center justify-content-center bg-light-success text-success">
                                            <i class="ti ti-calendar-check fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold fs-3">Reservaci√≥n confirmada</h6>
                                        <p class="mb-1 text-muted fs-2">Booking #12345 confirmado</p>
                                        <small class="text-muted">Hace 1 hora</small>
                                    </div>
                                </div>
                            </div>

                            <div class="message-item p-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="round-40 d-flex align-items-center justify-content-center bg-light-warning text-warning">
                                            <i class="ti ti-alert-triangle fs-5"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-semibold fs-3">Mantenimiento programado</h6>
                                        <p class="mb-1 text-muted fs-2">Sistema no disponible 02:00-04:00 AM</p>
                                        <small class="text-muted">Hace 2 horas</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-3 text-center border-top">
                            <a href="/dashboard/<%= headerUserRole %>/notifications" class="btn btn-outline-primary btn-sm w-100">
                                Ver todas las notificaciones
                            </a>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Quick Actions (Role-based) -->
            <% if (['superadmin', 'admin', 'client'].includes(headerUserRole)) { %>
            <li class="nav-item dropdown me-2">
                <a class="nav-link nav-icon-hover p-2 rounded-circle" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="ti ti-plus fs-6"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up shadow-lg border-0">
                    <div class="message-body">
                        <h6 class="dropdown-header">Acciones R√°pidas</h6>

                        <% if (headerUserRole === 'superadmin') { %>
                            <a href="#" class="dropdown-item d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#createUserModal">
                                <i class="ti ti-user-plus fs-4"></i>
                                Crear Usuario
                            </a>
                            <a href="#" class="dropdown-item d-flex align-items-center gap-2">
                                <i class="ti ti-building-plus fs-4"></i>
                                Agregar Cliente
                            </a>
                        <% } else if (headerUserRole === 'admin') { %>
                            <a href="#" class="dropdown-item d-flex align-items-center gap-2">
                                <i class="ti ti-calendar-plus fs-4"></i>
                                Nuevo Evento
                            </a>
                            <a href="#" class="dropdown-item d-flex align-items-center gap-2">
                                <i class="ti ti-car-plus fs-4"></i>
                                Nueva Reservaci√≥n
                            </a>
                        <% } else if (headerUserRole === 'client') { %>
                            <a href="#" class="dropdown-item d-flex align-items-center gap-2">
                                <i class="ti ti-calendar-event fs-4"></i>
                                Crear Evento
                            </a>
                            <a href="#" class="dropdown-item d-flex align-items-center gap-2">
                                <i class="ti ti-world-plus fs-4"></i>
                                Nueva Landing Page
                            </a>
                        <% } %>

                        <div class="dropdown-divider"></div>
                        <a href="/dashboard/<%= headerUserRole %>/help" class="dropdown-item d-flex align-items-center gap-2">
                            <i class="ti ti-help fs-4"></i>
                            Centro de Ayuda
                        </a>
                    </div>
                </div>
            </li>
            <% } %>

            <!-- User Profile Dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link pe-0 user-profile-dropdown" href="#" id="drop1" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="d-flex align-items-center">
                        <div class="user-profile-img">
                            <img src="<%= profileImage %>" class="rounded-circle" width="40" height="40" alt="Profile" />
                        </div>
                        <div class="ms-2 d-none d-lg-block">
                            <h6 class="mb-0 fs-4 fw-semibold"><%= displayName %></h6>
                            <small class="text-muted"><%= roleDisplayName %></small>
                        </div>
                        <i class="ti ti-chevron-down ms-2 d-none d-lg-block"></i>
                    </div>
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up shadow-lg border-0" aria-labelledby="drop1">
                    <div class="message-body">
                        <!-- User Info Header -->
                        <div class="d-flex align-items-center p-3 border-bottom">
                            <img src="<%= profileImage %>" class="rounded-circle me-3" width="50" height="50" alt="Profile" />
                            <div>
                                <h6 class="mb-0 fw-bold"><%= displayName %></h6>
                                <small class="text-muted"><%= userEmail %></small>
                                <div>
                                    <span class="badge" style="background: <%= colors.primary %>20; color: <%= colors.primary %>;">
                                        <%= roleDisplayName %>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Links -->
                        <a href="/dashboard/<%= headerUserRole %>/profile" class="dropdown-item d-flex align-items-center gap-2 py-2">
                            <i class="ti ti-user fs-4"></i>
                            Mi Perfil
                        </a>

                        <a href="/dashboard/<%= headerUserRole %>/settings" class="dropdown-item d-flex align-items-center gap-2 py-2">
                            <i class="ti ti-settings fs-4"></i>
                            Configuraci√≥n
                        </a>

                        <a href="/dashboard/<%= headerUserRole %>/billing" class="dropdown-item d-flex align-items-center gap-2 py-2">
                            <i class="ti ti-wallet fs-4"></i>
                            Facturaci√≥n
                        </a>

                        <div class="dropdown-divider"></div>

                        <!-- Support Links -->
                        <a href="/dashboard/<%= headerUserRole %>/help" class="dropdown-item d-flex align-items-center gap-2 py-2">
                            <i class="ti ti-help fs-4"></i>
                            Centro de Ayuda
                        </a>

                        <a href="/dashboard/<%= headerUserRole %>/support" class="dropdown-item d-flex align-items-center gap-2 py-2">
                            <i class="ti ti-message-circle fs-4"></i>
                            Soporte
                        </a>

                        <div class="dropdown-divider"></div>

                        <!-- Logout -->
                        <a href="/auth/logout" class="dropdown-item d-flex align-items-center gap-2 py-2 text-danger" data-confirm="¬øCerrar sesi√≥n?">
                            <i class="ti ti-logout fs-4"></i>
                            Cerrar Sesi√≥n
                        </a>
                    </div>
                </div>
            </li>
        </div>
    </nav>
</header>
<!-- Header End -->

<style>
    /* Header Styling */
    .app-header {
        min-height: 70px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-bottom: 1px solid rgba(0,0,0,0.08) !important;
    }

    .nav-icon-hover {
        transition: all 0.3s ease;
    }

    .nav-icon-hover:hover {
        background-color: rgba(93, 135, 255, 0.1) !important;
        color: <%= colors.primary %> !important;
    }

    .user-profile-dropdown {
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 0.5rem !important;
    }

    .user-profile-dropdown:hover {
        background-color: rgba(93, 135, 255, 0.05);
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "‚Ä∫";
        color: <%= colors.primary %>;
        font-weight: bold;
    }

    /* Notification badge animation */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    #notification-count {
        animation: pulse 2s infinite;
    }

    /* Search input styling */
    #global-search {
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    #global-search:focus {
        border-color: <%= colors.primary %>;
        box-shadow: 0 0 0 0.2rem <%= colors.primary %>20;
    }

    /* Dropdown styling */
    .dropdown-menu {
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        border: 1px solid rgba(0,0,0,0.08);
    }

    .dropdown-item:hover {
        background-color: <%= colors.primary %>10;
        color: <%= colors.primary %>;
    }

    /* Message list styling */
    .message-item:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .round-40 {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .app-header .navbar-nav.me-auto {
            display: none;
        }

        #global-search {
            width: 200px;
        }
    }

    @media (max-width: 767.98px) {
        .nav-item.me-3 {
            display: none;
        }

        .user-profile-img img {
            width: 35px;
            height: 35px;
        }
    }
</style>

<script>
// Header specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã Header initialized for user:', '<%= displayName %>');

    // Handle confirmation dialogs
    document.querySelectorAll('[data-confirm]').forEach(function(element) {
        element.addEventListener('click', function(e) {
            const message = this.dataset.confirm;
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });

    // Global search functionality
    const globalSearch = document.getElementById('global-search');
    if (globalSearch) {
        let searchTimeout;
        globalSearch.addEventListener('input', function(e) {
            const query = e.target.value.trim();

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                if (query.length >= 2) {
                    performGlobalSearch(query);
                }
            }, 500);
        });
    }

    // Load notifications
    loadNotifications();

    // Setup notification polling (every 30 seconds)
    setInterval(loadNotifications, 30000);
});

// Global search function
function performGlobalSearch(query) {
    console.log('üîç Performing global search for:', query);

    // Implementation will depend on the search functionality
    // This is a placeholder for the actual search logic
    fetch(`/api/search?q=${encodeURIComponent(query)}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.results && data.results.length > 0) {
            displaySearchResults(data.results);
        }
    })
    .catch(error => {
        console.error('Search error:', error);
    });
}

// Display search results (placeholder)
function displaySearchResults(results) {
    // Implementation for displaying search results
    console.log('Search results:', results);
}

// Load notifications
function loadNotifications() {
    const userRole = '<%= headerUserRole %>';

    fetch('/api/notifications', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateNotificationCount(data.data.unreadCount || 0);
            updateNotificationList(data.data.notifications || []);
        }
    })
    .catch(error => {
        console.error('Error loading notifications:', error);
    });
}

// Update notification count badge
function updateNotificationCount(count) {
    const badge = document.getElementById('notification-count');
    if (badge) {
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Update notification list
function updateNotificationList(notifications) {
    const list = document.getElementById('notification-list');
    if (list && notifications.length > 0) {
        // Clear existing notifications except the placeholder ones
        // Implementation would replace placeholder notifications with real ones
        console.log('üì¨ Loaded', notifications.length, 'notifications');
    }
}

// Handle sidebar toggle for mobile
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-bs-toggle="sidebar"]') || e.target.closest('[data-bs-toggle="sidebar"]')) {
        const sidebar = document.querySelector('.left-sidebar');
        if (sidebar) {
            sidebar.classList.toggle('show');
        }
    }
});
</script>
yarn run v1.22.22
$ NODE_ENV=test node --experimental-vm-modules node_modules/.bin/jest tests/integration tests/unit --config .config/jest/jest.config.js

ğŸš€ Starting Global Test Setup...

ğŸ“¦ Starting MongoDB Memory Server...
   âœ… MongoDB Memory Server started
   â„¹ï¸  URI: mongodb://127.0.0.1:27018/

âš ï¸  CRITICAL: Using IN-MEMORY database ONLY
   âš ï¸  NO connections to local MongoDB (localhost:27017)
   âœ… Memory Server Port: 27018
   âœ… Database Name: AmexingTEST

ğŸ”§ Initializing Parse Server...
warn: DeprecationWarning: The Parse Server option 'encodeParseObjectInCloudFunction' default will change to 'true' in a future version.
warn: DeprecationWarning: The Parse Server option 'enableInsecureAuthAdapters' default will change to 'false' in a future version.
warn: DeprecationWarning: insecure adapter is deprecated and will be removed in a future version.
   âœ… Parse Server started
   â„¹ï¸  Server URL: http://localhost:1339/parse

ğŸŒ± Seeding Test Database...
   â„¹ï¸  Starting complete system seed...
   â„¹ï¸  Seeding RBAC system...
   â„¹ï¸  Creating 30 system permissions...
   âœ… Created 30 permissions
   â„¹ï¸  Creating 8 system roles...
   âœ… Created 8 roles
   âœ… RBAC system seeded: 8 roles, 30 permissions
   â„¹ï¸  Creating SuperAdmin test user...
   âœ… SuperAdmin test user created
   â„¹ï¸  Creating test users for all roles...
   âœ… Created 7 test users
   â„¹ï¸  Verifying seed data...
   âœ… Seed data verification passed
   â„¹ï¸    - Roles: 8
   â„¹ï¸    - Permissions: 30
   â„¹ï¸    - Users: 8
   âœ… Complete system seed finished successfully

âœ… Global Test Setup Complete

============================================================
Test environment ready with:
  - MongoDB Memory Server (in-memory)
  - Parse Server configured
  - Complete RBAC system (8 roles + permissions)
  - Test users for all roles
============================================================

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/cloud/getOAuthProviders.test.js
  Parse.Cloud.define("getOAuthProviders") - Initialization Check
    OAuthService Initialization State
      âœ“ should use debug logging when service is not initialized (3 ms)
      âœ“ should use error logging for non-initialization errors (2 ms)
      âœ“ should return providers successfully when service is initialized
    Initialization Error Handling
      âœ“ should gracefully handle "not initialized" errors (1 ms)
      âœ“ should distinguish between startup and runtime errors (1 ms)
    Logging Context
      âœ“ should include timestamp in debug logs
      âœ“ should include phase indicator for startup logs (1 ms)
    Provider Configuration
      âœ“ should map provider configs correctly when initialized
      âœ“ should return empty array during initialization phase (1 ms)
    Error Recovery
      âœ“ should not throw errors during initialization phase
      âœ“ should throw errors for real issues after initialization (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/middleware/authMiddleware.test.js
  Authentication Middleware
    requireAuth
      âœ“ should call next() if user is authenticated (1 ms)
      âœ“ should return 401 if no session token provided (1 ms)
      âœ“ should return 401 if session token is invalid
    requireRole
      âœ“ should call next() if user has required role (1 ms)
      âœ“ should return 403 if user does not have required role (1 ms)
      âœ“ should return 401 if user is not authenticated (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/middleware/jwtMiddleware-rbac.test.js
  JWT Middleware RBAC Functions
    requirePermission
      âœ“ should allow access when user has required permission (1 ms)
      âœ“ should deny access when user lacks required permission
      âœ“ should deny access when user is not authenticated (1 ms)
      âœ“ should pass context to permission check when contextExtractor provided (1 ms)
      âœ“ should handle permission check errors gracefully
    requireRoleLevel
      âœ“ should allow access when user has sufficient role level (1 ms)
      âœ“ should deny access when user has insufficient role level
      âœ“ should deny access when user is not authenticated (1 ms)
      âœ“ should handle exact role level match correctly
      âœ“ should handle role level check errors (1 ms)
    requireOrganizationScope
      âœ“ should handle invalid scope configuration (1 ms)
      âœ“ should deny access when user is not authenticated
      âœ“ should check organization ID from request body (1 ms)
      âœ“ should handle organization scope check errors
      own scope
        âœ“ should allow access to own organization data (1 ms)
        âœ“ should deny access to other organization data
        âœ“ should allow when no specific organization is targeted
      client scope
        âœ“ should allow Amexing users to access any client organization (1 ms)
        âœ“ should limit client users to their own organization
      system scope
        âœ“ should allow Amexing users system access (1 ms)
        âœ“ should deny non-Amexing users system access
    Integration with updated authenticateToken
      âœ“ should attach roleObject from validation result (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/middleware/jwtMiddleware.test.js
  JWT Middleware
    authenticateToken
      âœ“ should authenticate with valid token from cookies (1 ms)
      âœ“ should authenticate with valid token from Authorization header (1 ms)
      âœ“ should return 401 when no token provided
      âœ“ should return 401 when token is expired (1 ms)
      âœ“ should return 401 when token is invalid
      âœ“ should return 401 when user account is deactivated (1 ms)
      âœ“ should return 401 when user account is deleted
    authenticateOptional
      âœ“ should authenticate when valid token is provided (1 ms)
      âœ“ should continue without authentication when no token provided
      âœ“ should continue without authentication when token is invalid
    requireRole
      âœ“ should allow access for user with required role (1 ms)
      âœ“ should allow access for user with one of multiple required roles
      âœ“ should deny access for user without required role (1 ms)
      âœ“ should deny access for unauthenticated user
    autoRefreshToken
      âœ“ should refresh token when access token is missing but refresh token exists
      âœ“ should continue normally when both tokens are present (1 ms)
      âœ“ should continue normally when no tokens are present
      âœ“ should clear invalid refresh token on error
    extractUser
      âœ“ should skip extraction when user is already authenticated via JWT (1 ms)
      âœ“ should extract user from session when no JWT user exists
      âœ“ should continue without user when no authentication exists (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/middleware/securityMiddleware.csrf.test.js
  securityMiddleware - CSRF Persistence Check
    CSRF Persistence Detection
      âœ“ should log error when authenticated user has no CSRF secret (1 ms)
      âœ“ should record metrics for CSRF persistence issues
      âœ“ should still auto-recover by generating new CSRF secret (4 ms)
    Normal Operation (No Persistence Issues)
      âœ“ should not log error for authenticated user with valid CSRF secret
      âœ“ should not log error for unauthenticated user without CSRF secret (1 ms)
    Detection Scenarios
      âœ“ should detect persistence issue after logout without regeneration
      âœ“ should detect persistence issue after session store failure (1 ms)
    Logging Context Validation
      âœ“ should include comprehensive context in error log
    Metrics Integration
      âœ“ should support optional metrics recording (1 ms)
    Edge Cases
      âœ“ should handle session without user object gracefully
      âœ“ should handle malformed user object (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/middleware/sessionRecoveryMiddleware.test.js
  sessionRecoveryMiddleware - Conditional Logging
    âœ“ should have logger and sessionMetrics mocked (1 ms)
    Session Age Detection
      âœ“ should use debug logging for new sessions (< 30 seconds old)
      âœ“ should use warn logging for old sessions (>= 30 seconds old)
    Logging Context Validation
      âœ“ should include session age in debug log context for new sessions (1 ms)
      âœ“ should include session age in warn log context for old sessions
    Edge Cases
      âœ“ should handle session exactly at 30 second threshold (1 ms)
      âœ“ should handle missing createdAt timestamp gracefully
    Recovery Metrics
      âœ“ should record metrics for new session recovery (1 ms)
      âœ“ should record metrics for old session recovery
    Normal Operation (No Recovery Needed)
      âœ“ should not log recovery for sessions with valid CSRF secret (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/application/controllers/authController.js:3:29)
      at Object.<anonymous> (tests/unit/controllers/authController.logout.test.js:15:24)

PASS tests/unit/controllers/authController.logout.test.js
  authController.logout() - Session Regeneration
    Session Regeneration on Logout
      âœ“ should regenerate session instead of destroying it (2 ms)
      âœ“ should generate new CSRF secret for regenerated session (1 ms)
      âœ“ should save regenerated session before redirect
      âœ“ should redirect to home page after successful logout (153 ms)
    Parse Session Token Cleanup
      âœ“ should call Parse.User.logOut with session token (1 ms)
      âœ“ should handle missing session token gracefully (1 ms)
      âœ“ should handle Parse.User.logOut failure gracefully (1 ms)
    Error Handling in Regeneration
      âœ“ should fallback to destroy if regenerate fails (1 ms)
      âœ“ should log error if session save fails (152 ms)
    CSRF Secret Validation
      âœ“ should generate CSRF secret with correct format (2 ms)
    Integration with Session Recovery Middleware
      âœ“ should create session that does not trigger auto-recovery warnings (2 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/application/controllers/authController.js:3:29)
      at Object.<anonymous> (tests/unit/controllers/authController.test.js:33:24)

PASS tests/unit/controllers/authController.test.js
  Authentication Controller
    login
      âœ“ should render login page for GET request (2 ms)
      âœ“ should authenticate user and redirect on successful login (1 ms)
      âœ“ should render login page with error on failed login
      âœ“ should return JSON response for API requests (1 ms)
    logout
      âœ“ should logout user and redirect to home (151 ms)
      âœ“ should return JSON response for API requests (155 ms)
    register
      âœ“ should render register page for GET request (3 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/models/Permission.test.js
  Permission Model
    Permission Creation
      âœ“ should create permission with valid data (1 ms)
      âœ“ should auto-generate name from resource and action (1 ms)
      âœ“ should validate required fields (1 ms)
      âœ“ should set default values correctly (1 ms)
    Contextual Conditions
      âœ“ should validate amount conditions
      âœ“ should validate time conditions (1 ms)
      âœ“ should validate department scope
      âœ“ should handle multiple conditions correctly (1 ms)
    Permission Categories
      âœ“ should identify system permissions
      âœ“ should check delegatability
    Static Factory Methods
      âœ“ should create system permissions (1 ms)
      âœ“ should validate system permission structure (8 ms)
      âœ“ should include contextual permissions (1 ms)
    Permission Inheritance
      âœ“ should check if permission inherits from another
      âœ“ should handle hierarchical permissions (1 ms)
    Permission Validation
      âœ“ should validate permission names
      âœ“ should validate condition structure (1 ms)
    Business Hours Validation
      âœ“ should identify business hours correctly
      âœ“ should handle timezone considerations (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/models/AmexingUser-rbac.test.js
  AmexingUser RBAC Integration
    User Creation with RBAC
      âœ“ should create user with roleId instead of role string (2 ms)
      âœ“ should handle backward compatibility with role string
      âœ“ should set default contextual data structure (1 ms)
    Permission Checking
      âœ“ should check direct role permissions (1 ms)
      âœ“ should check contextual permissions
      âœ“ should check delegated permissions when role lacks permission (1 ms)
      âœ“ should combine user contextual data with request context (1 ms)
      âœ“ should handle permission check errors gracefully
    Permission Delegation
      âœ“ should delegate permissions to other users (2 ms)
      âœ“ should prevent delegation when role does not allow it (6 ms)
      âœ“ should validate delegation context constraints
    Role Management
      âœ“ should retrieve role information (1 ms)
      âœ“ should cache role information
      âœ“ should check if user can manage another user
    Organization Scope
      âœ“ should validate organization access (1 ms)
      âœ“ should restrict client users to own organization
    Legacy Compatibility
      âœ“ should support legacy role string queries during migration
      âœ“ should handle mixed role/roleId scenarios (1 ms)
    Data Validation
      âœ“ should validate required RBAC fields (1 ms)
      âœ“ should validate organization ID format
      âœ“ should validate contextual data structure
    Performance Optimization
      âœ“ should batch role and permission queries when possible (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/models/DelegatedPermission.test.js
  DelegatedPermission Model
    Delegation Creation
      âœ“ should create delegation with valid data (13 ms)
      âœ“ should set default values correctly
      âœ“ should validate required fields (2 ms)
      âœ“ should prevent self-delegation
    Permission Validation
      âœ“ should validate permission with matching context (1 ms)
      âœ“ should deny permission with invalid context
      âœ“ should deny different permissions
      âœ“ should check expiration
      âœ“ should check if delegation is active
    Usage Tracking
      âœ“ should track permission usage (1 ms)
      âœ“ should enforce usage limits (1 ms)
      âœ“ should handle unlimited usage when no limit set
    Delegation Management
      âœ“ should revoke delegation (1 ms)
      âœ“ should extend expiration
      âœ“ should prevent extending to past date (1 ms)
    Context Validation
      âœ“ should validate amount constraints
      âœ“ should validate department constraints (1 ms)
      âœ“ should validate time constraints
    Audit Trail
      âœ“ should maintain complete audit trail (1 ms)
      âœ“ should generate audit report
    Static Query Methods
      âœ“ should find delegations for user (1 ms)
      âœ“ should find delegations by delegator

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/models/Role.test.js
  Role Model
    Role Creation
      âœ“ should create a role with valid data (2 ms)
      âœ“ should set default values correctly
      âœ“ should validate required name field (1 ms)
    Permission Management
      âœ“ should check if role has permission (1 ms)
      âœ“ should check system permissions
      âœ“ should handle contextual permissions (1 ms)
    Role Hierarchy
      âœ“ should return correct level for role
      âœ“ should check if role can manage another role
      âœ“ should handle equal levels correctly (1 ms)
    Permission Delegation
      âœ“ should check delegation permissions
      âœ“ should prevent delegation when not allowed
    Organization Scope
      âœ“ should validate organization access correctly
      âœ“ should handle cross-client access for system roles
    Static Factory Methods
      âœ“ should create system roles correctly (1 ms)
      âœ“ should validate system role hierarchy
    Permission Inheritance
      âœ“ should inherit permissions from lower level roles (1 ms)
    Role Validation
      âœ“ should validate role names
      âœ“ should validate level ranges (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/organisms/clients-table.test.js
  Clients Table Component - Function Logic
    toggleClientStatus - Logic Tests
      âœ“ should activate client when current status is false (2 ms)
      âœ“ should deactivate client when current status is true (1 ms)
      âœ“ should not call API if user cancels confirmation (1 ms)
      âœ“ should handle API error response
      âœ“ should handle network error (1 ms)
      âœ“ should handle response.ok false with success true
      âœ“ should handle response.ok true with success false (1 ms)
      âœ“ should use default error message when no error provided
      âœ“ should include correct headers in request (1 ms)
    deleteClient - Logic Tests
      âœ“ should delete client successfully
      âœ“ should not delete if user cancels (1 ms)
      âœ“ should handle delete API error
      âœ“ should handle network error during delete (1 ms)
      âœ“ should use default error message when none provided
      âœ“ should handle empty client name
      âœ“ should include correct headers in delete request (1 ms)
      âœ“ should handle response with success but no ok flag
    API Response Validation
      âœ“ should validate both response.ok and result.success for toggle (1 ms)
      âœ“ should validate both response.ok and result.success for delete (1 ms)
    Error Message Handling
      âœ“ should use API error message when available
      âœ“ should use default error message when API error is empty (1 ms)
      âœ“ should use default error message when API error is undefined
    Confirmation Dialog Logic
      âœ“ should create correct activation confirmation message
      âœ“ should create correct deactivation confirmation message (1 ms)
      âœ“ should create correct delete confirmation message
    Success Message Generation
      âœ“ should generate correct activation success message (1 ms)
      âœ“ should generate correct deactivation success message
      âœ“ should generate correct delete success message

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/routes/clientsRoutes.test.js
  ClientsRoutes - Middleware & Permissions
    validateClientAccess middleware
      âœ“ should allow superadmin access (16 ms)
      âœ“ should allow admin access
      âœ“ should allow employee_amexing with clients.view permission (1 ms)
      âœ“ should deny employee_amexing without clients.view permission
      âœ“ should deny unauthorized roles (1 ms)
    Route Structure
      âœ“ should have GET /api/clients route
      âœ“ should have POST /api/clients route (1 ms)
      âœ“ should have PUT /api/clients/:id route
      âœ“ should have PATCH /api/clients/:id route (1 ms)
      âœ“ should have DELETE /api/clients/:id route
    Rate Limiting
      âœ“ should apply rate limiting to read operations
      âœ“ should apply stricter rate limiting to write operations (1 ms)
    Security Headers
      âœ“ should require authentication for all routes
    Permission Hierarchy
      âœ“ SuperAdmin should have full access
      âœ“ Admin should have full access (1 ms)
      âœ“ Employee Amexing needs permission
      âœ“ Client should be denied (1 ms)
      âœ“ Department Manager should be denied
      âœ“ Employee should be denied
      âœ“ Driver should be denied (1 ms)
      âœ“ Guest should be denied
    Error Handling
      âœ“ should handle middleware errors gracefully (1 ms)
    Swagger Documentation
      âœ“ should have complete API documentation
    Request Validation
      âœ“ should validate required parameters for POST requests
      âœ“ should validate ID parameter format for PUT/PATCH/DELETE (1 ms)
    Response Format
      âœ“ should return consistent JSON response format
    CORS & Security
      âœ“ should handle CORS appropriately
      âœ“ should prevent CSRF attacks (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/utils/pricingHelper.test.js
  PricingHelper Unit Tests
    calculateSurcharge
      âœ“ should calculate surcharge correctly with system setting (2 ms)
      âœ“ should calculate surcharge with custom percentage (1 ms)
      âœ“ should return 0 for zero base price
      âœ“ should return 0 for negative base price (4 ms)
      âœ“ should round to 2 decimal places (1 ms)
    calculatePriceWithSurcharge
      âœ“ should calculate total price correctly
      âœ“ should calculate total price with custom percentage (1 ms)
    getPriceBreakdown
      âœ“ should return complete price breakdown
      âœ“ should handle small prices correctly (1 ms)
      âœ“ should handle large prices correctly
    calculateBasePriceFromTotal
      âœ“ should calculate base price from total price (1 ms)
      âœ“ should work with custom percentage
      âœ“ should be inverse of calculatePriceWithSurcharge (1 ms)
    formatMXN
      âœ“ should format Mexican pesos correctly (10 ms)
      âœ“ should format zero correctly
      âœ“ should format large numbers with commas
      âœ“ should handle null/undefined as zero (1 ms)
    formatNumber
      âœ“ should format number with 2 decimals
      âœ“ should add decimal places if needed
    getBulkPriceBreakdown
      âœ“ should calculate breakdowns for multiple items (1 ms)
      âœ“ should use same percentage for all items (1 ms)
    getCurrentSurchargePercentage
      âœ“ should retrieve current surcharge percentage
    clearCache
      âœ“ should call SettingsService clearCache (1 ms)
    edge cases
      âœ“ should handle decimal base prices
      âœ“ should handle very small surcharge percentages (1 ms)
      âœ“ should handle 100% surcharge

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/services/AuthenticationService.test.js
  AuthenticationService
    registerUser
      âœ“ should successfully register a new user (2 ms)
      âœ“ should validate required fields (1 ms)
      âœ“ should validate email format (1 ms)
      âœ“ should validate username format
    loginUser
      âœ“ should successfully login with valid credentials (1 ms)
      âœ“ should fail with invalid password (1 ms)
      âœ“ should fail with locked account
      âœ“ should fail with inactive account (1 ms)
      âœ“ should fail with non-existent user
    refreshToken
      âœ“ should successfully refresh token (1 ms)
      âœ“ should fail with invalid token type
      âœ“ should fail with inactive user
    validateToken
      âœ“ should successfully validate access token (1 ms)
      âœ“ should fail with invalid token type
      âœ“ should fail with expired token
    generateTokens
      âœ“ should generate access and refresh tokens (1 ms)
    password reset
      initiatePasswordReset
        âœ“ should initiate password reset for existing user (1 ms)
        âœ“ should return success message even for non-existent user
      resetPassword
        âœ“ should successfully reset password with valid token
        âœ“ should fail with invalid or expired token (1 ms)
    utility methods
      maskEmail
        âœ“ should mask email addresses correctly
        âœ“ should handle empty email
        âœ“ should handle null email (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/services/BulkImportService.test.js
  BulkImportService
    normalizeColumnName
      âœ“ should normalize column names correctly (5 ms)
      âœ“ should handle empty values (1 ms)
    isColumnMatch
      âœ“ should match column names correctly (1 ms)
      âœ“ should not match unrelated columns
    validateExcelFile
      âœ“ should reject non-existent files (2 ms)
      âœ“ should reject files larger than 10MB (1 ms)
    generateErrorReport
      âœ“ should generate Excel error report with correct structure (31 ms)
    Configuration
      âœ“ should have correct default configuration (1 ms)
      âœ“ should have column mappings for localization (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/services/VehicleTypeService.test.js
  VehicleTypeService
    toggleVehicleTypeStatus
      âœ“ should toggle vehicle type status to inactive successfully (5 ms)
      âœ“ should toggle vehicle type status to active successfully (1 ms)
      âœ“ should require authentication
      âœ“ should require vehicle type ID
      âœ“ should validate target status is boolean
      âœ“ should handle vehicle type not found (1 ms)
      âœ“ should validate user permissions
      âœ“ should handle database errors (1 ms)
      âœ“ should allow superadmin to toggle status
      âœ“ should allow employee_amexing to toggle status
    softDeleteVehicleType
      âœ“ should soft delete vehicle type successfully
      âœ“ should prevent deletion if vehicles are using the type (1 ms)
      âœ“ should require authentication
      âœ“ should only allow SuperAdmin and Admin to delete
      âœ“ should handle vehicle type not found (1 ms)
    transformVehicleTypeToSafeFormat
      âœ“ should transform vehicle type to safe format
      âœ“ should handle missing optional fields with defaults

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/controllers/api/ClientEmployeesController.test.js
  ClientEmployeesController
    getEmployees
      âœ“ should return employees list successfully (2 ms)
      âœ“ should filter by role when provided (1 ms)
      âœ“ should return 401 if user not authenticated (1 ms)
      âœ“ should return 400 if clientId not provided
    createEmployee
      âœ“ should create employee with client role successfully (1 ms)
      âœ“ should create employee with employee role successfully (1 ms)
      âœ“ should return 403 if user is not admin or superadmin (1 ms)
      âœ“ should return 400 if required fields are missing
      âœ“ should return 400 if role is invalid (1 ms)
      âœ“ should return 400 if email format is invalid (1 ms)
    toggleEmployeeStatus
      âœ“ should toggle employee status successfully (1 ms)
      âœ“ should return 400 if active is not boolean
      âœ“ should return 403 if employee does not belong to client (1 ms)
      âœ“ should handle permission denied from service
      âœ“ should enrich currentUser with role when missing (1 ms)
    deactivateEmployee
      âœ“ should deactivate employee successfully (1 ms)
      âœ“ should return 403 if user is not admin or superadmin
    updateEmployee
      âœ“ should update employee successfully (1 ms)
      âœ“ should return 400 if trying to change to invalid role (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/controllers/api/ClientsController.test.js
  ClientsController
    getClients
      âœ“ should retrieve clients successfully (2 ms)
      âœ“ should handle pagination parameters (1 ms)
      âœ“ should handle filter parameters (1 ms)
      âœ“ should enforce maximum page size limit
      âœ“ should handle service errors (1 ms)
    createClient
      âœ“ should create client successfully (1 ms)
      âœ“ should force department_manager role (1 ms)
      âœ“ should validate required fields
      âœ“ should handle duplicate email error (1 ms)
    updateClient
      âœ“ should update client successfully (1 ms)
      âœ“ should prevent role changes
      âœ“ should handle not found error (1 ms)
    deactivateClient
      âœ“ should deactivate client successfully (set active: false)
      âœ“ should handle not found error (1 ms)
    toggleClientStatus
      âœ“ should toggle client status to active successfully
      âœ“ should toggle client status to inactive successfully (1 ms)
      âœ“ should require authentication
      âœ“ should validate client ID is provided (1 ms)
      âœ“ should validate active status is boolean
      âœ“ should handle service errors (1 ms)
      âœ“ should use correct parameter order for service call
    parseQueryParams
      âœ“ should parse pagination parameters correctly (1 ms)
      âœ“ should use default values for missing parameters
      âœ“ should parse filter parameters (1 ms)
      âœ“ should enforce maximum page size
      âœ“ should handle invalid boolean strings (1 ms)
    Error handling
      âœ“ should send proper error response format (1 ms)
      âœ“ should send proper success response format

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/controllers/api/EmployeesController.test.js
  EmployeesController
    getEmployees
      âœ“ should return employees list successfully (2 ms)
      âœ“ should return 401 if user not authenticated (1 ms)
      âœ“ should call service even with employee role (permission check in middleware)
    toggleEmployeeStatus
      âœ“ should toggle employee status successfully (1 ms)
      âœ“ should handle permission denied from service (1 ms)
      âœ“ should enrich currentUser with role when missing
      âœ“ should return 401 if user not authenticated (1 ms)
      âœ“ should return 400 if active is not boolean
      âœ“ should return 400 if employee ID is missing
      âœ“ should return 403 if user is not admin or superadmin (1 ms)
    deactivateEmployee
      âœ“ should deactivate employee successfully
      âœ“ should return 401 if user not authenticated (1 ms)
      âœ“ should return 403 if user is not admin or superadmin
      âœ“ should return 400 if employee ID is missing (1 ms)
      âœ“ should handle service errors gracefully
    updateEmployee
      âœ“ should update employee successfully
      âœ“ should prevent role change from employee_amexing (1 ms)
      âœ“ should return 401 if user not authenticated
      âœ“ should return 403 if user is not admin or superadmin (1 ms)
    createEmployee
      âœ“ should create employee successfully (1 ms)
      âœ“ should return 400 if required fields are missing
      âœ“ should return 403 if user is not admin or superadmin (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/controllers/api/ExperienceController.test.js
  ExperienceController
    getExperiences
      âœ“ should retrieve experiences with DataTables pagination successfully (1 ms)
      âœ“ should filter by type parameter (Experience) (1 ms)
      âœ“ should filter by type parameter (Provider)
      âœ“ should handle search parameter (1 ms)
      âœ“ should return empty array when no results
      âœ“ should handle authentication errors (1 ms)
      âœ“ should handle database errors gracefully (1 ms)
    getExperienceById
      âœ“ should retrieve single experience by ID
      âœ“ should include related experiences (array of pointers) (1 ms)
      âœ“ should return 404 when experience not found
    createExperience
      âœ“ should create experience with valid data (1 ms)
      âœ“ should validate required fields
      âœ“ should reject invalid type (4 ms)
      âœ“ should handle array of experiences (max 20) (1 ms)
      âœ“ should reject more than 20 experiences
      âœ“ should set active=true and exists=true by default
    updateExperience
      âœ“ should update experience with valid data (1 ms)
      âœ“ should validate max 20 experiences on update
      âœ“ should return 404 if experience not found
    deleteExperience
      âœ“ should soft delete experience (exists=false)
      âœ“ should require authentication
      âœ“ should return 404 if experience not found
      âœ“ should log deletion with user audit trail

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/controllers/api/RolesController.test.js
  RolesController
    updateRole
      Success Cases
        âœ“ should successfully update displayName when all validations pass (2 ms)
        âœ“ should trim whitespace from displayName before saving
        âœ“ should handle user role from different sources (req.userRole) (1 ms)
        âœ“ should handle user role from user.get() method
        âœ“ should handle user role from user.role property (1 ms)
      Authentication & Authorization
        âœ“ should return 401 when user is not authenticated
        âœ“ should return 403 when user is not superadmin (1 ms)
        âœ“ should return 403 for employee role
        âœ“ should return 403 for departmentmanager role
      Input Validation
        âœ“ should return 400 when roleId is missing (1 ms)
        âœ“ should return 400 when neither displayName nor description provided
        âœ“ should return 400 when only displayName provided but is empty
        âœ“ should return 400 when displayName is only whitespace (1 ms)
        âœ“ should return 400 when displayName is not a string
        âœ“ should return 400 when displayName exceeds 100 characters (1 ms)
        âœ“ should accept displayName with exactly 100 characters
        âœ“ should return 400 when displayName is same as current
        âœ“ should return 400 when displayName with whitespace equals current and no description (1 ms)
      Error Handling
        âœ“ should return 404 when role does not exist
        âœ“ should handle Parse query errors gracefully (1 ms)
        âœ“ should handle role save errors gracefully (1 ms)
        âœ“ should show detailed error in development environment
        âœ“ should hide error details in production environment (1 ms)
      Security
        âœ“ should only update displayName field, not other fields
        âœ“ should use useMasterKey for query operations (1 ms)
        âœ“ should use useMasterKey for save operations
        âœ“ should query only roles with exists=true
      Audit Logging
        âœ“ should log successful update with complete details (1 ms)
        âœ“ should log unauthorized access attempts
        âœ“ should log errors with stack trace

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/controllers/api/VehicleTypeController.test.js
  VehicleTypeController
    toggleVehicleTypeStatus
      âœ“ should toggle vehicle type status to inactive successfully (2 ms)
      âœ“ should toggle vehicle type status to active successfully
      âœ“ should require authentication (1 ms)
      âœ“ should require vehicle type ID
      âœ“ should validate active is a boolean
      âœ“ should handle service returning failure (1 ms)
      âœ“ should handle service throwing error (1 ms)
      âœ“ should add role to currentUser before calling service
      âœ“ should handle user role from user.get() method
    sendSuccess
      âœ“ should send success response with correct format
      âœ“ should send success response with custom status code
    sendError
      âœ“ should send error response with correct format
      âœ“ should default to status 500 if not provided

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/routes/api/rolesRoutes.test.js
  Roles Routes
    Route Registration
      âœ“ should register GET / route (42 ms)
      âœ“ should register GET /:id route (23 ms)
      âœ“ should register PUT /:id route (31 ms)
      âœ“ should pass route parameters correctly to GET /:id (23 ms)
      âœ“ should pass route parameters correctly to PUT /:id (23 ms)
    Middleware Application
      âœ“ should apply JWT authentication middleware to all routes (22 ms)
      âœ“ should apply JWT middleware to GET /:id route (23 ms)
      âœ“ should apply JWT middleware to PUT /:id route (27 ms)
      âœ“ should attach user to request via JWT middleware (23 ms)
      âœ“ should block requests when JWT middleware rejects (41 ms)
    SuperAdmin Authorization Middleware
      âœ“ should allow superadmin role to access routes (48 ms)
      âœ“ should reject non-superadmin roles (admin) (41 ms)
      âœ“ should reject non-superadmin roles (employee) (43 ms)
      âœ“ should reject requests without userRole (47 ms)
    HTTP Methods
      âœ“ should support GET method for / route (24 ms)
      âœ“ should not support POST method for / route (24 ms)
      âœ“ should not support DELETE method for / route (24 ms)
      âœ“ should support GET method for /:id route (28 ms)
      âœ“ should support PUT method for /:id route (24 ms)
      âœ“ should not support POST method for /:id route (23 ms)
      âœ“ should not support DELETE method for /:id route (23 ms)
    Request/Response Flow
      âœ“ should pass request object to controller methods (29 ms)
      âœ“ should pass response object to controller methods (24 ms)
      âœ“ should preserve request body for PUT requests (25 ms)
      âœ“ should preserve query parameters for GET requests (25 ms)
      âœ“ should handle JSON content-type correctly (32 ms)
    Error Handling
      âœ“ should handle controller errors gracefully (25 ms)
      âœ“ should handle invalid JSON in request body (25 ms)
      âœ“ should handle missing route parameters (25 ms)
    Integration with Controller
      âœ“ should create RolesController instance on module load (21 ms)
      âœ“ should call controller methods with correct arguments (28 ms)
      âœ“ should maintain proper middleware order (45 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/components/atoms/common/button.test.js
  Button Atom Component
    Basic Rendering
      âœ“ should render with default parameters (2 ms)
      âœ“ should render as a button element by default
    Button Type Parameter
      âœ“ should use custom button type (1 ms)
      âœ“ should handle different button types (1 ms)
      âœ“ should default to button type
    Button Variant Parameter
      âœ“ should apply variant classes (2 ms)
      âœ“ should default to primary variant
    Button Size Parameter
      âœ“ should apply size classes
      âœ“ should handle different sizes (1 ms)
      âœ“ should not apply size class when empty
    Button Text Parameter
      âœ“ should display custom text
      âœ“ should handle empty text
      âœ“ should handle special characters in text
    Icon Parameter
      âœ“ should render icon when provided (1 ms)
      âœ“ should render icon in different positions
      âœ“ should render icon only when no text
    Disabled Parameter
      âœ“ should add disabled attribute when true (1 ms)
      âœ“ should not add disabled attribute when false
    Href Parameter (Link Button)
      âœ“ should render as anchor when href provided
      âœ“ should handle disabled state for link buttons
    Additional Classes Parameter
      âœ“ should apply additional classes
    Additional Attributes Parameter
      âœ“ should apply additional attributes (1 ms)
    Combined Parameters
      âœ“ should handle all parameters together
    HTML Output Validation
      âœ“ should produce valid HTML structure for button
      âœ“ should produce valid HTML structure for link (1 ms)
    Accessibility
      âœ“ should be accessible by default
      âœ“ should maintain accessibility with icons
      âœ“ should handle disabled state accessibility (1 ms)
    Error Handling
      âœ“ should handle null parameters gracefully
      âœ“ should handle undefined parameters gracefully

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/components/atoms/common/icon.test.js
  Icon Atom Component
    Basic Rendering
      âœ“ should render with default parameters (1 ms)
      âœ“ should render as an i element
    Icon Name Parameter
      âœ“ should use custom icon name (1 ms)
      âœ“ should use custom icon name with hyphen
      âœ“ should handle undefined icon name
    Size Parameter
      âœ“ should apply size class when provided (1 ms)
      âœ“ should handle multiple size values (1 ms)
      âœ“ should not apply size class when empty
    Color Parameter
      âœ“ should apply color class when provided
      âœ“ should handle different color values (1 ms)
      âœ“ should not apply color class when empty
    Additional Classes Parameter
      âœ“ should apply additional classes when provided
      âœ“ should handle single additional class
      âœ“ should not apply additional classes when empty
    Combined Parameters
      âœ“ should handle all parameters together
      âœ“ should prioritize parameters correctly (1 ms)
    HTML Output Validation
      âœ“ should produce valid HTML structure
      âœ“ should not contain any text content
      âœ“ should be self-closing element
    Accessibility
      âœ“ should be accessible by default (1 ms)
      âœ“ should work with screen readers when properly labeled
    Error Handling
      âœ“ should handle special characters in parameters

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/components/atoms/common/label.test.js
  Label Atom Component
    Basic Rendering
      âœ“ should render with default parameters (2 ms)
      âœ“ should render as a label element (1 ms)
    Text Parameter
      âœ“ should display custom text
      âœ“ should handle empty text
      âœ“ should handle special characters (1 ms)
    HtmlFor Parameter
      âœ“ should add for attribute when provided
      âœ“ should not add for attribute when empty (1 ms)
      âœ“ should not add for attribute when undefined
    Required Parameter
      âœ“ should show asterisk when required is true
      âœ“ should not show asterisk when required is false (1 ms)
      âœ“ should not show asterisk by default
    Variant Parameter
      âœ“ should apply small variant
      âœ“ should apply large variant (1 ms)
      âœ“ should use default styling when variant is default
    Color Parameter
      âœ“ should apply color class when provided
      âœ“ should handle different color values (1 ms)
      âœ“ should not apply color class when empty
    Additional Classes Parameter
      âœ“ should apply additional classes (1 ms)
      âœ“ should handle single additional class
    Combined Parameters
      âœ“ should handle all parameters together
      âœ“ should prioritize variant classes correctly (1 ms)
    HTML Output Validation
      âœ“ should produce valid HTML structure (1 ms)
      âœ“ should handle required asterisk structure
    Accessibility
      âœ“ should be accessible by default
      âœ“ should maintain accessibility with required indicator
      âœ“ should properly associate with form controls
    Error Handling
      âœ“ should handle null parameters gracefully
      âœ“ should handle undefined parameters gracefully (1 ms)
      âœ“ should handle boolean edge cases

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/components/organisms/dashboard/add-modal.test.js
  Add Modal Organism
    âœ“ should render without parameters (2 ms)
    âœ“ should render without addScripts parameter (2 ms)
    âœ“ should render with addScripts parameter
    âœ“ It must be rendered with the title, description, icon and modalId parameters
    âœ“ It should be rendered with the parameters of text fields, password, selection, and text area. (1 ms)
    âœ“ should render with button save (1 ms)
    âœ“ should render with all parameters (2 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/components/organisms/dashboard/header-navigation.test.js
  Header Navigation Organism
    Basic Rendering
      âœ“ should render with default parameters (3 ms)
      âœ“ should render for each user role (4 ms)
      âœ“ should include navigation structure
    Logo and Branding
      âœ“ should include brand logo (1 ms)
      âœ“ should display role badge with proper styling (1 ms)
      âœ“ should handle department_manager role formatting
    Desktop Navigation Menu
      âœ“ should render desktop navigation sections (1 ms)
      âœ“ should include all superadmin navigation sections (3 ms)
      âœ“ should include all admin navigation sections (1 ms)
      âœ“ should include mega menu dropdowns
      âœ“ should include navigation items with proper links (1 ms)
    Mobile Navigation
      âœ“ should include mobile navigation toggle
      âœ“ should include mobile navigation collapse (1 ms)
      âœ“ should render mobile navigation sections
      âœ“ should include mobile navigation items (1 ms)
    Role-Based Navigation Content
      âœ“ should show correct superadmin navigation (1 ms)
      âœ“ should show correct client navigation
      âœ“ should show correct employee navigation (1 ms)
      âœ“ should show correct driver navigation
    Active State Management
      âœ“ should mark active navigation items (1 ms)
      âœ“ should mark active mobile navigation items
      âœ“ should handle path matching correctly (1 ms)
    Color Scheme and Styling
      âœ“ should apply role-based colors (2 ms)
      âœ“ should include component-specific CSS classes (1 ms)
      âœ“ should include responsive styles
    JavaScript Functionality
      âœ“ should include initialization script (1 ms)
      âœ“ should include mobile toggle functionality
      âœ“ should include dropdown hover effects (1 ms)
      âœ“ should include keyboard navigation
      âœ“ should include analytics tracking (1 ms)
    Accessibility Features
      âœ“ should have proper ARIA attributes
      âœ“ should have proper button types (1 ms)
      âœ“ should include focus styles
      âœ“ should be accessible by default (1 ms)
    Responsive Design
      âœ“ should hide desktop menu on mobile (1 ms)
      âœ“ should show mobile toggle only on mobile
      âœ“ should include responsive logo sizing (1 ms)
      âœ“ should include mobile-specific styles
    Parameter Validation and Defaults
      âœ“ should handle undefined user role gracefully (1 ms)
      âœ“ should handle null parameters gracefully
      âœ“ should use defaults for missing parameters
      âœ“ should handle custom colors parameter (1 ms)
    Performance and Structure
      âœ“ should have efficient HTML structure (1 ms)
      âœ“ should include navigation items for all roles (2 ms)
      âœ“ should maintain consistent structure across roles (1 ms)
    Error Handling
      âœ“ should handle malformed role gracefully (1 ms)
      âœ“ should handle empty currentPath
      âœ“ should handle special characters in parameters (1 ms)
    Print and SEO Optimization
      âœ“ should include print styles
      âœ“ should have semantic HTML structure (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/components/organisms/dashboard/dashboard-header.test.js
  Dashboard Header Organism - Baseline Tests
    Basic Rendering
      âœ“ should render header with default parameters (3 ms)
      âœ“ should render for each user role (3 ms)
      âœ“ should include navbar structure (1 ms)
    Mobile Sidebar Toggle
      âœ“ should include mobile sidebar toggle (1 ms)
      âœ“ should have proper mobile toggle attributes
      âœ“ should include desktop sidebar toggle (1 ms)
    User Menu Dropdown
      âœ“ should render user dropdown with correct structure
      âœ“ should not include chevron down icon (removed in refactoring) (1 ms)
      âœ“ should have user avatar section (1 ms)
      âœ“ should include online status indicator
      âœ“ should show user info on desktop (1 ms)
      âœ“ should include all menu items
      âœ“ should have proper menu item links (1 ms)
    User Avatar Handling
      âœ“ should show avatar image when provided
      âœ“ should show initials when no avatar (1 ms)
      âœ“ should handle single name for initials
      âœ“ should show duplicated avatar in dropdown header (1 ms)
    Role-Based Colors
      âœ“ should apply correct role colors (2 ms)
      âœ“ should display formatted role names (1 ms)
    Responsive Design
      âœ“ should hide user info on mobile (1 ms)
      âœ“ should adjust padding on mobile
    CSS Styles
      âœ“ should include header styles (1 ms)
      âœ“ should include avatar styles
      âœ“ should include basic header styles (dropdown styles moved to molecular component) (1 ms)
    JavaScript Functionality
      âœ“ should include initialization script
      âœ“ should include commented notification functions (1 ms)
    Accessibility
      âœ“ should have proper ARIA attributes
      âœ“ should have tooltip attributes (1 ms)
      âœ“ should have desktop sidebar toggle ARIA attributes
    User Data Validation
      âœ“ should handle undefined user gracefully (1 ms)
      âœ“ should handle empty user object
      âœ“ should extract user data correctly (1 ms)
    Current Order Validation
      âœ“ should have user info first, then avatar (no chevron)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/unit/components/molecules/dashboard/user-menu.test.js
  User Menu Molecule Component
    Basic Rendering
      âœ“ should render with default parameters (2 ms)
      âœ“ should render with user data
      âœ“ should render for each user role (4 ms)
    New Order Validation (User Info First, Avatar Second)
      âœ“ should have user info before avatar in markup
      âœ“ should display user info first and avatar second visually (1 ms)
      âœ“ should have correct CSS order classes
    Avatar as Sole Trigger (No Chevron)
      âœ“ should not include chevron icon
      âœ“ should have dropdown trigger only on user menu button (1 ms)
      âœ“ should have avatar with cursor pointer styling
      âœ“ should have proper ARIA attributes for accessibility
    User Avatar Handling
      âœ“ should show avatar image when provided (1 ms)
      âœ“ should show initials when no avatar
      âœ“ should handle single name for initials
      âœ“ should include online status indicator (1 ms)
      âœ“ should have avatar in trigger button
    Role-Based Colors
      âœ“ should apply correct role colors (1 ms)
      âœ“ should display formatted role names (1 ms)
    Dropdown Menu Content
      âœ“ should include all required menu items
      âœ“ should have proper menu item links with role (1 ms)
      âœ“ should include menu icons
      âœ“ should have logout confirmation
    Responsive Design
      âœ“ should hide user info on mobile (1 ms)
      âœ“ should include responsive CSS classes
      âœ“ should adjust trigger padding on mobile
    CSS Styles and Classes
      âœ“ should include component-specific styles (1 ms)
      âœ“ should include hover effects
      âœ“ should include dropdown animations
      âœ“ should include focus states for accessibility (1 ms)
    JavaScript Functionality
      âœ“ should include initialization script
      âœ“ should include keyboard navigation
      âœ“ should include focus management (1 ms)
    Parameter Validation and Defaults
      âœ“ should handle undefined user gracefully
      âœ“ should handle empty parameters
      âœ“ should use defaults for missing parameters (1 ms)
      âœ“ should extract user data correctly from user object
    Accessibility
      âœ“ should have proper ARIA attributes (1 ms)
      âœ“ should support keyboard navigation
      âœ“ should have tooltip for online status
      âœ“ should be accessible by default (1 ms)
    Component Integration
      âœ“ should have molecular component structure
      âœ“ should maintain Bootstrap compatibility (1 ms)
      âœ“ should work with different viewport sizes
    Error Handling
      âœ“ should handle null parameters gracefully
      âœ“ should handle malformed user data (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/integration/components/dashboard-header-integration.test.js
  Dashboard Header Integration Tests
    Header Integration with User Menu Molecule
      âœ“ should integrate user-menu component correctly (2 ms)
      â—‹ skipped should pass correct parameters to user-menu component
      â—‹ skipped should maintain header structure with integrated component
    Functional Integration Testing
      â—‹ skipped should simulate dropdown functionality in integrated context
      â—‹ skipped should maintain mobile responsiveness after integration
      â—‹ skipped should preserve all header functionality with new component
    Cross-Component Communication
      âœ“ should correctly pass role colors between components (2 ms)
      âœ“ should maintain parameter compatibility between components (1 ms)
      â—‹ skipped should handle user data propagation correctly
    Performance and Structure Integration
      âœ“ should maintain header performance with molecular component (1 ms)
      âœ“ should maintain CSS encapsulation between components
      â—‹ skipped should reduce header complexity through componentization
    Accessibility Integration
      âœ“ should provide proper keyboard navigation integration (1 ms)
      â—‹ skipped should maintain accessibility standards after integration
    Regression Prevention
      âœ“ should maintain online status indicator after refactoring
      âœ“ should preserve responsive behavior after integration
      âœ“ should maintain all role-based functionality (5 ms)
      â—‹ skipped should preserve all original menu items after refactoring
    Error Handling Integration
      âœ“ should handle component errors gracefully (1 ms)
      âœ“ should maintain header structure even with component failures
    New Functionality Validation
      âœ“ should confirm new user info first, avatar second order (1 ms)
      âœ“ should confirm no chevron icon in integrated header
      âœ“ should confirm avatar is the sole trigger (1 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/services-rate-filter.test.js:28:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/services-rate-filter.test.js:28:11)

PASS tests/integration/api/services-rate-filter.test.js (5.292 s)
  Services Rate Filtering Integration
    GET /api/services with rateId filter
      âœ“ should filter services by specific rate (Premium) (280 ms)
      âœ“ should filter services by specific rate (Standard) (168 ms)
      âœ“ should return empty array for non-existent rate (153 ms)
      âœ“ should return all services when no rateId filter is provided (158 ms)
    Combined filters: rateId + serviceType
      âœ“ should filter by rate + serviceType (Aeropuerto) (161 ms)
      âœ“ should filter by rate + serviceType (Punto a Punto) (165 ms)
      âœ“ should filter by rate + serviceType (Local) (181 ms)
    Combined filters: rateId + search
      âœ“ should combine rateId filter with POI search (171 ms)
      âœ“ should handle empty rateId parameter (treated as no filter) (151 ms)
    Triple filter: rateId + serviceType + search
      âœ“ should combine all three filters successfully (164 ms)
    Edge cases and validation
      âœ“ should handle malformed rateId gracefully (145 ms)
      âœ“ should work with pagination when filtering by rate (189 ms)
      âœ“ should not break existing functionality without filter (150 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/integration/services/UserManagementService.test.js
  UserManagementService Integration Tests
    toggleUserStatus
      âœ“ should toggle user status with admin permissions (29 ms)
      âœ“ should toggle user status with superadmin permissions (22 ms)
      âœ“ should allow employee to toggle another employee (same level) (22 ms)
      âœ“ should handle activation of inactive user (32 ms)
      âœ“ should throw error for non-existent user (18 ms)
      âœ“ should maintain exists: true during toggle (39 ms)
    canModifyUser
      âœ“ should allow admin to modify employee
      âœ“ should allow superadmin to modify admin (1 ms)
      âœ“ should deny employee to modify admin
      âœ“ should allow employee to modify another employee (same level)
      âœ“ should deny admin to modify superadmin
      âœ“ should handle currentUser without role property
      âœ“ should use role property if available (1 ms)
    deactivateUser
      âœ“ should soft delete user with admin (28 ms)
      âœ“ should not physically delete from database (21 ms)
      âœ“ should allow employee to deactivate another employee (same level) (19 ms)
      âœ“ should prevent self-deactivation (12 ms)
    reactivateUser
      âœ“ should reactivate soft deleted user with admin (20 ms)
      âœ“ should allow employee to reactivate another employee (same level) (21 ms)
      âœ“ should throw error when trying to reactivate already active user (24 ms)
    Role Hierarchy Validation
      âœ“ should respect role hierarchy in modification (1 ms)
      âœ“ should prevent modification of higher role levels
      âœ“ should allow modification of same role level (1 ms)
    Data Persistence Verification
      âœ“ should persist status changes across multiple queries (33 ms)
      âœ“ should persist soft delete state (19 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/application.startup.test.js:14:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/application.startup.test.js:14:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"message":"CORS blocked request from origin: http://localhost:1337","level":"warn"}

      305 |           callback(null, true);
      306 |         } else {
    > 307 |           winston.warn(`CORS blocked request from origin: ${origin}`);
          |                   ^
      308 |           callback(new Error('Not allowed by CORS'));
      309 |         }
      310 |       },

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.<computed> [as warn] (node_modules/winston/lib/winston/create-logger.js:81:14)
      at Object.exports.<computed> [as warn] (node_modules/winston/lib/winston.js:110:68)
      at origin (src/infrastructure/security/securityMiddleware.js:307:19)
      at node_modules/cors/lib/index.js:219:13
      at optionsCallback (node_modules/cors/lib/index.js:199:9)
      at corsMiddleware (node_modules/cors/lib/index.js:204:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at internalNext (node_modules/helmet/index.cjs:537:6)
      at xXssProtectionMiddleware (node_modules/helmet/index.cjs:315:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xPoweredByMiddleware (node_modules/helmet/index.cjs:308:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xFrameOptionsMiddleware (node_modules/helmet/index.cjs:285:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xDownloadOptionsMiddleware (node_modules/helmet/index.cjs:265:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xDnsPrefetchControlMiddleware (node_modules/helmet/index.cjs:258:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xContentTypeOptionsMiddleware (node_modules/helmet/index.cjs:250:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at strictTransportSecurityMiddleware (node_modules/helmet/index.cjs:243:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at referrerPolicyMiddleware (node_modules/helmet/index.cjs:211:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at originAgentClusterMiddleware (node_modules/helmet/index.cjs:186:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at crossOriginResourcePolicyMiddleware (node_modules/helmet/index.cjs:179:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at crossOriginOpenerPolicyMiddleware (node_modules/helmet/index.cjs:163:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at contentSecurityPolicyMiddleware (node_modules/helmet/index.cjs:128:4)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at helmetMiddleware (node_modules/helmet/index.cjs:539:6)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/infrastructure/security/securityMiddleware.js:577:16
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/infrastructure/security/securityMiddleware.js:560:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/application/middleware/sessionRecoveryMiddleware.js:189:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/application/middleware/sessionRecoveryMiddleware.js:143:7

PASS tests/integration/application.startup.test.js
  Application Startup Validation
    Server Initialization
      âœ“ should start the Express server successfully (66 ms)
      âœ“ should have proper environment configuration (11 ms)
    Parse Server Integration
      âœ“ should initialize Parse Server successfully (16 ms)
      âœ“ should handle Parse Server API endpoints (15 ms)
    Database Connectivity
      âœ“ should connect to MongoDB successfully (15 ms)
      âœ“ should handle database connection gracefully when unavailable (13 ms)
    Security Middleware Loading
      âœ“ should load all security middleware successfully (54 ms)
      âœ“ should apply rate limiting middleware (5 ms)
      âœ“ should load CORS middleware with proper configuration (8 ms)
    Route Registration
      âœ“ should register web routes successfully (4 ms)
      âœ“ should register API routes successfully (4 ms)
      âœ“ should register documentation routes successfully (8 ms)
      âœ“ should handle Parse Server routes (6 ms)
    Static Asset Serving
      âœ“ should serve static assets from public directory (6 ms)
    Error Handling Setup
      âœ“ should have proper 404 error handling (7 ms)
      âœ“ should handle API errors properly (3 ms)
    Session Management
      âœ“ should initialize session store successfully (3 ms)
    Logging System
      âœ“ should initialize logging system successfully (9 ms)
    Metrics Endpoint
      âœ“ should provide system metrics (9 ms)
    Security Configuration Validation
      âœ“ should have PCI DSS compliant session timeout (1 ms)
      âœ“ should enable audit logging in development
      âœ“ should have proper password complexity requirements
    Performance Validation
      âœ“ should respond to health checks quickly (10 ms)
      âœ“ should handle concurrent requests (74 ms)
    Environment-Specific Configuration
      âœ“ should run in test mode during testing (1 ms)
      âœ“ should have appropriate settings for the environment

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/integration/parseServer.test.js
  Parse Server Integration
    User Queries
      âœ“ should query existing seeded users (7 ms)
      âœ“ should authenticate seeded superadmin user (182 ms)
      âœ“ should reject authentication with incorrect password (183 ms)
      âœ“ should query users by role (7 ms)
    Object Management
      âœ“ should create and retrieve test objects (20 ms)
      âœ“ should update objects (16 ms)
      âœ“ should perform logical deletion (13 ms)
    Query Operations
      âœ“ should find seeded roles (3 ms)
      âœ“ should find seeded permissions (5 ms)
      âœ“ should perform complex queries on roles (5 ms)
      âœ“ should count objects correctly (4 ms)
      âœ“ should limit and skip results (4 ms)
    Parse Server Health
      âœ“ should connect to Parse Server (3 ms)
      âœ“ should support masterKey operations (4 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/integration/seed-system.test.js
  Seed System Verification
    RBAC System Seeding
      System Roles
        âœ“ should have all 8 system roles created (9 ms)
        âœ“ should have roles with correct names (4 ms)
        âœ“ should have roles with correct hierarchy levels (4 ms)
        âœ“ should have roles marked as system roles (4 ms)
        âœ“ should have roles with display names (4 ms)
      System Permissions
        âœ“ should have system permissions created (5 ms)
        âœ“ should have permissions with required fields (9 ms)
    SuperAdmin Seeding
      âœ“ should have SuperAdmin user created (4 ms)
      âœ“ should have SuperAdmin with correct role (4 ms)
      âœ“ should have SuperAdmin with correct attributes (3 ms)
      âœ“ should have SuperAdmin with test context data (4 ms)
    Test Users Seeding
      âœ“ should have test users for all 8 roles (30 ms)
      âœ“ should have test users with correct role assignments (33 ms)
      âœ“ should have test users marked as test users (4 ms)
      âœ“ should have test users with standard attributes (5 ms)
      âœ“ should have hierarchical users with correct organizational data (10 ms)
    Authentication Verification
      âœ“ should allow authentication with all test users (1478 ms)
      âœ“ should get valid session tokens for all roles (1473 ms)
      âœ“ should verify user roles match credentials (32 ms)
    Data Integrity Verification
      âœ“ should have valid roleId references (no broken pointers) (5 ms)
      âœ“ should have unique email addresses (4 ms)
      âœ“ should have valid test domain emails (4 ms)
      âœ“ should verify seeded data integrity via TestCleanupHelper (35 ms)
    AuthTestHelper Integration
      âœ“ should provide correct credentials for all roles
      âœ“ should get credentials for each role
      âœ“ should get user objects for all roles (28 ms)
    System Readiness
      âœ“ should have complete test environment ready (1492 ms)
      âœ“ should match production seed configuration (4 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/auth.test.js:14:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/auth.test.js:14:11)

PASS tests/integration/api/auth.test.js
  Authentication API
    POST /auth/login
      âœ“ should login with valid credentials (245 ms)
      âœ“ should reject invalid credentials (23 ms)
      âœ“ should validate required fields (3 ms)
      âœ“ should handle malformed JSON (6 ms)
    POST /auth/register
      âœ“ should register new user with valid data (11 ms)
      âœ“ should reject duplicate email (9 ms)
      âœ“ should validate password requirements (8 ms)
      âœ“ should validate email format (9 ms)
    POST /logout
      âœ“ should logout authenticated user (208 ms)
      âœ“ should handle logout without session (4 ms)
    Rate Limiting
      âœ“ should apply rate limiting to login attempts (109 ms)
    Session Management
      âœ“ should create session on successful login (200 ms)
      âœ“ should maintain session across requests (208 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/employees.test.js:23:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/employees.test.js:23:11)

  console.log
    [DEBUG] checkExistingUser - Checking email: test-employee-1762835209004@amexing.test

      at UserManagementService.checkExistingUser (src/application/services/UserManagementService.js:1542:15)

  console.log
    [DEBUG] checkExistingUser - Found existing user: null

      at UserManagementService.checkExistingUser (src/application/services/UserManagementService.js:1549:15)

PASS tests/integration/api/employees.test.js
  Employees API Integration Tests
    GET /api/employees
      âœ“ should return employees list for superadmin (57 ms)
      âœ“ should return employees list for admin (47 ms)
      âœ“ should return 403 for employee role (25 ms)
      âœ“ should return 401 without authentication (4 ms)
      âœ“ should filter by active status (47 ms)
      âœ“ should support pagination (50 ms)
    POST /api/employees
      âœ“ should create employee with superadmin (53 ms)
      âœ“ should return 400 if required fields missing (26 ms)
      âœ“ should return 403 for employee role (27 ms)
    PATCH /api/employees/:id/toggle-status
      âœ“ should toggle employee status with admin (46 ms)
      âœ“ should toggle employee status with superadmin (42 ms)
      âœ“ should return 403 for employee role (25 ms)
      âœ“ should return 400 if active is not boolean (24 ms)
      âœ“ should return error for non-existent employee (31 ms)
      âœ“ should persist status change across queries (44 ms)
    PUT /api/employees/:id
      âœ“ should update employee with admin (47 ms)
      âœ“ should prevent role change (25 ms)
      âœ“ should return 403 for employee role (24 ms)
    DELETE /api/employees/:id
      âœ“ should soft delete employee with admin (45 ms)
      âœ“ should soft delete employee with superadmin (42 ms)
      âœ“ should return 403 for employee role (29 ms)
      âœ“ should not physically delete from database (41 ms)
    Permission Hierarchy Tests
      âœ“ should prevent employee from modifying other employees (27 ms)
      âœ“ should allow admin to modify employee_amexing (45 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/health.test.js:13:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/health.test.js:13:11)

PASS tests/integration/api/health.test.js
  Health Endpoint
    GET /health
      âœ“ should return health status (55 ms)
      âœ“ should return consistent format (23 ms)
      âœ“ should have correct content type (10 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/vehicle-filtering.test.js:20:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/vehicle-filtering.test.js:20:11)

PASS tests/integration/api/vehicle-filtering.test.js
  Vehicle Filtering by Rate Integration
    GET /api/vehicles with rateId filter
      âœ“ should filter vehicles by specific rate (Premium) (227 ms)
      âœ“ should filter vehicles by specific rate (EstÃ¡ndar) (99 ms)
      âœ“ should return empty array for non-existent rate (90 ms)
      âœ“ should return all vehicles when no rateId filter is provided (118 ms)
      âœ“ should combine rateId filter with search query (98 ms)
      âœ“ should handle empty rateId parameter (treated as no filter) (114 ms)
      âœ“ should work with pagination when filtering by rate (140 ms)
    Filter validation and edge cases
      âœ“ should handle malformed rateId gracefully (94 ms)
      âœ“ should not break existing functionality without filter (124 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/vehicle-images-s3.test.js:33:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/vehicle-images-s3.test.js:33:11)

(node:3664) NOTE: The AWS SDK for JavaScript (v2) is in maintenance mode.
 SDK releases are limited to address critical bug fixes and security issues only.

Please migrate your code to use AWS SDK for JavaScript (v3).
For more information, check the blog post at https://a.co/cUPnyil
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/integration/api/vehicle-images-s3.test.js (10.433 s)
  Vehicle Image S3 Integration
    POST /api/vehicles/:id/images - Direct S3 Upload
      âœ“ should upload image to S3 via direct AWS SDK (932 ms)
      âœ“ should set first image as primary (451 ms)
      âœ“ should store correct file metadata (529 ms)
      âœ“ should reject files over 250MB (416 ms)
      âœ“ should reject invalid file types (29 ms)
      âœ“ should require authentication (6 ms)
      âœ“ should require admin or superadmin role (212 ms)
    GET /api/vehicles/:id/images - List S3 Images
      âœ“ should list images with S3 presigned URLs (45 ms)
      âœ“ should return images ordered by displayOrder (45 ms)
    DELETE /api/vehicles/:id/images/:imageId - S3 Soft Deletion
      âœ“ should soft delete image (set exists=false) (1168 ms)
      âœ“ should move file to deleted/ folder in S3 with encryption (3262 ms)
      âœ“ should require admin or superadmin role for deletion (623 ms)
    Primary Image Reassignment on Deletion
      â—‹ skipped should reassign primary to next image when primary is deleted
      â—‹ skipped should clear vehicle mainImage when last image is deleted
      â—‹ skipped should not change primary when non-primary image is deleted
    S3 Environment Separation
      âœ“ should use correct S3 prefix based on NODE_ENV (1 ms)
      âœ“ should have S3 configuration defined
      âœ“ should have security configuration for PCI DSS
    Direct S3 Upload Implementation
      â—‹ skipped should store s3Key with correct path structure
      â—‹ skipped should not use Parse.File for new uploads
    Backward Compatibility with Parse.File
      â—‹ skipped should still read old images with imageFile (Parse.File)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/quotes-duplicate.test.js:24:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/quotes-duplicate.test.js:24:11)

PASS tests/integration/api/quotes-duplicate.test.js
  Quote Duplication API Integration Tests
    POST /api/quotes/:id/duplicate
      âœ“ should duplicate quote without suffix and add "- OpciÃ³n 2" to eventType (91 ms)
      âœ“ should increment option number when duplicating quote with "OpciÃ³n 2" (66 ms)
      âœ“ should increment option number correctly for any number (e.g., OpciÃ³n 5 â†’ OpciÃ³n 6) (64 ms)
      âœ“ should generate new sequential folio following QTE-YYYY-#### format (62 ms)
      âœ“ should copy complete serviceItems structure with all days and subconcepts (67 ms)
      âœ“ should set status to "requested" regardless of original status (65 ms)
      âœ“ should set validUntil to 30 days from now (60 ms)
      âœ“ should allow superadmin to duplicate quote (58 ms)
      âœ“ should return 403 for employee role (insufficient permissions) (36 ms)
      âœ“ should return 401 without authentication (16 ms)
      âœ“ should return 404 when trying to duplicate non-existent quote (39 ms)
      âœ“ should return 404 when trying to duplicate logically deleted quote (exists=false) (48 ms)
      âœ“ should preserve rate reference in duplicated quote (57 ms)
      âœ“ should copy contact information correctly (59 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/api/vehicles-with-rates.test.js:27:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/api/vehicles-with-rates.test.js:27:11)

PASS tests/integration/api/vehicles-with-rates.test.js
  Vehicles with Rates Integration
    POST /api/vehicles - Create vehicle with rate
      âœ“ should create vehicle with valid rate assignment (128 ms)
      âœ“ should create vehicle without rate (optional field) (49 ms)
      âœ“ should reject invalid rate ID (40 ms)
      âœ“ should reject inactive rate assignment (46 ms)
    GET /api/vehicles - Query vehicles with rate information
      âœ“ should include rate information in vehicle list (59 ms)
      âœ“ should handle vehicles without rates in list (73 ms)
    PUT /api/vehicles/:id - Update vehicle rate
      âœ“ should update vehicle with new rate (52 ms)
      âœ“ should remove rate from vehicle (set to null) (55 ms)
      âœ“ should reject update with invalid rate (43 ms)
      âœ“ should reject update with inactive rate (46 ms)
    GET /api/vehicles/:id - Get single vehicle with rate
      âœ“ should return vehicle with rate details (36 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

PASS tests/integration/cloud/beforeSave-amexinguser.test.js
  AmexingUser beforeSave Hook - Email Uniqueness
    Duplicate Email Prevention on Create
      âœ“ should reject creating user with duplicate email (142 ms)
      âœ“ should reject duplicate email with case-insensitive matching (73 ms)
      âœ“ should allow creating user with unique email (63 ms)
    Duplicate Email Prevention on Update
      âœ“ should reject updating user email to existing email (127 ms)
      âœ“ should allow user to update without changing email (70 ms)
      âœ“ should allow user to update to new unique email (71 ms)
    Soft-Deleted Users
      âœ“ should reject email from soft-deleted user (exists: false) (66 ms)
    Edge Cases
      âœ“ should handle email with whitespace trimming (68 ms)
      âœ“ should allow empty email if validation permits (test hook resilience) (60 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.log
    âœ“ getOAuthProviders returned 0 providers

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:32:15)

  console.log
    âœ“ Gracefully returned empty providers during initialization

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:49:17)

  console.log
    âœ“ Multiple concurrent calls handled successfully

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:75:15)

  console.log
    âš  No providers configured - skipping validation

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:91:17)

  console.log
    âœ“ Response time: 6ms

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:130:15)

  console.log
    âœ“ Handled 5 rapid sequential calls

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:151:15)

  console.log
    âœ“ Handled 10 concurrent calls

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:173:15)

  console.log
    âœ“ Consistent results across concurrent calls

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:190:15)

  console.log
    âœ“ Accessible without authentication

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:202:15)

  console.log
    âš  No providers configured

      at Object.<anonymous> (tests/integration/cloud/oauth-providers-startup.test.js:217:17)

PASS tests/integration/cloud/oauth-providers-startup.test.js
  OAuth Providers Startup Integration
    getOAuthProviders Cloud Function
      âœ“ should return OAuth providers list without errors (15 ms)
      âœ“ should handle calls gracefully regardless of initialization state (6 ms)
      âœ“ should not throw errors during concurrent calls (15 ms)
    OAuth Provider Response Structure
      âœ“ should return valid structure when available (4 ms)
      âœ“ should handle missing provider configurations gracefully (4 ms)
      âœ“ should provide meaningful response structure (4 ms)
    Performance and Response Time
      âœ“ should respond quickly (6 ms)
      âœ“ should handle rapid sequential calls (514 ms)
    Concurrent Access
      âœ“ should handle multiple simultaneous calls (51 ms)
      âœ“ should return consistent results for concurrent calls (9 ms)
    Integration with Authentication Flow
      âœ“ should be callable without authentication (3 ms)
      âœ“ should support login page provider discovery (3 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/auth/csrf-logout-login-flow.test.js:23:13)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/auth/csrf-logout-login-flow.test.js:23:13)

  console.log
    Performance Test: 10 requests completed in 73ms (avg: 7.30ms per request)

      at Object.<anonymous> (tests/integration/auth/csrf-logout-login-flow.test.js:668:15)

PASS tests/integration/auth/csrf-logout-login-flow.test.js
  CSRF Token Flow - Logout/Login Integration
    Session Regeneration After Logout
      âœ“ should regenerate session and CSRF token after logout (250 ms)
    Immediate Re-login After Logout
      âœ“ should allow immediate login after logout without CSRF errors (219 ms)
    Multiple Consecutive Logout/Login Cycles
      âœ“ should handle multiple consecutive logout/login cycles (642 ms)
    CSRF Secret Initialization
      âœ“ should initialize CSRF secret on first visit to login page (16 ms)
    Race Condition Prevention
      âœ“ should prevent race condition errors during rapid logout/login (225 ms)
    Error Recovery
      âœ“ should recover gracefully if CSRF secret is missing (15 ms)
      âœ“ should handle session regeneration errors gracefully (25 ms)
    Login Endpoint CSRF Exclusion
      âœ“ should allow login with old/invalid CSRF token (login excluded from CSRF) (24 ms)
      âœ“ should allow login without CSRF token entirely (14 ms)
    CSRF Token Persistence
      âœ“ should maintain valid CSRF token across page navigations (32 ms)
    Concurrent Sessions
      âœ“ should handle concurrent logout/login from multiple sessions (274 ms)
    Performance Under Load
      âœ“ should handle rapid successive login page requests efficiently (78 ms)
    Other Auth Endpoints CSRF Protection
      âœ“ should require CSRF token for /auth/register endpoint (8 ms)
      âœ“ should document that /auth/login is the ONLY auth endpoint excluded from CSRF (5 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/auth/csrf-session-recovery.test.js:26:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/auth/csrf-session-recovery.test.js:26:9)

PASS tests/integration/auth/csrf-session-recovery.test.js
  CSRF Session Recovery Integration Tests
    Session Health Check Endpoint
      âœ“ should report healthy session with CSRF protection (42 ms)
      âœ“ should report unhealthy session without CSRF secret (32 ms)
      âœ“ should include session health headers (19 ms)
    CSRF Auto-Recovery
      âœ“ should auto-generate CSRF secret on GET requests when missing (13 ms)
      âœ“ should set recovery header when CSRF secret is auto-generated (14 ms)
    Session Expiration Detection
      âœ“ should detect sessions near expiration (11 ms)
      âœ“ should include expiration warning header for expiring sessions (18 ms)
    Cloud Function Retry Logic
      âœ“ should successfully call getOAuthProviders with retry (6 ms)
      âœ“ should provide helpful error for cloud function failures (7 ms)
    Session Recovery During Logout/Login Cycle
      âœ“ should maintain session health through logout/login cycle (20 ms)
      âœ“ should allow immediate re-login after logout (19 ms)
    Error Response Format
      âœ“ should provide recovery instructions in CSRF errors (4 ms)
    Production Edge Cases
      âœ“ should handle multiple rapid requests without errors (19 ms)
      âœ“ should handle session switching between users (22 ms)
      âœ“ should maintain CSRF protection across page refreshes (24 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/auth/login-logout-cycle.test.js:17:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/auth/login-logout-cycle.test.js:17:11)

PASS tests/integration/auth/login-logout-cycle.test.js
  Login-Logout Cycle Integration
    Single Login-Logout Cycle
      âœ“ should complete full cycle: GET login -> POST login -> POST logout -> GET login (264 ms)
      âœ“ should maintain CSRF token across login-logout cycle (214 ms)
      âœ“ should not allow access to protected routes after logout (209 ms)
    Session Cookie Handling
      âœ“ should maintain session cookie throughout login-logout cycle (216 ms)
    CSRF Protection After Logout
      âœ“ should allow form submissions with CSRF after logout (406 ms)
      âœ“ should reject requests with old CSRF token after logout (400 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/auth/multiple-login-logout.test.js:17:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/auth/multiple-login-logout.test.js:17:11)

  console.log
    âœ“ Completed 5 login-logout cycles successfully

      at Object.<anonymous> (tests/integration/auth/multiple-login-logout.test.js:95:15)

  console.log
    âœ“ Completed login-logout cycles for 3 different roles

      at Object.<anonymous> (tests/integration/auth/multiple-login-logout.test.js:207:15)

  console.log
    âœ“ Completed 5 cycles in 1031ms

      at Object.<anonymous> (tests/integration/auth/multiple-login-logout.test.js:236:15)

PASS tests/integration/auth/multiple-login-logout.test.js (10.157 s)
  Multiple Login-Logout Cycles Integration
    5 Consecutive Login-Logout Cycles
      âœ“ should complete 5 login-logout cycles without CSRF errors (1096 ms)
      âœ“ should maintain different CSRF tokens across cycles (638 ms)
      âœ“ should handle rapid login-logout cycles (2371 ms)
    Cross-User Multiple Cycles
      âœ“ should handle cycles with different user roles (641 ms)
    Performance and Timing
      âœ“ should complete 5 cycles within reasonable time (1031 ms)
    Edge Cases
      âœ“ should handle logout without prior dashboard access (637 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/rbac/permission-system.integration.test.js:31:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/rbac/permission-system.integration.test.js:31:11)

PASS tests/integration/rbac/permission-system.integration.test.js
  RBAC Permission System Integration
    Role-Based Access Control
      SuperAdmin Access
        âœ“ should allow superadmin to access all endpoints (29 ms)
        âœ“ should allow superadmin to manage all roles (36 ms)
      Admin Access
        âœ“ should allow admin to access user management (27 ms)
        âœ“ should prevent admin from accessing superadmin-only endpoints (21 ms)
      Department Manager Access
        âœ“ should allow department manager to view department data (18 ms)
        âœ“ should prevent department manager from global user management (26 ms)
      Employee Access
        âœ“ should allow employee to access basic endpoints (18 ms)
        âœ“ should prevent employee from accessing admin endpoints (24 ms)
      Guest Access
        âœ“ should restrict guest access to public endpoints only (26 ms)
        âœ“ should allow guest to access public endpoints (18 ms)
    Permission-Based Access Control
      User Permissions
        âœ“ should validate user.list permission for viewing users (26 ms)
        âœ“ should validate user.create permission for creating users (26 ms)
      Role Permissions
        âœ“ should validate role.manage permission for role management (34 ms)
        âœ“ should prevent unauthorized role modifications (25 ms)
    Role Hierarchy Validation
      âœ“ should respect role level hierarchy (27 ms)
      âœ“ should prevent lower roles from managing higher roles (24 ms)
    Unauthorized Access
      âœ“ should reject requests without token (5 ms)
      âœ“ should reject requests with invalid token (5 ms)
      âœ“ should reject requests with malformed authorization header (3 ms)
    Permission Validation
      âœ“ should validate permissions exist in database (5 ms)
      âœ“ should validate all roles have proper permissions (4 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/security/csrf-persistence.test.js:18:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/security/csrf-persistence.test.js:18:11)

PASS tests/integration/security/csrf-persistence.test.js (7.072 s)
  CSRF Persistence Integration
    CSRF Token Generation
      âœ“ should generate CSRF token on first GET request (38 ms)
      âœ“ should generate CSRF token on each login page load (24 ms)
    CSRF Token Validation
      âœ“ should accept valid CSRF token on POST request (214 ms)
      âœ“ should reject POST request without CSRF token (204 ms)
      âœ“ should reject POST request with invalid CSRF token (205 ms)
    CSRF Persistence After Logout
      âœ“ should regenerate CSRF token after logout (217 ms)
      âœ“ should not accept old CSRF token after logout (406 ms)
      âœ“ should allow new login with new CSRF token after logout (407 ms)
    CSRF Session Continuity
      âœ“ should provide valid CSRF tokens across same session requests (17 ms)
      âœ“ should reject CSRF token from different session (216 ms)
    CSRF Error Messages
      âœ“ should provide clear error messages for CSRF failures (402 ms)
      âœ“ should suggest refresh action in CSRF error responses (203 ms)
    CSRF Race Condition Prevention
      âœ“ should handle rapid logout-login without TOKEN_INVALID errors (410 ms)
      âœ“ should handle multiple rapid GET requests without losing CSRF secret (74 ms)
      âœ“ should allow login immediately after session regeneration (418 ms)
    CSRF MongoDB Persistence
      âœ“ should persist CSRF secret to session store within 200ms (439 ms)
      âœ“ should not lose CSRF secret across multiple page loads (529 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","isDevelopment":false,"isProduction":false,"isProductionLocal":false,"level":"info","message":"SecurityMiddleware initialized"}

      65 |
      66 |     // Log environment detection for debugging
    > 67 |     winston.info('SecurityMiddleware initialized', {
         |             ^
      68 |       environment: process.env.NODE_ENV,
      69 |       isDevelopment: this.isDevelopment,
      70 |       isProduction: this.isProduction,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at new SecurityMiddleware (src/infrastructure/security/securityMiddleware.js:67:13)
      at Object.<anonymous> (src/infrastructure/security/securityMiddleware.js:823:18)
      at Object.<anonymous> (src/index.js:35:28)
      at Object.<anonymous> (tests/integration/security/security.integration.test.js:18:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"environment":"test","secure":false,"sameSite":"lax","domain":"undefined","httpOnly":true,"level":"info","message":"Session cookie configuration"}

      437 |
      438 |     // Log cookie configuration for debugging
    > 439 |     winston.info('Session cookie configuration', {
          |             ^
      440 |       environment: process.env.NODE_ENV,
      441 |       secure: cookieSecure,
      442 |       sameSite: cookieSameSite,

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.log (node_modules/winston/lib/winston/logger.js:253:14)
      at DerivedLogger.<computed> [as info] (node_modules/winston/lib/winston/create-logger.js:95:19)
      at Object.exports.<computed> [as info] (node_modules/winston/lib/winston.js:110:68)
      at SecurityMiddleware.getSessionConfig (src/infrastructure/security/securityMiddleware.js:439:13)
      at Object.<anonymous> (src/index.js:143:28)
      at Object.<anonymous> (tests/integration/security/security.integration.test.js:18:11)

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"message":"Attempted NoSQL injection from IP ::ffff:127.0.0.1 on field undefined","level":"warn"}

      247 |       replaceWith: '_',
      248 |       onSanitize: ({ req, _key }) => {
    > 249 |         winston.warn(`Attempted NoSQL injection from IP ${req.ip} on field ${_key}`);
          |                 ^
      250 |       },
      251 |     });
      252 |   }

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.<computed> [as warn] (node_modules/winston/lib/winston/create-logger.js:81:14)
      at Object.exports.<computed> [as warn] (node_modules/winston/lib/winston.js:110:68)
      at Object.onSanitize (src/infrastructure/security/securityMiddleware.js:249:17)
      at node_modules/express-mongo-sanitize/index.js:115:19
          at Array.forEach (<anonymous>)
      at node_modules/express-mongo-sanitize/index.js:110:44
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:807:7
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"message":"CORS blocked request from origin: http://localhost:1337","level":"warn"}

      305 |           callback(null, true);
      306 |         } else {
    > 307 |           winston.warn(`CORS blocked request from origin: ${origin}`);
          |                   ^
      308 |           callback(new Error('Not allowed by CORS'));
      309 |         }
      310 |       },

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.<computed> [as warn] (node_modules/winston/lib/winston/create-logger.js:81:14)
      at Object.exports.<computed> [as warn] (node_modules/winston/lib/winston.js:110:68)
      at origin (src/infrastructure/security/securityMiddleware.js:307:19)
      at node_modules/cors/lib/index.js:219:13
      at optionsCallback (node_modules/cors/lib/index.js:199:9)
      at corsMiddleware (node_modules/cors/lib/index.js:204:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at internalNext (node_modules/helmet/index.cjs:537:6)
      at xXssProtectionMiddleware (node_modules/helmet/index.cjs:315:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xPoweredByMiddleware (node_modules/helmet/index.cjs:308:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xFrameOptionsMiddleware (node_modules/helmet/index.cjs:285:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xDownloadOptionsMiddleware (node_modules/helmet/index.cjs:265:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xDnsPrefetchControlMiddleware (node_modules/helmet/index.cjs:258:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xContentTypeOptionsMiddleware (node_modules/helmet/index.cjs:250:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at strictTransportSecurityMiddleware (node_modules/helmet/index.cjs:243:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at referrerPolicyMiddleware (node_modules/helmet/index.cjs:211:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at originAgentClusterMiddleware (node_modules/helmet/index.cjs:186:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at crossOriginResourcePolicyMiddleware (node_modules/helmet/index.cjs:179:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at crossOriginOpenerPolicyMiddleware (node_modules/helmet/index.cjs:163:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at contentSecurityPolicyMiddleware (node_modules/helmet/index.cjs:128:4)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at helmetMiddleware (node_modules/helmet/index.cjs:539:6)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/infrastructure/security/securityMiddleware.js:577:16
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/infrastructure/security/securityMiddleware.js:560:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/application/middleware/sessionRecoveryMiddleware.js:189:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/application/middleware/sessionRecoveryMiddleware.js:143:7

  console.error
    [winston] Attempt to write logs with no transports, which can increase memory usage: {"message":"CORS blocked request from origin: http://malicious-site.com","level":"warn"}

      305 |           callback(null, true);
      306 |         } else {
    > 307 |           winston.warn(`CORS blocked request from origin: ${origin}`);
          |                   ^
      308 |           callback(new Error('Not allowed by CORS'));
      309 |         }
      310 |       },

      at DerivedLogger._transform (node_modules/winston/lib/winston/logger.js:303:15)
      at DerivedLogger.Object.<anonymous>.Transform._read (node_modules/readable-stream/lib/_stream_transform.js:166:10)
      at DerivedLogger.Object.<anonymous>.Transform._write (node_modules/readable-stream/lib/_stream_transform.js:155:83)
      at doWrite (node_modules/readable-stream/lib/_stream_writable.js:390:139)
      at writeOrBuffer (node_modules/readable-stream/lib/_stream_writable.js:381:5)
      at DerivedLogger.Object.<anonymous>.Writable.write (node_modules/readable-stream/lib/_stream_writable.js:302:11)
      at DerivedLogger.<computed> [as warn] (node_modules/winston/lib/winston/create-logger.js:81:14)
      at Object.exports.<computed> [as warn] (node_modules/winston/lib/winston.js:110:68)
      at origin (src/infrastructure/security/securityMiddleware.js:307:19)
      at node_modules/cors/lib/index.js:219:13
      at optionsCallback (node_modules/cors/lib/index.js:199:9)
      at corsMiddleware (node_modules/cors/lib/index.js:204:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at internalNext (node_modules/helmet/index.cjs:537:6)
      at xXssProtectionMiddleware (node_modules/helmet/index.cjs:315:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xPoweredByMiddleware (node_modules/helmet/index.cjs:308:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xFrameOptionsMiddleware (node_modules/helmet/index.cjs:285:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xDownloadOptionsMiddleware (node_modules/helmet/index.cjs:265:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xDnsPrefetchControlMiddleware (node_modules/helmet/index.cjs:258:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at xContentTypeOptionsMiddleware (node_modules/helmet/index.cjs:250:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at strictTransportSecurityMiddleware (node_modules/helmet/index.cjs:243:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at referrerPolicyMiddleware (node_modules/helmet/index.cjs:211:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at originAgentClusterMiddleware (node_modules/helmet/index.cjs:186:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at crossOriginResourcePolicyMiddleware (node_modules/helmet/index.cjs:179:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at crossOriginOpenerPolicyMiddleware (node_modules/helmet/index.cjs:163:3)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at contentSecurityPolicyMiddleware (node_modules/helmet/index.cjs:128:4)
      at internalNext (node_modules/helmet/index.cjs:535:6)
      at helmetMiddleware (node_modules/helmet/index.cjs:539:6)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/infrastructure/security/securityMiddleware.js:577:16
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/infrastructure/security/securityMiddleware.js:560:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/application/middleware/sessionRecoveryMiddleware.js:189:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at router.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at src/application/middleware/sessionRecoveryMiddleware.js:143:7

PASS tests/integration/security/security.integration.test.js
  Security Integration Tests
    CSRF Protection
      âœ“ should generate CSRF token on GET request (20 ms)
      âœ“ should reject POST without CSRF token (10 ms)
      âœ“ should accept POST with valid CSRF token (17 ms)
    Session Security
      âœ“ should set secure session cookies in production mode (5 ms)
      âœ“ should have proper session timeout configuration (19 ms)
    Security Headers
      âœ“ should include proper security headers (10 ms)
      âœ“ should include API security headers (9 ms)
    Rate Limiting
      âœ“ should apply general rate limiting (44 ms)
      âœ“ should include rate limit headers (8 ms)
    Input Sanitization
      âœ“ should sanitize MongoDB injection attempts (5 ms)
      âœ“ should sanitize XSS attempts (4 ms)
    CORS Configuration
      âœ“ should handle CORS preflight requests (7 ms)
      âœ“ should reject requests from unauthorized origins (8 ms)
    Content Type Validation
      âœ“ should validate content types for POST requests (4 ms)
      âœ“ should accept valid content types (3 ms)
    Crypto Functions
      âœ“ should use secure encryption functions (1 ms)
      âœ“ should generate secure random secrets
    Audit Logging
      âœ“ should log security events when enabled (10 ms)
    Request Tracking
      âœ“ should include request ID in responses (8 ms)
    Error Handling Security
      âœ“ should not expose stack traces in production (8 ms)
      âœ“ should handle security middleware errors gracefully (4 ms)

  console.log
    âœ… Loaded .env.test with real AWS credentials (local testing)

      at Object.<anonymous> (tests/jest.env.js:20:11)

  console.log
    âœ… AWS credentials configured: AKIAS2ND***

      at Object.<anonymous> (tests/jest.env.js:64:11)

  console.log
    Test environment configured

      at Object.<anonymous> (tests/jest.env.js:67:9)

  console.log
    Database URI: mongodb://127.0.0.1:27018/

      at Object.<anonymous> (tests/jest.env.js:68:9)

  console.log
    Parse Server URL: http://localhost:1339/parse

      at Object.<anonymous> (tests/jest.env.js:69:9)

FAIL tests/integration/settings/settingsService.test.js
  â— SettingsService Integration Tests â€º getSetting â€º should retrieve a setting by key

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getSetting â€º should return null for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getSetting â€º should use cache on second retrieval

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getValue â€º should retrieve typed value

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getValue â€º should return default value for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getNumericValue â€º should retrieve numeric value

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getNumericValue â€º should return default for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º exists â€º should return true for existing active setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º exists â€º should return false for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º cache management â€º should clear cache

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º cache management â€º should invalidate specific cache entry

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º cache management â€º should update cache timeout

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)


  â— Test suite failed to run

    Cannot use the Master Key, it has not been provided.

      35 |     const query = new Parse.Query('Setting');
      36 |     query.equalTo('key', 'testPaymentSurchargePercentage');
    > 37 |     const setting = await query.first({ useMasterKey: true });
         |                                 ^
      38 |     if (setting) {
      39 |       setting.set('exists', false);
      40 |       await setting.save(null, { useMasterKey: true });

      at Object.request (node_modules/parse/lib/node/RESTController.js:251:15)
      at Object.find (node_modules/parse/lib/node/ParseQuery.js:1911:27)
      at ParseQuery.first (node_modules/parse/lib/node/ParseQuery.js:741:23)
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:37:33)

Summary of all failing tests
FAIL tests/integration/settings/settingsService.test.js
  â— SettingsService Integration Tests â€º getSetting â€º should retrieve a setting by key

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getSetting â€º should return null for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getSetting â€º should use cache on second retrieval

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getValue â€º should retrieve typed value

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getValue â€º should return default value for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getNumericValue â€º should retrieve numeric value

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º getNumericValue â€º should return default for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º exists â€º should return true for existing active setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º exists â€º should return false for non-existent setting

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º cache management â€º should clear cache

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º cache management â€º should invalidate specific cache entry

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)

  â— SettingsService Integration Tests â€º cache management â€º should update cache timeout

    thrown: Object {
      "errors": Array [
        "Key is required",
        "Value is required",
        "Invalid valueType. Must be one of: string, number, boolean, json",
      ],
      "valid": false,
    }

      11 |   let settingsService;
      12 |
    > 13 |   beforeAll(async () => {
         |   ^
      14 |     // Initialize Parse for test environment
      15 |     Parse.serverURL = process.env.PARSE_SERVER_URL || 'http://localhost:1339/parse';
      16 |

      at tests/integration/settings/settingsService.test.js:13:3
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:10:1)


  â— Test suite failed to run

    Cannot use the Master Key, it has not been provided.

      35 |     const query = new Parse.Query('Setting');
      36 |     query.equalTo('key', 'testPaymentSurchargePercentage');
    > 37 |     const setting = await query.first({ useMasterKey: true });
         |                                 ^
      38 |     if (setting) {
      39 |       setting.set('exists', false);
      40 |       await setting.save(null, { useMasterKey: true });

      at Object.request (node_modules/parse/lib/node/RESTController.js:251:15)
      at Object.find (node_modules/parse/lib/node/ParseQuery.js:1911:27)
      at ParseQuery.first (node_modules/parse/lib/node/ParseQuery.js:741:23)
      at Object.<anonymous> (tests/integration/settings/settingsService.test.js:37:33)


Test Suites: 1 failed, 54 passed, 55 total
Tests:       12 failed, 15 skipped, 1023 passed, 1050 total
Snapshots:   0 total
Time:        81.868 s
Ran all test suites matching /tests\/integration|tests\/unit/i.

ğŸ§¹ Starting Global Test Teardown...

   ğŸŒ Stopping HTTP Server...
   âœ… HTTP Server stopped
   ğŸ”Œ Stopping Parse Server...
   âš ï¸  Parse Server stop warning: Cannot read properties of undefined (reading 'close')
   ğŸ“¦ Stopping MongoDB Memory Server...
   âœ… MongoDB Memory Server stopped

âœ… Global Test Teardown Complete

============================================================
Teardown Summary:
  - MongoDB stopped: Yes
  - Parse disconnected: No
  - Warnings: 1
    âš ï¸  Parse stop: Cannot read properties of undefined (reading 'close')
============================================================

error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
